"use strict";
//Reference Fudge, getting code completion ready and creating a shortcut f to write FudgeCode more comfortably
var Tutorials_FUDGEPhysics_Lesson1;
//Reference Fudge, getting code completion ready and creating a shortcut f to write FudgeCode more comfortably
(function (Tutorials_FUDGEPhysics_Lesson1) {
    var f = FudgeCore;
    //Goal: Learn how to create and use physics based events (Collision/Trigger) to control nodes in the app.
    //Fudge Basic Variables
    window.addEventListener("load", init);
    const app = document.querySelector("canvas"); // The html element where the scene is drawn to
    let viewPort; // The scene visualization
    let hierarchy; // You're object scene tree
    //Physical Objects
    let bodies = new Array(); // Array of all physical objects in the scene to have a quick reference
    let playerBody; // Transform of a body that interacts with physics but can be moved by normal FudgeTransform
    //Setting Variables
    let force = 0.5; //The amount of movement with each keypress
    let playerDefaultMat = new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0, 0, 1, 1)));
    let playerTriggeredMat = new f.Material("CubeTriggered", f.ShaderFlat, new f.CoatColored(new f.Color(0.9, 0.1, 0.1, 1)));
    //Function to initialize the Fudge Scene with a camera, light, viewport and PHYSCIAL Objects
    function init(_event) {
        hierarchy = new f.Node("Scene"); //create the root Node where every object is parented to. Should never be changed
        //#region PHYSICS
        //PHYSICS - Step 2: Create some physical Nodes to play with 
        //Creating a physically static ground plane for our physics playground. A simple scaled cube but with physics type set to static
        bodies[0] = createCompleteNode("Ground", new f.Material("Ground", f.ShaderFlat, new f.CoatColored(new f.Color(0.2, 0.2, 0.2, 1))), new f.MeshCube(), 0, f.BODY_TYPE.STATIC);
        bodies[0].mtxLocal.scale(new f.Vector3(14, 0.3, 14)); //Scale the body with it's standard ComponentTransform
        bodies[0].mtxLocal.rotateX(4, true); //Give it a slight rotation so the physical objects are sliding, always from left when it's after a scaling
        hierarchy.appendChild(bodies[0]); //Add the node to the scene by adding it to the scene-root
        //Step 1 - Creating a the player cube - to interact to trigger, COLLIDERS and TRIGGERS 
        bodies[1] = createCompleteNode("Player", playerDefaultMat, new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC);
        playerBody = bodies[1]; //Reference this node specifically so we can access it for input more easily
        playerBody.mtxLocal.translate(new f.Vector3(0, 1, 0));
        hierarchy.appendChild(bodies[1]);
        playerBody.getComponent(f.ComponentRigidbody).effectRotation = new f.Vector3(0, 0, 0); //make rotation fixed the player does not rotate
        playerBody.getComponent(f.ComponentRigidbody).friction = 1;
        //Step 2 - Create bodies - one used as a button when it collides it will an action will happen - one as a trigger, when it's overlapping it will trigger an action
        //The Collision Event is happening on a collision so a normal body can receive it
        //A use case for a collision event is for example when the player is hitting the ground to play a sound
        bodies[2] = createCompleteNode("Collider_Button", new f.Material("Collider_Button", f.ShaderFlat, new f.CoatColored(new f.Color(0.3, 0.3, 0.4, 1))), new f.MeshCube(), 1, f.BODY_TYPE.STATIC);
        bodies[2].mtxLocal.translate(new f.Vector3(-3, 1, 0));
        hierarchy.appendChild(bodies[2]);
        //The Trigger Event is happening when bodies overlap, so we need a special body that does not collide but overlap
        //So it must be flagged as trigger, and normally in games it's invisble, so it has no mesh component or is fully transparent.
        //A use case is something like spawning enemies when a player enters a room.
        bodies[3] = createCompleteNode("Trigger_Button", new f.Material("Trigger_Button", f.ShaderFlat, new f.CoatColored(new f.Color(0.5, 0.3, 0.2, 0.3))), new f.MeshCube(), 1, f.BODY_TYPE.STATIC, f.COLLISION_GROUP.DEFAULT);
        bodies[3].mtxLocal.translate(new f.Vector3(3, 1, 0));
        bodies[3].getComponent(f.ComponentRigidbody).isTrigger = true;
        hierarchy.appendChild(bodies[3]);
        //Trigger when player is falling of the plane
        bodies[4] = createCompleteNode("Trigger_Reset", new f.Material("Trigger_Reset", f.ShaderFlat, new f.CoatColored(new f.Color(0.5, 0.3, 0.2, 0.3))), new f.MeshCube(), 1, f.BODY_TYPE.STATIC, f.COLLISION_GROUP.DEFAULT);
        bodies[4].getComponent(f.ComponentRigidbody).isTrigger = true;
        bodies[4].removeComponent(bodies[4].getComponent(f.ComponentMesh)); //removing the mesh to have invisible trigger - standard practice
        bodies[4].mtxLocal.translate(new f.Vector3(0, -4, 0));
        bodies[4].mtxLocal.scale(new f.Vector3(30, 1, 30)); //Make it big enough so the player should hit it
        hierarchy.appendChild(bodies[4]);
        //Step 3 - After creating our Physic Event Bodies, we tell them to listen to the specific event happening
        //These events are happening on the physic component not on the node. So be sure to add them to the component not to the node
        //A body can receive a enter/exit event, and it's only happening once. If a body is staying on a collision or in a trigger it needs to be handled manually
        bodies[2].getComponent(f.ComponentRigidbody).addEventListener("ColliderEnteredCollision" /* COLLISION_ENTER */, hndCollisionEventEnter);
        bodies[2].getComponent(f.ComponentRigidbody).addEventListener("ColliderLeftCollision" /* COLLISION_EXIT */, hndCollisionEventExit);
        /*Hint: The Collision Event is only happening if the object is hitting it physically,
          So KINEMATIC vs. STATIC does not receive a collision Event. Only DYNAMIC vs. DYNAMIC/STATIC/KINEMATIC, neither do two Kinematic hit each other nor do Kinematic/Static.
          If you really need a kinematic hitting a static object and still have a action, use trigger, or make the object not static but dynamic but unmoving by having a ridiculously high weight.
          Thats why we use a dynamic player cube instead of a kinematic like we did in Lesson 1.
        */
        //Same as for collision a trigger is also listening on a event type in form of f.EVENT_PHYSICS and a function that will be called
        bodies[3].getComponent(f.ComponentRigidbody).addEventListener("TriggerEnteredCollision" /* TRIGGER_ENTER */, hndTriggerEventEnter);
        bodies[3].getComponent(f.ComponentRigidbody).addEventListener("TriggerLeftCollision" /* TRIGGER_EXIT */, hndTriggerEventExit);
        //Setting up our reset
        bodies[4].getComponent(f.ComponentRigidbody).addEventListener("TriggerEnteredCollision" /* TRIGGER_ENTER */, hndResetTrigger);
        //#endregion PHYSICS
        //Standard Fudge Scene Initialization - Creating a directional light, a camera and initialize the viewport
        let cmpLight = new f.ComponentLight(new f.LightDirectional(f.Color.CSS("WHITE")));
        cmpLight.mtxPivot.lookAt(new f.Vector3(0.5, -1, -0.8)); //Set light direction
        hierarchy.addComponent(cmpLight);
        let cmpCamera = new f.ComponentCamera();
        cmpCamera.clrBackground = f.Color.CSS("GREY");
        cmpCamera.mtxPivot.translate(new f.Vector3(2, 3.5, 17)); //Move camera far back so the whole scene is visible
        cmpCamera.mtxPivot.lookAt(f.Vector3.ZERO()); //Set the camera matrix so that it looks at the center of the scene
        viewPort = new f.Viewport(); //Creating a viewport that is rendered onto the html canvas element
        viewPort.initialize("Viewport", hierarchy, cmpCamera, app); //initialize the viewport with the root node, camera and canvas
        document.addEventListener("keypress", hndKey); //Adding a listener for keypress handling
        //PHYSICS - Start using physics by telling the physics the scene root object. Physics will recalculate every transform and initialize
        f.Physics.adjustTransforms(hierarchy);
        //Important start the game loop after starting physics, so physics can use the current transform before it's first iteration
        f.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update); //Tell the game loop to call the update function on each frame
        f.Loop.start(); //Stard the game loop
    }
    //Function to animate/update the Fudge scene, commonly known as gameloop
    function update() {
        f.Physics.simulate(); //PHYSICS - Simulate physical changes each frame, parameter to set time between frames
        viewPort.draw(); // Draw the current Fudge Scene to the canvas
    }
    // Function to quickly create a node with multiple needed FudgeComponents, including a physics component
    function createCompleteNode(_name, _material, _mesh, _mass, _physicsType, _group = f.COLLISION_GROUP.DEFAULT, _colType = f.COLLIDER_TYPE.CUBE) {
        let node = new f.Node(_name); //Creating the node
        let cmpMesh = new f.ComponentMesh(_mesh); //Creating a mesh for the node
        let cmpMaterial = new f.ComponentMaterial(_material); //Creating a material for the node
        let cmpTransform = new f.ComponentTransform(); //Transform holding position/rotation/scaling of the node
        let cmpRigidbody = new f.ComponentRigidbody(_mass, _physicsType, _colType, _group); //<-- adding the group when using triggers, since a trigger should not collide with anything else
        node.addComponent(cmpMesh);
        node.addComponent(cmpMaterial);
        node.addComponent(cmpTransform);
        node.addComponent(cmpRigidbody); // <-- best practice to add physics component last
        return node; //return the full created node
    }
    // Event Function handling keyboard input - similar to Lesson 1 but a little different, since it's pushing the player by force
    function hndKey(_event) {
        let horizontal = 0; //left/right
        let vertical = 0; //front/back
        let height = 0; //upwards/downwards
        //Check keyboard input from Event
        if (_event.code == f.KEYBOARD_CODE.A) {
            horizontal -= force;
        }
        if (_event.code == f.KEYBOARD_CODE.D) {
            horizontal += force;
        }
        if (_event.code == f.KEYBOARD_CODE.W) {
            vertical -= force;
        }
        if (_event.code == f.KEYBOARD_CODE.S) {
            vertical += force;
        }
        if (_event.code == f.KEYBOARD_CODE.SPACE) { //Jump
            height += force * 10;
        }
        playerBody.getComponent(f.ComponentRigidbody).applyLinearImpulse(new f.Vector3(horizontal, height, vertical));
    }
    //Step 4 - Receiving and handling the events
    //Event function handling collision - A EVENT_PHYSICS is receiving a f.EventPhysics with infos about the event
    function hndCollisionEventEnter(_event) {
        //_event. keeps a plethora of informations about the event the most interesting are things like 
        /*
          _event.cmpRigidbody -> to identify the body involved in the event, with node.name you get the actual name of the node involved
          _event.normalImpulse -> intensity of the collision good to play a sound that is only as heavy as the collision
          _event.collisionPoint -> the point in the world where the collision is happening to maybe spawn things like particles
          _event.collisionNormal -> the direction the collision is happening often used to correctly rotate spawned things on the colliding surface
        */
        if (_event.cmpRigidbody.node.name == "Player") { //Our Event is happening with the body NODE called "Player"
            f.Debug.log("Player hit me - Collider");
            //We let this collider act like a bumper through this event. We take the event normal and shoot the player away from the bumper on the contact point.
            playerBody.getComponent(f.ComponentRigidbody).applyForceAtPoint(new f.Vector3(_event.collisionNormal.x * 500, _event.collisionNormal.y * 500, _event.collisionNormal.z * 500), _event.collisionPoint);
        }
    }
    function hndCollisionEventExit(_event) {
        if (_event.cmpRigidbody.node.name == "Player") {
            f.Debug.log("Player left me - Collider");
        }
    }
    //Event function handling triggering
    function hndTriggerEventEnter(_event) {
        if (_event.cmpRigidbody.node.name == "Player") {
            f.Debug.log("Player entered me - Trigger");
            playerBody.getComponent(f.ComponentMaterial).material = playerTriggeredMat;
        }
    }
    function hndTriggerEventExit(_event) {
        if (_event.cmpRigidbody.node.name == "Player") {
            f.Debug.log("Player left me - Trigger");
            playerBody.getComponent(f.ComponentMaterial).material = playerDefaultMat;
        }
    }
    //Since the player could fall of we will reset him back with a trigger when he falls down from the plane
    function hndResetTrigger(_event) {
        if (_event.cmpRigidbody.node.name == "Player") {
            playerBody.getComponent(f.ComponentRigidbody).setPosition(new f.Vector3(0, 3, 0)); //Since it's a physics body we have to set position through physics not transform
        }
    }
})(Tutorials_FUDGEPhysics_Lesson1 || (Tutorials_FUDGEPhysics_Lesson1 = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhHQUE4RztBQUU5RyxJQUFVLDhCQUE4QixDQTJNdkM7QUE3TUQsOEdBQThHO0FBRTlHLFdBQVUsOEJBQThCO0lBQ3BDLElBQU8sQ0FBQyxHQUFHLFNBQVMsQ0FBQztJQUVyQix5R0FBeUc7SUFFekcsdUJBQXVCO0lBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQywrQ0FBK0M7SUFDaEgsSUFBSSxRQUFvQixDQUFDLENBQUMsMEJBQTBCO0lBQ3BELElBQUksU0FBaUIsQ0FBQyxDQUFDLDJCQUEyQjtJQUdsRCxrQkFBa0I7SUFDbEIsSUFBSSxNQUFNLEdBQWEsSUFBSSxLQUFLLEVBQUUsQ0FBQyxDQUFDLHVFQUF1RTtJQUMzRyxJQUFJLFVBQWtCLENBQUMsQ0FBQyw0RkFBNEY7SUFHcEgsbUJBQW1CO0lBQ25CLElBQUksS0FBSyxHQUFXLEdBQUcsQ0FBQyxDQUFDLDJDQUEyQztJQUNwRSxJQUFJLGdCQUFnQixHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNwSCxJQUFJLGtCQUFrQixHQUFlLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxF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IGFuZCBjcmVhdGluZyBhIHNob3J0Y3V0IGYgdG8gd3JpdGUgRnVkZ2VDb2RlIG1vcmUgY29tZm9ydGFibHlcblxubmFtZXNwYWNlIFR1dG9yaWFsc19GVURHRVBoeXNpY3NfTGVzc29uMSB7XG4gICAgaW1wb3J0IGYgPSBGdWRnZUNvcmU7XG5cbiAgICAvL0dvYWw6IExlYXJuIGhvdyB0byBjcmVhdGUgYW5kIHVzZSBwaHlzaWNzIGJhc2VkIGV2ZW50cyAoQ29sbGlzaW9uL1RyaWdnZXIpIHRvIGNvbnRyb2wgbm9kZXMgaW4gdGhlIGFwcC5cblxuICAgIC8vRnVkZ2UgQmFzaWMgVmFyaWFibGVzXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGluaXQpO1xuICAgIGNvbnN0IGFwcDogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiY2FudmFzXCIpOyAvLyBUaGUgaHRtbCBlbGVtZW50IHdoZXJlIHRoZSBzY2VuZSBpcyBkcmF3biB0b1xuICAgIGxldCB2aWV3UG9ydDogZi5WaWV3cG9ydDsgLy8gVGhlIHNjZW5lIHZpc3VhbGl6YXRpb25cbiAgICBsZXQgaGllcmFyY2h5OiBmLk5vZGU7IC8vIFlvdSdyZSBvYmplY3Qgc2NlbmUgdHJlZVxuXG5cbiAgICAvL1BoeXNpY2FsIE9iamVjdHNcbiAgICBsZXQgYm9kaWVzOiBmLk5vZGVbXSA9IG5ldyBBcnJheSgpOyAvLyBBcnJheSBvZiBhbGwgcGh5c2ljYWwgb2JqZWN0cyBpbiB0aGUgc2NlbmUgdG8gaGF2ZSBhIHF1aWNrIHJlZmVyZW5jZVxuICAgIGxldCBwbGF5ZXJCb2R5OiBmLk5vZGU7IC8vIFRyYW5zZm9ybSBvZiBhIGJvZHkgdGhhdCBpbnRlcmFjdHMgd2l0aCBwaHlzaWNzIGJ1dCBjYW4gYmUgbW92ZWQgYnkgbm9ybWFsIEZ1ZGdlVHJhbnNmb3JtXG5cblxuICAgIC8vU2V0dGluZyBWYXJpYWJsZXNcbiAgICBsZXQgZm9yY2U6IG51bWJlciA9IDAuNTsgLy9UaGUgYW1vdW50IG9mIG1vdmVtZW50IHdpdGggZWFjaCBrZXlwcmVzc1xuICAgIGxldCBwbGF5ZXJEZWZhdWx0TWF0OiBmLk1hdGVyaWFsID0gbmV3IGYuTWF0ZXJpYWwoXCJDdWJlXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMCwgMCwgMSwgMSkpKTtcbiAgICBsZXQgcGxheWVyVHJpZ2dlcmVkTWF0OiBmLk1hdGVyaWFsID0gbmV3IGYuTWF0ZXJpYWwoXCJDdWJlVHJpZ2dlcmVkXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC45LCAwLjEsIDAuMSwgMSkpKTtcblxuICAgIC8vRnVuY3Rpb24gdG8gaW5pdGlhbGl6ZSB0aGUgRnVkZ2UgU2NlbmUgd2l0aCBhIGNhbWVyYSwgbGlnaHQsIHZpZXdwb3J0IGFuZCBQSFlTQ0lBTCBPYmplY3RzXG4gICAgZnVuY3Rpb24gaW5pdChfZXZlbnQ6IEV2ZW50KTogdm9pZCB7XG5cbiAgICAgICAgaGllcmFyY2h5ID0gbmV3IGYuTm9kZShcIlNjZW5lXCIpOyAvL2NyZWF0ZSB0aGUgcm9vdCBOb2RlIHdoZXJlIGV2ZXJ5IG9iamVjdCBpcyBwYXJlbnRlZCB0by4gU2hvdWxkIG5ldmVyIGJlIGNoYW5nZWRcblxuICAgICAgICAvLyNyZWdpb24gUEhZU0lDU1xuXG4gICAgICAgIC8vUEhZU0lDUyAtIFN0ZXAgMjogQ3JlYXRlIHNvbWUgcGh5c2ljYWwgTm9kZXMgdG8gcGxheSB3aXRoIFxuICAgICAgICAvL0NyZWF0aW5nIGEgcGh5c2ljYWxseSBzdGF0aWMgZ3JvdW5kIHBsYW5lIGZvciBvdXIgcGh5c2ljcyBwbGF5Z3JvdW5kLiBBIHNpbXBsZSBzY2FsZWQgY3ViZSBidXQgd2l0aCBwaHlzaWNzIHR5cGUgc2V0IHRvIHN0YXRpY1xuICAgICAgICBib2RpZXNbMF0gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJHcm91bmRcIiwgbmV3IGYuTWF0ZXJpYWwoXCJHcm91bmRcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjIsIDAuMiwgMC4yLCAxKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAwLCBmLkJPRFlfVFlQRS5TVEFUSUMpO1xuICAgICAgICBib2RpZXNbMF0ubXR4TG9jYWwuc2NhbGUobmV3IGYuVmVjdG9yMygxNCwgMC4zLCAxNCkpOyAvL1NjYWxlIHRoZSBib2R5IHdpdGggaXQncyBzdGFuZGFyZCBDb21wb25lbnRUcmFuc2Zvcm1cbiAgICAgICAgYm9kaWVzWzBdLm10eExvY2FsLnJvdGF0ZVgoNCwgdHJ1ZSk7IC8vR2l2ZSBpdCBhIHNsaWdodCByb3RhdGlvbiBzbyB0aGUgcGh5c2ljYWwgb2JqZWN0cyBhcmUgc2xpZGluZywgYWx3YXlzIGZyb20gbGVmdCB3aGVuIGl0J3MgYWZ0ZXIgYSBzY2FsaW5nXG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChib2RpZXNbMF0pOyAvL0FkZCB0aGUgbm9kZSB0byB0aGUgc2NlbmUgYnkgYWRkaW5nIGl0IHRvIHRoZSBzY2VuZS1yb290XG5cbiAgICAgICAgLy9TdGVwIDEgLSBDcmVhdGluZyBhIHRoZSBwbGF5ZXIgY3ViZSAtIHRvIGludGVyYWN0IHRvIHRyaWdnZXIsIENPTExJREVSUyBhbmQgVFJJR0dFUlMgXG4gICAgICAgIGJvZGllc1sxXSA9IGNyZWF0ZUNvbXBsZXRlTm9kZShcIlBsYXllclwiLCBwbGF5ZXJEZWZhdWx0TWF0LCBuZXcgZi5NZXNoQ3ViZSgpLCAxLCBmLkJPRFlfVFlQRS5EWU5BTUlDKTtcbiAgICAgICAgcGxheWVyQm9keSA9IGJvZGllc1sxXTsgLy9SZWZlcmVuY2UgdGhpcyBub2RlIHNwZWNpZmljYWxseSBzbyB3ZSBjYW4gYWNjZXNzIGl0IGZvciBpbnB1dCBtb3JlIGVhc2lseVxuICAgICAgICBwbGF5ZXJCb2R5Lm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDAsIDEsIDApKTtcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGJvZGllc1sxXSk7XG4gICAgICAgIHBsYXllckJvZHkuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KS5lZmZlY3RSb3RhdGlvbiA9IG5ldyBmLlZlY3RvcjMoMCwgMCwgMCk7IC8vbWFrZSByb3RhdGlvbiBmaXhlZCB0aGUgcGxheWVyIGRvZXMgbm90IHJvdGF0ZVxuICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuZnJpY3Rpb24gPSAxO1xuXG4gICAgICAgIC8vU3RlcCAyIC0gQ3JlYXRlIGJvZGllcyAtIG9uZSB1c2VkIGFzIGEgYnV0dG9uIHdoZW4gaXQgY29sbGlkZXMgaXQgd2lsbCBhbiBhY3Rpb24gd2lsbCBoYXBwZW4gLSBvbmUgYXMgYSB0cmlnZ2VyLCB3aGVuIGl0J3Mgb3ZlcmxhcHBpbmcgaXQgd2lsbCB0cmlnZ2VyIGFuIGFjdGlvblxuICAgICAgICAvL1RoZSBDb2xsaXNpb24gRXZlbnQgaXMgaGFwcGVuaW5nIG9uIGEgY29sbGlzaW9uIHNvIGEgbm9ybWFsIGJvZHkgY2FuIHJlY2VpdmUgaXRcbiAgICAgICAgLy9BIHVzZSBjYXNlIGZvciBhIGNvbGxpc2lvbiBldmVudCBpcyBmb3IgZXhhbXBsZSB3aGVuIHRoZSBwbGF5ZXIgaXMgaGl0dGluZyB0aGUgZ3JvdW5kIHRvIHBsYXkgYSBzb3VuZFxuICAgICAgICBib2RpZXNbMl0gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJDb2xsaWRlcl9CdXR0b25cIiwgbmV3IGYuTWF0ZXJpYWwoXCJDb2xsaWRlcl9CdXR0b25cIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjMsIDAuMywgMC40LCAxKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAxLCBmLkJPRFlfVFlQRS5TVEFUSUMpO1xuICAgICAgICBib2RpZXNbMl0ubXR4TG9jYWwudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoLTMsIDEsIDApKTtcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGJvZGllc1syXSk7XG5cbiAgICAgICAgLy9UaGUgVHJpZ2dlciBFdmVudCBpcyBoYXBwZW5pbmcgd2hlbiBib2RpZXMgb3ZlcmxhcCwgc28gd2UgbmVlZCBhIHNwZWNpYWwgYm9keSB0aGF0IGRvZXMgbm90IGNvbGxpZGUgYnV0IG92ZXJsYXBcbiAgICAgICAgLy9TbyBpdCBtdXN0IGJlIGZsYWdnZWQgYXMgdHJpZ2dlciwgYW5kIG5vcm1hbGx5IGluIGdhbWVzIGl0J3MgaW52aXNibGUsIHNvIGl0IGhhcyBubyBtZXNoIGNvbXBvbmVudCBvciBpcyBmdWxseSB0cmFuc3BhcmVudC5cbiAgICAgICAgLy9BIHVzZSBjYXNlIGlzIHNvbWV0aGluZyBsaWtlIHNwYXduaW5nIGVuZW1pZXMgd2hlbiBhIHBsYXllciBlbnRlcnMgYSByb29tLlxuICAgICAgICBib2RpZXNbM10gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJUcmlnZ2VyX0J1dHRvblwiLCBuZXcgZi5NYXRlcmlhbChcIlRyaWdnZXJfQnV0dG9uXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC41LCAwLjMsIDAuMiwgMC4zKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAxLCBmLkJPRFlfVFlQRS5TVEFUSUMsIGYuQ09MTElTSU9OX0dST1VQLkRFRkFVTFQpO1xuICAgICAgICBib2RpZXNbM10ubXR4TG9jYWwudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoMywgMSwgMCkpO1xuICAgICAgICBib2RpZXNbM10uZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KS5pc1RyaWdnZXIgPSB0cnVlO1xuICAgICAgICBoaWVyYXJjaHkuYXBwZW5kQ2hpbGQoYm9kaWVzWzNdKTtcblxuICAgICAgICAvL1RyaWdnZXIgd2hlbiBwbGF5ZXIgaXMgZmFsbGluZyBvZiB0aGUgcGxhbmVcbiAgICAgICAgYm9kaWVzWzRdID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiVHJpZ2dlcl9SZXNldFwiLCBuZXcgZi5NYXRlcmlhbChcIlRyaWdnZXJfUmVzZXRcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjUsIDAuMywgMC4yLCAwLjMpKSksIG5ldyBmLk1lc2hDdWJlKCksIDEsIGYuQk9EWV9UWVBFLlNUQVRJQywgZi5DT0xMSVNJT05fR1JPVVAuREVGQVVMVCk7XG4gICAgICAgIGJvZGllc1s0XS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmlzVHJpZ2dlciA9IHRydWU7XG4gICAgICAgIGJvZGllc1s0XS5yZW1vdmVDb21wb25lbnQoYm9kaWVzWzRdLmdldENvbXBvbmVudChmLkNvbXBvbmVudE1lc2gpKTsgLy9yZW1vdmluZyB0aGUgbWVzaCB0byBoYXZlIGludmlzaWJsZSB0cmlnZ2VyIC0gc3RhbmRhcmQgcHJhY3RpY2VcbiAgICAgICAgYm9kaWVzWzRdLm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDAsIC00LCAwKSk7XG4gICAgICAgIGJvZGllc1s0XS5tdHhMb2NhbC5zY2FsZShuZXcgZi5WZWN0b3IzKDMwLCAxLCAzMCkpOyAvL01ha2UgaXQgYmlnIGVub3VnaCBzbyB0aGUgcGxheWVyIHNob3VsZCBoaXQgaXRcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGJvZGllc1s0XSk7XG5cbiAgICAgICAgLy9TdGVwIDMgLSBBZnRlciBjcmVhdGluZyBvdXIgUGh5c2ljIEV2ZW50IEJvZGllcywgd2UgdGVsbCB0aGVtIHRvIGxpc3RlbiB0byB0aGUgc3BlY2lmaWMgZXZlbnQgaGFwcGVuaW5nXG4gICAgICAgIC8vVGhlc2UgZXZlbnRzIGFyZSBoYXBwZW5pbmcgb24gdGhlIHBoeXNpYyBjb21wb25lbnQgbm90IG9uIHRoZSBub2RlLiBTbyBiZSBzdXJlIHRvIGFkZCB0aGVtIHRvIHRoZSBjb21wb25lbnQgbm90IHRvIHRoZSBub2RlXG4gICAgICAgIC8vQSBib2R5IGNhbiByZWNlaXZlIGEgZW50ZXIvZXhpdCBldmVudCwgYW5kIGl0J3Mgb25seSBoYXBwZW5pbmcgb25jZS4gSWYgYSBib2R5IGlzIHN0YXlpbmcgb24gYSBjb2xsaXNpb24gb3IgaW4gYSB0cmlnZ2VyIGl0IG5lZWRzIHRvIGJlIGhhbmRsZWQgbWFudWFsbHlcbiAgICAgICAgYm9kaWVzWzJdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuQ09MTElTSU9OX0VOVEVSLCBobmRDb2xsaXNpb25FdmVudEVudGVyKTtcbiAgICAgICAgYm9kaWVzWzJdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuQ09MTElTSU9OX0VYSVQsIGhuZENvbGxpc2lvbkV2ZW50RXhpdCk7XG4gICAgICAgIC8qSGludDogVGhlIENvbGxpc2lvbiBFdmVudCBpcyBvbmx5IGhhcHBlbmluZyBpZiB0aGUgb2JqZWN0IGlzIGhpdHRpbmcgaXQgcGh5c2ljYWxseSwgXG4gICAgICAgICAgU28gS0lORU1BVElDIHZzLiBTVEFUSUMgZG9lcyBub3QgcmVjZWl2ZSBhIGNvbGxpc2lvbiBFdmVudC4gT25seSBEWU5BTUlDIHZzLiBEWU5BTUlDL1NUQVRJQy9LSU5FTUFUSUMsIG5laXRoZXIgZG8gdHdvIEtpbmVtYXRpYyBoaXQgZWFjaCBvdGhlciBub3IgZG8gS2luZW1hdGljL1N0YXRpYy5cbiAgICAgICAgICBJZiB5b3UgcmVhbGx5IG5lZWQgYSBraW5lbWF0aWMgaGl0dGluZyBhIHN0YXRpYyBvYmplY3QgYW5kIHN0aWxsIGhhdmUgYSBhY3Rpb24sIHVzZSB0cmlnZ2VyLCBvciBtYWtlIHRoZSBvYmplY3Qgbm90IHN0YXRpYyBidXQgZHluYW1pYyBidXQgdW5tb3ZpbmcgYnkgaGF2aW5nIGEgcmlkaWN1bG91c2x5IGhpZ2ggd2VpZ2h0LlxuICAgICAgICAgIFRoYXRzIHdoeSB3ZSB1c2UgYSBkeW5hbWljIHBsYXllciBjdWJlIGluc3RlYWQgb2YgYSBraW5lbWF0aWMgbGlrZSB3ZSBkaWQgaW4gTGVzc29uIDEuXG4gICAgICAgICovXG5cbiAgICAgICAgLy9TYW1lIGFzIGZvciBjb2xsaXNpb24gYSB0cmlnZ2VyIGlzIGFsc28gbGlzdGVuaW5nIG9uIGEgZXZlbnQgdHlwZSBpbiBmb3JtIG9mIGYuRVZFTlRfUEhZU0lDUyBhbmQgYSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkXG4gICAgICAgIGJvZGllc1szXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVF9QSFlTSUNTLlRSSUdHRVJfRU5URVIsIGhuZFRyaWdnZXJFdmVudEVudGVyKTtcbiAgICAgICAgYm9kaWVzWzNdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5UX1BIWVNJQ1MuVFJJR0dFUl9FWElULCBobmRUcmlnZ2VyRXZlbnRFeGl0KTtcblxuICAgICAgICAvL1NldHRpbmcgdXAgb3VyIHJlc2V0XG4gICAgICAgIGJvZGllc1s0XS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVF9QSFlTSUNTLlRSSUdHRVJfRU5URVIsIGhuZFJlc2V0VHJpZ2dlcik7XG4gICAgICAgIC8vI2VuZHJlZ2lvbiBQSFlTSUNTXG5cblxuICAgICAgICAvL1N0YW5kYXJkIEZ1ZGdlIFNjZW5lIEluaXRpYWxpemF0aW9uIC0gQ3JlYXRpbmcgYSBkaXJlY3Rpb25hbCBsaWdodCwgYSBjYW1lcmEgYW5kIGluaXRpYWxpemUgdGhlIHZpZXdwb3J0XG4gICAgICAgIGxldCBjbXBMaWdodDogZi5Db21wb25lbnRMaWdodCA9IG5ldyBmLkNvbXBvbmVudExpZ2h0KG5ldyBmLkxpZ2h0RGlyZWN0aW9uYWwoZi5Db2xvci5DU1MoXCJXSElURVwiKSkpO1xuICAgICAgICBjbXBMaWdodC5tdHhQaXZvdC5sb29rQXQobmV3IGYuVmVjdG9yMygwLjUsIC0xLCAtMC44KSk7IC8vU2V0IGxpZ2h0IGRpcmVjdGlvblxuICAgICAgICBoaWVyYXJjaHkuYWRkQ29tcG9uZW50KGNtcExpZ2h0KTtcblxuICAgICAgICBsZXQgY21wQ2FtZXJhOiBmLkNvbXBvbmVudENhbWVyYSA9IG5ldyBmLkNvbXBvbmVudENhbWVyYSgpO1xuICAgICAgICBjbXBDYW1lcmEuY2xyQmFja2dyb3VuZCA9IGYuQ29sb3IuQ1NTKFwiR1JFWVwiKTtcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDIsIDMuNSwgMTcpKTsgLy9Nb3ZlIGNhbWVyYSBmYXIgYmFjayBzbyB0aGUgd2hvbGUgc2NlbmUgaXMgdmlzaWJsZVxuICAgICAgICBjbXBDYW1lcmEubXR4UGl2b3QubG9va0F0KGYuVmVjdG9yMy5aRVJPKCkpOyAvL1NldCB0aGUgY2FtZXJhIG1hdHJpeCBzbyB0aGF0IGl0IGxvb2tzIGF0IHRoZSBjZW50ZXIgb2YgdGhlIHNjZW5lXG5cbiAgICAgICAgdmlld1BvcnQgPSBuZXcgZi5WaWV3cG9ydCgpOyAvL0NyZWF0aW5nIGEgdmlld3BvcnQgdGhhdCBpcyByZW5kZXJlZCBvbnRvIHRoZSBodG1sIGNhbnZhcyBlbGVtZW50XG4gICAgICAgIHZpZXdQb3J0LmluaXRpYWxpemUoXCJWaWV3cG9ydFwiLCBoaWVyYXJjaHksIGNtcENhbWVyYSwgYXBwKTsgLy9pbml0aWFsaXplIHRoZSB2aWV3cG9ydCB3aXRoIHRoZSByb290IG5vZGUsIGNhbWVyYSBhbmQgY2FudmFzXG5cbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXByZXNzXCIsIGhuZEtleSk7IC8vQWRkaW5nIGEgbGlzdGVuZXIgZm9yIGtleXByZXNzIGhhbmRsaW5nXG5cbiAgICAgICAgLy9QSFlTSUNTIC0gU3RhcnQgdXNpbmcgcGh5c2ljcyBieSB0ZWxsaW5nIHRoZSBwaHlzaWNzIHRoZSBzY2VuZSByb290IG9iamVjdC4gUGh5c2ljcyB3aWxsIHJlY2FsY3VsYXRlIGV2ZXJ5IHRyYW5zZm9ybSBhbmQgaW5pdGlhbGl6ZVxuICAgICAgICBmLlBoeXNpY3MuYWRqdXN0VHJhbnNmb3JtcyhoaWVyYXJjaHkpO1xuXG4gICAgICAgIC8vSW1wb3J0YW50IHN0YXJ0IHRoZSBnYW1lIGxvb3AgYWZ0ZXIgc3RhcnRpbmcgcGh5c2ljcywgc28gcGh5c2ljcyBjYW4gdXNlIHRoZSBjdXJyZW50IHRyYW5zZm9ybSBiZWZvcmUgaXQncyBmaXJzdCBpdGVyYXRpb25cbiAgICAgICAgZi5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVC5MT09QX0ZSQU1FLCB1cGRhdGUpOyAvL1RlbGwgdGhlIGdhbWUgbG9vcCB0byBjYWxsIHRoZSB1cGRhdGUgZnVuY3Rpb24gb24gZWFjaCBmcmFtZVxuICAgICAgICBmLkxvb3Auc3RhcnQoKTsgLy9TdGFyZCB0aGUgZ2FtZSBsb29wXG4gICAgfVxuXG4gICAgLy9GdW5jdGlvbiB0byBhbmltYXRlL3VwZGF0ZSB0aGUgRnVkZ2Ugc2NlbmUsIGNvbW1vbmx5IGtub3duIGFzIGdhbWVsb29wXG4gICAgZnVuY3Rpb24gdXBkYXRlKCk6IHZvaWQge1xuICAgICAgICBmLlBoeXNpY3Muc2ltdWxhdGUoKTsgLy9QSFlTSUNTIC0gU2ltdWxhdGUgcGh5c2ljYWwgY2hhbmdlcyBlYWNoIGZyYW1lLCBwYXJhbWV0ZXIgdG8gc2V0IHRpbWUgYmV0d2VlbiBmcmFtZXNcbiAgICAgICAgdmlld1BvcnQuZHJhdygpOyAvLyBEcmF3IHRoZSBjdXJyZW50IEZ1ZGdlIFNjZW5lIHRvIHRoZSBjYW52YXNcbiAgICB9XG5cbiAgICAvLyBGdW5jdGlvbiB0byBxdWlja2x5IGNyZWF0ZSBhIG5vZGUgd2l0aCBtdWx0aXBsZSBuZWVkZWQgRnVkZ2VDb21wb25lbnRzLCBpbmNsdWRpbmcgYSBwaHlzaWNzIGNvbXBvbmVudFxuICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbXBsZXRlTm9kZShfbmFtZTogc3RyaW5nLCBfbWF0ZXJpYWw6IGYuTWF0ZXJpYWwsIF9tZXNoOiBmLk1lc2gsIF9tYXNzOiBudW1iZXIsIF9waHlzaWNzVHlwZTogZi5CT0RZX1RZUEUsIF9ncm91cDogZi5DT0xMSVNJT05fR1JPVVAgPSBmLkNPTExJU0lPTl9HUk9VUC5ERUZBVUxULCBfY29sVHlwZTogZi5DT0xMSURFUl9UWVBFID0gZi5DT0xMSURFUl9UWVBFLkNVQkUpOiBmLk5vZGUge1xuICAgICAgICBsZXQgbm9kZTogZi5Ob2RlID0gbmV3IGYuTm9kZShfbmFtZSk7IC8vQ3JlYXRpbmcgdGhlIG5vZGVcbiAgICAgICAgbGV0IGNtcE1lc2g6IGYuQ29tcG9uZW50TWVzaCA9IG5ldyBmLkNvbXBvbmVudE1lc2goX21lc2gpOyAvL0NyZWF0aW5nIGEgbWVzaCBmb3IgdGhlIG5vZGVcbiAgICAgICAgbGV0IGNtcE1hdGVyaWFsOiBmLkNvbXBvbmVudE1hdGVyaWFsID0gbmV3IGYuQ29tcG9uZW50TWF0ZXJpYWwoX21hdGVyaWFsKTsgLy9DcmVhdGluZyBhIG1hdGVyaWFsIGZvciB0aGUgbm9kZVxuICAgICAgICBsZXQgY21wVHJhbnNmb3JtOiBmLkNvbXBvbmVudFRyYW5zZm9ybSA9IG5ldyBmLkNvbXBvbmVudFRyYW5zZm9ybSgpOyAgLy9UcmFuc2Zvcm0gaG9sZGluZyBwb3NpdGlvbi9yb3RhdGlvbi9zY2FsaW5nIG9mIHRoZSBub2RlXG5cbiAgICAgICAgbGV0IGNtcFJpZ2lkYm9keTogZi5Db21wb25lbnRSaWdpZGJvZHkgPSBuZXcgZi5Db21wb25lbnRSaWdpZGJvZHkoX21hc3MsIF9waHlzaWNzVHlwZSwgX2NvbFR5cGUsIF9ncm91cCk7IC8vPC0tIGFkZGluZyB0aGUgZ3JvdXAgd2hlbiB1c2luZyB0cmlnZ2Vycywgc2luY2UgYSB0cmlnZ2VyIHNob3VsZCBub3QgY29sbGlkZSB3aXRoIGFueXRoaW5nIGVsc2VcblxuICAgICAgICBub2RlLmFkZENvbXBvbmVudChjbXBNZXNoKTtcbiAgICAgICAgbm9kZS5hZGRDb21wb25lbnQoY21wTWF0ZXJpYWwpO1xuICAgICAgICBub2RlLmFkZENvbXBvbmVudChjbXBUcmFuc2Zvcm0pO1xuICAgICAgICBub2RlLmFkZENvbXBvbmVudChjbXBSaWdpZGJvZHkpOyAvLyA8LS0gYmVzdCBwcmFjdGljZSB0byBhZGQgcGh5c2ljcyBjb21wb25lbnQgbGFzdFxuICAgICAgICByZXR1cm4gbm9kZTsgLy9yZXR1cm4gdGhlIGZ1bGwgY3JlYXRlZCBub2RlXG4gICAgfVxuXG4gICAgLy8gRXZlbnQgRnVuY3Rpb24gaGFuZGxpbmcga2V5Ym9hcmQgaW5wdXQgLSBzaW1pbGFyIHRvIExlc3NvbiAxIGJ1dCBhIGxpdHRsZSBkaWZmZXJlbnQsIHNpbmNlIGl0J3MgcHVzaGluZyB0aGUgcGxheWVyIGJ5IGZvcmNlXG4gICAgZnVuY3Rpb24gaG5kS2V5KF9ldmVudDogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuICAgICAgICBsZXQgaG9yaXpvbnRhbDogbnVtYmVyID0gMDsgIC8vbGVmdC9yaWdodFxuICAgICAgICBsZXQgdmVydGljYWw6IG51bWJlciA9IDA7IC8vZnJvbnQvYmFja1xuICAgICAgICBsZXQgaGVpZ2h0OiBudW1iZXIgPSAwOyAvL3Vwd2FyZHMvZG93bndhcmRzXG5cbiAgICAgICAgLy9DaGVjayBrZXlib2FyZCBpbnB1dCBmcm9tIEV2ZW50XG4gICAgICAgIGlmIChfZXZlbnQuY29kZSA9PSBmLktFWUJPQVJEX0NPREUuQSkge1xuICAgICAgICAgICAgaG9yaXpvbnRhbCAtPSBmb3JjZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX2V2ZW50LmNvZGUgPT0gZi5LRVlCT0FSRF9DT0RFLkQpIHtcbiAgICAgICAgICAgIGhvcml6b250YWwgKz0gZm9yY2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9ldmVudC5jb2RlID09IGYuS0VZQk9BUkRfQ09ERS5XKSB7XG4gICAgICAgICAgICB2ZXJ0aWNhbCAtPSBmb3JjZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoX2V2ZW50LmNvZGUgPT0gZi5LRVlCT0FSRF9DT0RFLlMpIHtcbiAgICAgICAgICAgIHZlcnRpY2FsICs9IGZvcmNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfZXZlbnQuY29kZSA9PSBmLktFWUJPQVJEX0NPREUuU1BBQ0UpIHsgLy9KdW1wXG4gICAgICAgICAgICBoZWlnaHQgKz0gZm9yY2UgKiAxMDtcbiAgICAgICAgfVxuICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuYXBwbHlMaW5lYXJJbXB1bHNlKG5ldyBmLlZlY3RvcjMoaG9yaXpvbnRhbCwgaGVpZ2h0LCB2ZXJ0aWNhbCkpO1xuICAgIH1cblxuXG4gICAgLy9TdGVwIDQgLSBSZWNlaXZpbmcgYW5kIGhhbmRsaW5nIHRoZSBldmVudHNcbiAgICAvL0V2ZW50IGZ1bmN0aW9uIGhhbmRsaW5nIGNvbGxpc2lvbiAtIEEgRVZFTlRfUEhZU0lDUyBpcyByZWNlaXZpbmcgYSBmLkV2ZW50UGh5c2ljcyB3aXRoIGluZm9zIGFib3V0IHRoZSBldmVudFxuICAgIGZ1bmN0aW9uIGhuZENvbGxpc2lvbkV2ZW50RW50ZXIoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICAvL19ldmVudC4ga2VlcHMgYSBwbGV0aG9yYSBvZiBpbmZvcm1hdGlvbnMgYWJvdXQgdGhlIGV2ZW50IHRoZSBtb3N0IGludGVyZXN0aW5nIGFyZSB0aGluZ3MgbGlrZSBcbiAgICAgICAgLyogXG4gICAgICAgICAgX2V2ZW50LmNtcFJpZ2lkYm9keSAtPiB0byBpZGVudGlmeSB0aGUgYm9keSBpbnZvbHZlZCBpbiB0aGUgZXZlbnQsIHdpdGggbm9kZS5uYW1lIHlvdSBnZXQgdGhlIGFjdHVhbCBuYW1lIG9mIHRoZSBub2RlIGludm9sdmVkIFxuICAgICAgICAgIF9ldmVudC5ub3JtYWxJbXB1bHNlIC0+IGludGVuc2l0eSBvZiB0aGUgY29sbGlzaW9uIGdvb2QgdG8gcGxheSBhIHNvdW5kIHRoYXQgaXMgb25seSBhcyBoZWF2eSBhcyB0aGUgY29sbGlzaW9uXG4gICAgICAgICAgX2V2ZW50LmNvbGxpc2lvblBvaW50IC0+IHRoZSBwb2ludCBpbiB0aGUgd29ybGQgd2hlcmUgdGhlIGNvbGxpc2lvbiBpcyBoYXBwZW5pbmcgdG8gbWF5YmUgc3Bhd24gdGhpbmdzIGxpa2UgcGFydGljbGVzXG4gICAgICAgICAgX2V2ZW50LmNvbGxpc2lvbk5vcm1hbCAtPiB0aGUgZGlyZWN0aW9uIHRoZSBjb2xsaXNpb24gaXMgaGFwcGVuaW5nIG9mdGVuIHVzZWQgdG8gY29ycmVjdGx5IHJvdGF0ZSBzcGF3bmVkIHRoaW5ncyBvbiB0aGUgY29sbGlkaW5nIHN1cmZhY2VcbiAgICAgICAgKi9cbiAgICAgICAgaWYgKF9ldmVudC5jbXBSaWdpZGJvZHkubm9kZS5uYW1lID09IFwiUGxheWVyXCIpIHsgLy9PdXIgRXZlbnQgaXMgaGFwcGVuaW5nIHdpdGggdGhlIGJvZHkgTk9ERSBjYWxsZWQgXCJQbGF5ZXJcIlxuICAgICAgICAgICAgZi5EZWJ1Zy5sb2coXCJQbGF5ZXIgaGl0IG1lIC0gQ29sbGlkZXJcIik7XG4gICAgICAgICAgICAvL1dlIGxldCB0aGlzIGNvbGxpZGVyIGFjdCBsaWtlIGEgYnVtcGVyIHRocm91Z2ggdGhpcyBldmVudC4gV2UgdGFrZSB0aGUgZXZlbnQgbm9ybWFsIGFuZCBzaG9vdCB0aGUgcGxheWVyIGF3YXkgZnJvbSB0aGUgYnVtcGVyIG9uIHRoZSBjb250YWN0IHBvaW50LlxuICAgICAgICAgICAgcGxheWVyQm9keS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLmFwcGx5Rm9yY2VBdFBvaW50KG5ldyBmLlZlY3RvcjMoX2V2ZW50LmNvbGxpc2lvbk5vcm1hbC54ICogNTAwLCBfZXZlbnQuY29sbGlzaW9uTm9ybWFsLnkgKiA1MDAsIF9ldmVudC5jb2xsaXNpb25Ob3JtYWwueiAqIDUwMCksIF9ldmVudC5jb2xsaXNpb25Qb2ludCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBobmRDb2xsaXNpb25FdmVudEV4aXQoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICBpZiAoX2V2ZW50LmNtcFJpZ2lkYm9keS5ub2RlLm5hbWUgPT0gXCJQbGF5ZXJcIikge1xuICAgICAgICAgICAgZi5EZWJ1Zy5sb2coXCJQbGF5ZXIgbGVmdCBtZSAtIENvbGxpZGVyXCIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9FdmVudCBmdW5jdGlvbiBoYW5kbGluZyB0cmlnZ2VyaW5nXG4gICAgZnVuY3Rpb24gaG5kVHJpZ2dlckV2ZW50RW50ZXIoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICBpZiAoX2V2ZW50LmNtcFJpZ2lkYm9keS5ub2RlLm5hbWUgPT0gXCJQbGF5ZXJcIikge1xuICAgICAgICAgICAgZi5EZWJ1Zy5sb2coXCJQbGF5ZXIgZW50ZXJlZCBtZSAtIFRyaWdnZXJcIik7XG4gICAgICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudE1hdGVyaWFsKS5tYXRlcmlhbCA9IHBsYXllclRyaWdnZXJlZE1hdDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhuZFRyaWdnZXJFdmVudEV4aXQoX2V2ZW50OiBmLkV2ZW50UGh5c2ljcyk6IHZvaWQge1xuICAgICAgICBpZiAoX2V2ZW50LmNtcFJpZ2lkYm9keS5ub2RlLm5hbWUgPT0gXCJQbGF5ZXJcIikge1xuICAgICAgICAgICAgZi5EZWJ1Zy5sb2coXCJQbGF5ZXIgbGVmdCBtZSAtIFRyaWdnZXJcIik7XG4gICAgICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudE1hdGVyaWFsKS5tYXRlcmlhbCA9IHBsYXllckRlZmF1bHRNYXQ7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1NpbmNlIHRoZSBwbGF5ZXIgY291bGQgZmFsbCBvZiB3ZSB3aWxsIHJlc2V0IGhpbSBiYWNrIHdpdGggYSB0cmlnZ2VyIHdoZW4gaGUgZmFsbHMgZG93biBmcm9tIHRoZSBwbGFuZVxuICAgIGZ1bmN0aW9uIGhuZFJlc2V0VHJpZ2dlcihfZXZlbnQ6IGYuRXZlbnRQaHlzaWNzKTogdm9pZCB7XG4gICAgICAgIGlmIChfZXZlbnQuY21wUmlnaWRib2R5Lm5vZGUubmFtZSA9PSBcIlBsYXllclwiKSB7XG4gICAgICAgICAgICBwbGF5ZXJCb2R5LmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSkuc2V0UG9zaXRpb24obmV3IGYuVmVjdG9yMygwLCAzLCAwKSk7IC8vU2luY2UgaXQncyBhIHBoeXNpY3MgYm9keSB3ZSBoYXZlIHRvIHNldCBwb3NpdGlvbiB0aHJvdWdoIHBoeXNpY3Mgbm90IHRyYW5zZm9ybVxuICAgICAgICB9XG4gICAgfVxuXG59Il19