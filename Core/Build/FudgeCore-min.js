"use strict";var FudgeCore,__decorate=this&&this.__decorate||function(e,t,i,r){var n,s=arguments.length,a=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;o>=0;o--)(n=e[o])&&(a=(s<3?n(a):s>3?n(t,i,a):n(t,i))||a);return s>3&&a&&Object.defineProperty(t,i,a),a};!function(e){class t{static registerNamespace(e){for(let i in t.namespaces)if(t.namespaces[i]==e)return;let i=t.findNamespaceIn(e,window);if(!i)for(let r in t.namespaces)if(i=t.findNamespaceIn(e,t.namespaces[r]),i){i=r+"."+i;break}if(!i)throw new Error("Namespace not found. Maybe parent namespace hasn't been registered before?");t.namespaces[i]=e}static serialize(e){let t={},i=this.getFullPath(e);if(!i)throw new Error(`Namespace of serializable object of type ${e.constructor.name} not found. Maybe the namespace hasn't been registered or the class not exported?`);return t[i]=e.serialize(),t}static deserialize(e){let i;try{for(let r in e)return i=t.reconstruct(r),i.deserialize(e[r]),i}catch(e){throw new Error("Deserialization failed: "+e)}return null}static prettify(e){return e}static stringify(e){let i=JSON.stringify(e,null,2);return t.prettify(i)}static parse(e){return JSON.parse(e)}static reconstruct(e){let i=e.substr(e.lastIndexOf(".")+1),r=t.getNamespace(e);if(!r)throw new Error(`Namespace of serializable object of type ${i} not found. Maybe the namespace hasn't been registered?`);return new r[i]}static getFullPath(e){let i=e.constructor.name;for(let r in t.namespaces){let n=t.namespaces[r][i];if(n&&e instanceof n)return r+"."+i}return null}static getNamespace(e){let i=e.substr(0,e.lastIndexOf("."));return t.namespaces[i]}static findNamespaceIn(e,t){for(let i in t)if(t[i]==e)return i;return null}}t.namespaces={"ƒ":e},e.Serializer=t}(FudgeCore||(FudgeCore={})),function(e){class t extends EventTarget{addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}dispatchEvent(e){return super.dispatchEvent(e)}}e.EventTargetƒ=t;class i extends t{constructor(){super()}static addEventListener(e,t){i.targetStatic.addEventListener(e,t)}static removeEventListener(e,t){i.targetStatic.removeEventListener(e,t)}static dispatchEvent(e){return i.targetStatic.dispatchEvent(e),!0}}i.targetStatic=new i,e.EventTargetStatic=i}(FudgeCore||(FudgeCore={})),function(e){class t extends e.EventTargetƒ{get type(){return this.constructor.name}getMutator(){let e={};for(let i in this){let r=this[i];r instanceof Function||(r instanceof Object&&!(r instanceof t)||(e[i]=this[i]))}Object.preventExtensions(e),this.reduceMutator(e);for(let i in e){let r=e[i];r instanceof t&&(e[i]=r.getMutator())}return e}getMutatorForAnimation(){return this.getMutator()}getMutatorForUserInterface(){return this.getMutator()}getMutatorAttributeTypes(e){let t={};for(let i in e){let r=null,n=e[i];null!=e[i]&&(r="object"==typeof n?this[i].constructor.name:e[i].constructor.name),t[i]=r}return t}updateMutator(e){for(let i in e){let r=e[i];r instanceof t?r=r.getMutator():e[i]=this[i]}}mutate(e){for(let i in e){let r=e[i],n=this[i];n instanceof t?n.mutate(r):this[i]=r}this.dispatchEvent(new Event("mutate"))}}e.Mutable=t}(FudgeCore||(FudgeCore={})),function(e){let t;!function(e){e[e.NORMAL=0]="NORMAL",e[e.REVERSE=1]="REVERSE",e[e.RASTERED=2]="RASTERED",e[e.RASTEREDREVERSE=3]="RASTEREDREVERSE"}(t||(t={}));class i extends e.Mutable{constructor(e,i={},r=60){super(),this.totalTime=0,this.labels={},this.stepsPerSecond=10,this.events={},this.framesPerSecond=60,this.eventsProcessed=new Map,this.animationStructuresProcessed=new Map,this.name=e,this.animationStructure=i,this.animationStructuresProcessed.set(t.NORMAL,i),this.framesPerSecond=r,this.calculateTotalTime()}getMutated(i,r,n){let s={};return s=n==e.ANIMATION_PLAYBACK.TIMEBASED_CONTINOUS?r>=0?this.traverseStructureForMutator(this.getProcessedAnimationStructure(t.NORMAL),i):this.traverseStructureForMutator(this.getProcessedAnimationStructure(t.REVERSE),i):r>=0?this.traverseStructureForMutator(this.getProcessedAnimationStructure(t.RASTERED),i):this.traverseStructureForMutator(this.getProcessedAnimationStructure(t.RASTEREDREVERSE),i),s}getEventsToFire(e,t,i,r){let n=[],s=Math.floor(e/this.totalTime),a=Math.floor(t/this.totalTime);for(e%=this.totalTime,t%=this.totalTime;s<=a;){let o=this.getCorrectEventList(r,i);s==a?n=n.concat(this.checkEventsBetween(o,e,t)):(n=n.concat(this.checkEventsBetween(o,e,this.totalTime)),e=0),s++}return n}setEvent(e,t){this.events[e]=t,this.eventsProcessed.clear()}removeEvent(e){delete this.events[e],this.eventsProcessed.clear()}get getLabels(){return new Enumerator(this.labels)}get fps(){return this.framesPerSecond}set fps(e){this.framesPerSecond=e,this.eventsProcessed.clear(),this.animationStructuresProcessed.clear()}calculateTotalTime(){this.totalTime=0,this.traverseStructureForTime(this.animationStructure)}serialize(){let e={idResource:this.idResource,name:this.name,labels:{},events:{},fps:this.framesPerSecond,sps:this.stepsPerSecond};for(let t in this.labels)e.labels[t]=this.labels[t];for(let t in this.events)e.events[t]=this.events[t];return e.animationStructure=this.traverseStructureForSerialisation(this.animationStructure),e}deserialize(e){this.idResource=e.idResource,this.name=e.name,this.framesPerSecond=e.fps,this.stepsPerSecond=e.sps,this.labels={};for(let t in e.labels)this.labels[t]=e.labels[t];this.events={};for(let t in e.events)this.events[t]=e.events[t];return this.eventsProcessed=new Map,this.animationStructure=this.traverseStructureForDeserialisation(e.animationStructure),this.animationStructuresProcessed=new Map,this.calculateTotalTime(),this}getMutator(){return this.serialize()}reduceMutator(e){delete e.totalTime}traverseStructureForSerialisation(t){let i={};for(let r in t)t[r]instanceof e.AnimationSequence?i[r]=t[r].serialize():i[r]=this.traverseStructureForSerialisation(t[r]);return i}traverseStructureForDeserialisation(t){let i={};for(let r in t)if(t[r].animationSequence){let n=new e.AnimationSequence;i[r]=n.deserialize(t[r])}else i[r]=this.traverseStructureForDeserialisation(t[r]);return i}getCorrectEventList(i,r){return r!=e.ANIMATION_PLAYBACK.FRAMEBASED?i>=0?this.getProcessedEventTrigger(t.NORMAL):this.getProcessedEventTrigger(t.REVERSE):i>=0?this.getProcessedEventTrigger(t.RASTERED):this.getProcessedEventTrigger(t.RASTEREDREVERSE)}traverseStructureForMutator(t,i){let r={};for(let n in t)t[n]instanceof e.AnimationSequence?r[n]=t[n].evaluate(i):r[n]=this.traverseStructureForMutator(t[n],i);return r}traverseStructureForTime(t){for(let i in t)if(t[i]instanceof e.AnimationSequence){let e=t[i];if(e.length>0){let t=e.getKey(e.length-1).Time;this.totalTime=t>this.totalTime?t:this.totalTime}}else this.traverseStructureForTime(t[i])}getProcessedAnimationStructure(e){if(!this.animationStructuresProcessed.has(e)){this.calculateTotalTime();let i={};switch(e){case t.NORMAL:i=this.animationStructure;break;case t.REVERSE:i=this.traverseStructureForNewStructure(this.animationStructure,this.calculateReverseSequence.bind(this));break;case t.RASTERED:i=this.traverseStructureForNewStructure(this.animationStructure,this.calculateRasteredSequence.bind(this));break;case t.RASTEREDREVERSE:i=this.traverseStructureForNewStructure(this.getProcessedAnimationStructure(t.REVERSE),this.calculateRasteredSequence.bind(this));break;default:return{}}this.animationStructuresProcessed.set(e,i)}return this.animationStructuresProcessed.get(e)}getProcessedEventTrigger(e){if(!this.eventsProcessed.has(e)){this.calculateTotalTime();let i={};switch(e){case t.NORMAL:i=this.events;break;case t.REVERSE:i=this.calculateReverseEventTriggers(this.events);break;case t.RASTERED:i=this.calculateRasteredEventTriggers(this.events);break;case t.RASTEREDREVERSE:i=this.calculateRasteredEventTriggers(this.getProcessedEventTrigger(t.REVERSE));break;default:return{}}this.eventsProcessed.set(e,i)}return this.eventsProcessed.get(e)}traverseStructureForNewStructure(t,i){let r={};for(let n in t)t[n]instanceof e.AnimationSequence?r[n]=i(t[n]):r[n]=this.traverseStructureForNewStructure(t[n],i);return r}calculateReverseSequence(t){let i=new e.AnimationSequence;for(let r=0;r<t.length;r++){let n=t.getKey(r),s=new e.AnimationKey(this.totalTime-n.Time,n.Value,n.SlopeOut,n.SlopeIn,n.Constant);i.addKey(s)}return i}calculateRasteredSequence(t){let i=new e.AnimationSequence,r=1e3/this.framesPerSecond;for(let n=0;n<this.totalTime;n+=r){let r=new e.AnimationKey(n,t.evaluate(n),0,0,!0);i.addKey(r)}return i}calculateReverseEventTriggers(e){let t={};for(let i in e)t[i]=this.totalTime-e[i];return t}calculateRasteredEventTriggers(e){let t={},i=1e3/this.framesPerSecond;for(let r in e)t[r]=e[r]-e[r]%i;return t}checkEventsBetween(e,t,i){let r=[];for(let n in e)t<=e[n]&&e[n]<i&&r.push(n);return r}}e.Animation=i}(FudgeCore||(FudgeCore={})),function(e){e.AnimationFunction=class{constructor(e,t=null){this.a=0,this.b=0,this.c=0,this.d=0,this.keyIn=e,this.keyOut=t,this.calculate()}evaluate(e){let t=(e-=this.keyIn.Time)*e,i=t*e;return this.a*i+this.b*t+this.c*e+this.d}set setKeyIn(e){this.keyIn=e,this.calculate()}set setKeyOut(e){this.keyOut=e,this.calculate()}calculate(){if(!this.keyIn)return void(this.d=this.c=this.b=this.a=0);if(!this.keyOut||this.keyIn.Constant)return this.d=this.keyIn.Value,void(this.c=this.b=this.a=0);let e=this.keyOut.Time-this.keyIn.Time;this.d=this.keyIn.Value,this.c=this.keyIn.SlopeOut,this.a=(-e*(this.keyIn.SlopeOut+this.keyOut.SlopeIn)-2*this.keyIn.Value+2*this.keyOut.Value)/-Math.pow(e,3),this.b=(this.keyOut.SlopeIn-this.keyIn.SlopeOut-3*this.a*Math.pow(e,2))/(2*e)}}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(t=0,i=0,r=0,n=0,s=!1){super(),this.constant=!1,this.slopeIn=0,this.slopeOut=0,this.time=t,this.value=i,this.slopeIn=r,this.slopeOut=n,this.constant=s,this.broken=this.slopeIn!=-this.slopeOut,this.functionOut=new e.AnimationFunction(this,null)}get Time(){return this.time}set Time(e){this.time=e,this.functionIn.calculate(),this.functionOut.calculate()}get Value(){return this.value}set Value(e){this.value=e,this.functionIn.calculate(),this.functionOut.calculate()}get Constant(){return this.constant}set Constant(e){this.constant=e,this.functionIn.calculate(),this.functionOut.calculate()}get SlopeIn(){return this.slopeIn}set SlopeIn(e){this.slopeIn=e,this.functionIn.calculate()}get SlopeOut(){return this.slopeOut}set SlopeOut(e){this.slopeOut=e,this.functionOut.calculate()}static compare(e,t){return e.time-t.time}serialize(){let e={};return e.time=this.time,e.value=this.value,e.slopeIn=this.slopeIn,e.slopeOut=this.slopeOut,e.constant=this.constant,e}deserialize(e){return this.time=e.time,this.value=e.value,this.slopeIn=e.slopeIn,this.slopeOut=e.slopeOut,this.constant=e.constant,this.broken=this.slopeIn!=-this.slopeOut,this}getMutator(){return this.serialize()}reduceMutator(e){}}e.AnimationKey=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(){super(...arguments),this.keys=[]}evaluate(e){if(0==this.keys.length)return 0;if(1==this.keys.length||this.keys[0].Time>=e)return this.keys[0].Value;for(let t=0;t<this.keys.length-1;t++)if(this.keys[t].Time<=e&&this.keys[t+1].Time>e)return this.keys[t].functionOut.evaluate(e);return this.keys[this.keys.length-1].Value}addKey(t){this.keys.push(t),this.keys.sort(e.AnimationKey.compare),this.regenerateFunctions()}removeKey(e){for(let t=0;t<this.keys.length;t++)if(this.keys[t]==e)return this.keys.splice(t,1),void this.regenerateFunctions()}removeKeyAtIndex(e){if(e<0||e>=this.keys.length)return null;let t=this.keys[e];return this.keys.splice(e,1),this.regenerateFunctions(),t}getKey(e){return e<0||e>=this.keys.length?null:this.keys[e]}get length(){return this.keys.length}serialize(){let e={keys:[],animationSequence:!0};for(let t=0;t<this.keys.length;t++)e.keys[t]=this.keys[t].serialize();return e}deserialize(t){for(let i=0;i<t.keys.length;i++){let r=new e.AnimationKey;r.deserialize(t.keys[i]),this.keys[i]=r}return this.regenerateFunctions(),this}reduceMutator(e){}regenerateFunctions(){for(let t=0;t<this.keys.length;t++){let i=new e.AnimationFunction(this.keys[t]);if(this.keys[t].functionOut=i,t==this.keys.length-1){i.setKeyOut=this.keys[0],this.keys[0].functionIn=i;break}i.setKeyOut=this.keys[t+1],this.keys[t+1].functionIn=i}}}e.AnimationSequence=t}(FudgeCore||(FudgeCore={})),function(e){class t extends AudioBuffer{static async load(t){const i=await window.fetch(t),r=await i.arrayBuffer();return await e.AudioManager.default.decodeAudioData(r)}}e.Audio=t}(FudgeCore||(FudgeCore={})),function(e){e.AudioDelay=class{constructor(e,t){this.audioDelay=e.getAudioContext().createDelay(t),this.setDelay(e,t)}setDelay(e,t){this.delay=t,this.audioDelay.delayTime.setValueAtTime(this.delay,e.getAudioContext().currentTime)}getDelay(){return this.delay}}}(FudgeCore||(FudgeCore={})),function(e){e.AudioFilter=class{constructor(e,t,i,r,n){this.initFilter(e,t,i,r,n)}initFilter(e,t,i,r,n){this.audioFilter=e.getAudioContext().createBiquadFilter(),this.setFilterType(t),this.setFrequency(e,i),this.setGain(e,r),this.setQuality(n)}setFilterType(e){this.filterType=e,this.audioFilter.type=this.filterType}getFilterType(){return this.filterType}setFrequency(e,t){this.audioFilter.frequency.setValueAtTime(t,e.getAudioContext().currentTime)}getFrequency(){return this.audioFilter.frequency.value}setGain(e,t){this.audioFilter.frequency.setValueAtTime(t,e.getAudioContext().currentTime)}getGain(){return this.audioFilter.gain.value}setQuality(e){this.audioFilter.Q.value=e}getQuality(){return this.audioFilter.Q.value}}}(FudgeCore||(FudgeCore={})),function(e){e.AudioLocalisation=class{constructor(e){this.pannerNode=e.getAudioContext().createPanner(),this.initDefaultValues()}updatePositions(e,t){this.setPannerPosition(e),this.setPannerOrientation(t)}setPannerPosition(e){this.position=e,this.pannerNode.positionX.value=-this.position.x,this.pannerNode.positionY.value=-this.position.z,this.pannerNode.positionZ.value=this.position.y}getPannerPosition(){return this.position}setPannerOrientation(e){this.orientation=e,this.pannerNode.orientationX.value=this.orientation.x,this.pannerNode.orientationY.value=-this.orientation.z,this.pannerNode.orientationZ.value=this.orientation.y}getPannerOrientation(){return this.orientation}setDistanceModel(e){this.distanceModel=e,this.pannerNode.distanceModel=this.distanceModel}getDistanceModel(){return this.distanceModel}setPanningModel(e){this.panningModel=e,this.pannerNode.panningModel=this.panningModel}getPanningModel(){return this.panningModel}setRefDistance(e){this.refDistance=e,this.pannerNode.refDistance=this.refDistance}getRefDistance(){return this.refDistance}setMaxDistance(e){this.maxDistance=e,this.pannerNode.maxDistance=this.maxDistance}getMaxDistance(){return this.maxDistance}setRolloffFactor(e){this.rolloffFactor=e,this.pannerNode.rolloffFactor=this.rolloffFactor}getRolloffFactor(){return this.rolloffFactor}setConeInnerAngle(e){this.coneInnerAngle=e,this.pannerNode.coneInnerAngle=this.coneInnerAngle}getConeInnerAngle(){return this.coneInnerAngle}setConeOuterAngle(e){this.coneOuterAngle=e,this.pannerNode.coneOuterAngle=this.coneOuterAngle}getConeOuterAngle(){return this.coneOuterAngle}setConeOuterGain(e){this.coneOuterGain=e,this.pannerNode.coneOuterGain=this.coneOuterGain}getConeOuterGain(){return this.coneOuterGain}showLocalisationSettings(){console.log("------------------------------"),console.log("Show all Settings of Panner"),console.log("------------------------------"),console.log("Panner Position: X: "+this.pannerNode.positionX.value+" | Y: "+this.pannerNode.positionY.value+" | Z: "+this.pannerNode.positionZ.value),console.log("Panner Orientation: X: "+this.pannerNode.orientationX.value+" | Y: "+this.pannerNode.orientationY.value+" | Z: "+this.pannerNode.orientationZ.value),console.log("Distance Model Type: "+this.distanceModel),console.log("Panner Model Type: "+this.panningModel),console.log("Ref Distance: "+this.refDistance),console.log("Max Distance: "+this.maxDistance),console.log("Rolloff Factor: "+this.rolloffFactor),console.log("Cone Inner Angle: "+this.coneInnerAngle),console.log("Cone Outer Angle: "+this.coneOuterAngle),console.log("Cone Outer Gain: "+this.coneOuterGain),console.log("------------------------------")}initDefaultValues(){this.setPanningModel("HRTF"),this.setDistanceModel("inverse"),this.setConeInnerAngle(360),this.setConeOuterAngle(0),this.setConeOuterGain(1),this.setRefDistance(1),this.setMaxDistance(5),this.setRolloffFactor(1),this.showLocalisationSettings()}}}(FudgeCore||(FudgeCore={})),function(e){class t extends AudioContext{constructor(e){super(e),this.listenTo=e=>{this.branch&&this.branch.broadcastEvent(new Event("childRemoveFromAudioBranch")),e&&(this.branch=e,this.branch.broadcastEvent(new Event("childAppendToAudioBranch")))},this.getBranchListeningTo=()=>this.branch,this.update=()=>{this.branch.broadcastEvent(new Event("updateAudioBranch"))},this.gain=this.createGain(),this.gain.connect(this.destination)}}t.default=new t({latencyHint:"interactive",sampleRate:44100}),e.AudioManager=t}(FudgeCore||(FudgeCore={})),function(e){e.AudioOscillator=class{constructor(e,t){this.audioOscillator=e.getAudioContext().createOscillator(),this.localGain=e.getAudioContext().createGain(),this.oscillatorType=t,"custom"!=this.oscillatorType?this.audioOscillator.type=this.oscillatorType:this.oscillatorWave?console.log("Create a Custom Periodic Wave first to use Custom Type"):this.audioOscillator.setPeriodicWave(this.oscillatorWave)}setOscillatorType(e){"custom"!=this.oscillatorType?this.audioOscillator.type=this.oscillatorType:this.oscillatorWave||this.audioOscillator.setPeriodicWave(this.oscillatorWave)}getOscillatorType(){return this.oscillatorType}createPeriodicWave(e,t,i){let r=new Float32Array(2);r[0]=t.startpoint,r[1]=t.endpoint;let n=new Float32Array(2);n[0]=i.startpoint,n[1]=i.endpoint,this.oscillatorWave=e.getAudioContext().createPeriodicWave(r,n)}setLocalGain(e){this.localGain=e}getLocalGain(){return this.localGain}setLocalGainValue(e){this.localGainValue=e,this.localGain.gain.value=this.localGainValue}getLocalGainValue(){return this.localGainValue}setFrequency(e,t){this.frequency=t,this.audioOscillator.frequency.setValueAtTime(this.frequency,e.getAudioContext().currentTime)}getFrequency(){return this.frequency}createSnare(e){this.setOscillatorType("triangle"),this.setFrequency(e,100),this.setLocalGainValue(0),this.localGain.gain.setValueAtTime(0,e.getAudioContext().currentTime),this.localGain.gain.exponentialRampToValueAtTime(.01,e.getAudioContext().currentTime+.1),this.audioOscillator.connect(this.localGain)}}}(FudgeCore||(FudgeCore={})),function(e){e.AudioSessionData=class{constructor(){this.dataArray=new Array}async urlToBuffer(e,t){let i={method:"GET",mode:"same-origin",cache:"no-cache",headers:{"Content-Type":"audio/mpeg3"},redirect:"follow"},r=null;for(let n=0;n<this.dataArray.length;n++)if(this.dataArray[n].url==t){if(console.log("Existing URL found"),null==this.dataArray[n].buffer){const r=await window.fetch(t,i),n=await r.arrayBuffer(),s=await e.decodeAudioData(n);return this.pushBufferInArray(t,s),s}return r=await this.dataArray[n].buffer,this.dataArray[n].buffer}if(null!=r)return null;try{this.pushUrlInArray(t);const r=await window.fetch(t,i),n=await r.arrayBuffer(),s=await e.decodeAudioData(n);return this.pushBufferInArray(t,s),s}catch(e){return this.logErrorFetch(e),null}}pushBufferInArray(e,t){for(let i=0;i<this.dataArray.length;i++)if(this.dataArray[i].url==e&&null==this.dataArray[i].buffer)return void(this.dataArray[i].buffer=t)}pushUrlInArray(e){let t;t={url:e,buffer:null},this.dataArray.push(t)}showDataInArray(){for(let e=0;e<this.dataArray.length;e++)console.log("Array Data: "+this.dataArray[e].url+this.dataArray[e].buffer)}logErrorFetch(e){console.log("Audio error",e)}}}(FudgeCore||(FudgeCore={})),function(e){e.AudioSettings=class{constructor(){this.setAudioContext(new AudioContext({latencyHint:"interactive",sampleRate:44100})),this.masterGain=this.globalAudioContext.createGain(),this.setMasterGainValue(1),this.setAudioSession(new e.AudioSessionData),this.masterGain.connect(this.globalAudioContext.destination)}setMasterGainValue(e){this.masterGainValue=e,this.masterGain.gain.value=this.masterGainValue}getMasterGainValue(){return this.masterGainValue}getAudioContext(){return this.globalAudioContext}setAudioContext(e){this.globalAudioContext=e}getAudioSession(){return this.audioSessionData}setAudioSession(e){this.audioSessionData=e}suspendAudioContext(){this.globalAudioContext.suspend()}resumeAudioContext(){this.globalAudioContext.resume()}}}(FudgeCore||(FudgeCore={})),function(e){e.AudioX=class{constructor(e,t,i,r){this.init(e,t,i,r)}async init(e,t,i,r){this.url=t;const n=e.getAudioSession().urlToBuffer(e.getAudioContext(),t);for(;!n;)console.log("Waiting for Promise..");await n.then(e=>{this.audioBuffer=e}),this.localGain=e.getAudioContext().createGain(),this.volume=i,this.createAudio(e,this.audioBuffer),this.isLooping=r}initBufferSource(e){this.bufferSource=e.getAudioContext().createBufferSource(),this.bufferSource.buffer=this.audioBuffer,this.beginLoop(),this.bufferSource.connect(this.localGain)}connect(e){this.localGain.connect(e)}set volume(e){this.localGain.gain.value=e}get volume(){return this.localGain.gain.value}setLooping(e){this.isLooping=e}getLooping(){return this.isLooping}setBufferSource(e){this.audioBuffer=e,this.bufferSource.buffer=e}getBufferSource(){return this.audioBuffer}createAudio(e,t){return this.audioBuffer=t,this.initBufferSource(e),this.audioBuffer}beginLoop(){this.bufferSource.loop=this.isLooping}}}(FudgeCore||(FudgeCore={})),function(e){class t{static decorateCoat(i){let r=t.coatInjections[i.name];r||e.Debug.error("No injection decorator defined for "+i.name),Object.defineProperty(i.prototype,"useRenderData",{value:r})}static injectRenderDataForCoatColored(t){let i=t.uniforms.u_color,r=this.color.getArray();e.RenderOperator.getRenderingContext().uniform4fv(i,r)}static injectRenderDataForCoatTextured(t){let i=e.RenderOperator.getRenderingContext();if(this.renderData)i.activeTexture(WebGL2RenderingContext.TEXTURE0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.renderData.texture0),i.uniform1i(t.uniforms.u_texture,0),i.uniformMatrix3fv(t.uniforms.u_pivot,!1,this.pivot.get());else{this.renderData={};const r=e.RenderManager.assert(i.createTexture());i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r);try{i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.texture.image),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,this.texture.image)}catch(t){e.Debug.error(t)}i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.generateMipmap(i.TEXTURE_2D),this.renderData.texture0=r,i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.useRenderData(t)}}static injectRenderDataForCoatMatCap(t){let i=e.RenderOperator.getRenderingContext(),r=t.uniforms.u_tint_color,{r:n,g:s,b:a,a:o}=this.tintColor,c=new Float32Array([n,s,a,o]);i.uniform4fv(r,c);let l=t.uniforms.u_flatmix,u=this.flatMix;if(i.uniform1f(l,u),this.renderData)i.activeTexture(WebGL2RenderingContext.TEXTURE0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.renderData.texture0),i.uniform1i(t.uniforms.u_texture,0);else{this.renderData={};const r=e.RenderManager.assert(i.createTexture());i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r);try{i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this.texture.image),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,this.texture.image)}catch(t){e.Debug.error(t)}i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.generateMipmap(i.TEXTURE_2D),this.renderData.texture0=r,i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.useRenderData(t)}}}t.coatInjections={CoatColored:t.injectRenderDataForCoatColored,CoatTextured:t.injectRenderDataForCoatTextured,CoatMatCap:t.injectRenderDataForCoatMatCap},e.RenderInjector=t}(FudgeCore||(FudgeCore={})),function(e){class t{static assert(e,i=""){if(null===e)throw new Error(`Assertion failed. ${i}, WebGL-Error: ${t.crc3?t.crc3.getError():""}`);return e}static initialize(i=!1,r=!0){let n={alpha:r,antialias:i,premultipliedAlpha:!1},s=document.createElement("canvas");t.crc3=t.assert(s.getContext("webgl2",n),"WebGL-context couldn't be created"),t.crc3.enable(WebGL2RenderingContext.CULL_FACE),t.crc3.enable(WebGL2RenderingContext.DEPTH_TEST),t.crc3.enable(WebGL2RenderingContext.BLEND),t.crc3.blendEquation(WebGL2RenderingContext.FUNC_ADD),t.crc3.blendFunc(WebGL2RenderingContext.DST_ALPHA,WebGL2RenderingContext.ONE_MINUS_DST_ALPHA),t.rectViewport=t.getCanvasRect(),t.renderShaderRayCast=t.createProgram(e.ShaderRayCast)}static getCanvas(){return t.crc3.canvas}static getRenderingContext(){return t.crc3}static getCanvasRect(){let i=t.crc3.canvas;return e.Rectangle.GET(0,0,i.width,i.height)}static setCanvasSize(e,i){t.crc3.canvas.width=e,t.crc3.canvas.height=i}static setViewportRectangle(e){Object.assign(t.rectViewport,e),t.crc3.viewport(e.x,e.y,e.width,e.height)}static getViewportRectangle(){return t.rectViewport}static createRenderLights(t){let i={};for(let r of t)switch(r[0]){case e.LightAmbient:let t=[];for(let e of r[1]){let i=e.light.color;t.push(i.r,i.g,i.b,i.a)}i.u_ambient=new Float32Array(t);break;case e.LightDirectional:let n=[];for(let e of r[1]){let t=e.light.color;n.push(t.r,t.g,t.b,t.a,0,0,1)}i.u_directional=new Float32Array(n);break;default:e.Debug.warn("Shaderstructure undefined for",r[0])}return i}static setLightsInShader(i,r){t.useProgram(i);let n=i.uniforms,s=n["u_ambient.color"];if(s){let i=r.get(e.LightAmbient);if(i){let r=new e.Color(0,0,0,1);for(let e of i)r.add(e.light.color);t.crc3.uniform4fv(s,r.getArray())}}let a=n.u_nLightsDirectional;if(a){let i=r.get(e.LightDirectional);if(i){let r=i.length;t.crc3.uniform1ui(a,r);for(let s=0;s<r;s++){let r=i[s];t.crc3.uniform4fv(n[`u_directional[${s}].color`],r.light.color.getArray());let a=e.Vector3.Z();a.transform(r.pivot),a.transform(r.getContainer().mtxWorld),t.crc3.uniform3fv(n[`u_directional[${s}].direction`],a.get())}}}}static draw(i,r,n,s,a){t.useProgram(i),t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,r.vertices),t.crc3.enableVertexAttribArray(i.attributes.a_position),t.setAttributeStructure(i.attributes.a_position,e.Mesh.getBufferSpecification()),t.crc3.bindBuffer(WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,r.indices),i.attributes.a_textureUVs&&(t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,r.textureUVs),t.crc3.enableVertexAttribArray(i.attributes.a_textureUVs),t.crc3.vertexAttribPointer(i.attributes.a_textureUVs,2,WebGL2RenderingContext.FLOAT,!1,0,0));let o=i.uniforms.u_projection;if(t.crc3.uniformMatrix4fv(o,!1,a.get()),i.uniforms.u_world){let n=i.uniforms.u_world;t.crc3.uniformMatrix4fv(n,!1,s.get()),t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,r.normalsFace),t.crc3.enableVertexAttribArray(i.attributes.a_normal),t.setAttributeStructure(i.attributes.a_normal,e.Mesh.getBufferSpecification())}n.coat.useRenderData(i),t.crc3.drawElements(WebGL2RenderingContext.TRIANGLES,r.nIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0)}static drawForRayCast(i,r,n,s){let a=t.renderShaderRayCast;t.useProgram(a),t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,r.vertices),t.crc3.enableVertexAttribArray(a.attributes.a_position),t.setAttributeStructure(a.attributes.a_position,e.Mesh.getBufferSpecification()),t.crc3.bindBuffer(WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,r.indices);let o=a.uniforms.u_projection;if(t.crc3.uniformMatrix4fv(o,!1,s.get()),a.uniforms.u_world){let e=a.uniforms.u_world;t.crc3.uniformMatrix4fv(e,!1,n.get())}let c=a.uniforms.u_id;t.getRenderingContext().uniform1i(c,i),t.crc3.drawElements(WebGL2RenderingContext.TRIANGLES,r.nIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0)}static createProgram(i){let r,n=t.crc3,s=n.createProgram();try{n.attachShader(s,t.assert(a(i.getVertexShaderSource(),WebGL2RenderingContext.VERTEX_SHADER))),n.attachShader(s,t.assert(a(i.getFragmentShaderSource(),WebGL2RenderingContext.FRAGMENT_SHADER))),n.linkProgram(s);let e=t.assert(n.getProgramInfoLog(s));if(""!==e)throw new Error("Error linking Shader: "+e);r={program:s,attributes:function(){let e={},i=n.getProgramParameter(s,WebGL2RenderingContext.ACTIVE_ATTRIBUTES);for(let r=0;r<i;r++){let i=t.assert(n.getActiveAttrib(s,r));if(!i)break;e[i.name]=n.getAttribLocation(s,i.name)}return e}(),uniforms:function(){let e={},i=n.getProgramParameter(s,WebGL2RenderingContext.ACTIVE_UNIFORMS);for(let r=0;r<i;r++){let i=t.assert(n.getActiveUniform(s,r));if(!i)break;e[i.name]=t.assert(n.getUniformLocation(s,i.name))}return e}()}}catch(t){e.Debug.error(t)}return r;function a(e,i){let r=n.createShader(i);n.shaderSource(r,e),n.compileShader(r);let s=t.assert(n.getShaderInfoLog(r));if(""!==s)throw new Error("Error compiling shader: "+s);return n.getShaderParameter(r,WebGL2RenderingContext.COMPILE_STATUS)?r:(alert(n.getShaderInfoLog(r)),null)}}static useProgram(e){t.crc3.useProgram(e.program),t.crc3.enableVertexAttribArray(e.attributes.a_position)}static deleteProgram(e){e&&(t.crc3.deleteProgram(e.program),delete e.attributes,delete e.uniforms)}static createBuffers(e){let i=t.assert(t.crc3.createBuffer());t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,i),t.crc3.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,e.vertices,WebGL2RenderingContext.STATIC_DRAW);let r=t.assert(t.crc3.createBuffer());t.crc3.bindBuffer(WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,r),t.crc3.bufferData(WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,e.indices,WebGL2RenderingContext.STATIC_DRAW);let n=t.crc3.createBuffer();t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,n),t.crc3.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,e.textureUVs,WebGL2RenderingContext.STATIC_DRAW);let s=t.assert(t.crc3.createBuffer());return t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,s),t.crc3.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,e.normalsFace,WebGL2RenderingContext.STATIC_DRAW),{vertices:i,indices:r,nIndices:e.getIndexCount(),textureUVs:n,normalsFace:s}}static useBuffers(e){}static deleteBuffers(e){e&&(t.crc3.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,null),t.crc3.deleteBuffer(e.vertices),t.crc3.deleteBuffer(e.textureUVs),t.crc3.bindBuffer(WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,null),t.crc3.deleteBuffer(e.indices))}static createParameter(e){return{coat:e}}static useParameter(e){}static deleteParameter(e){e&&t.crc3.bindVertexArray(null)}static setAttributeStructure(e,i){t.crc3.vertexAttribPointer(e,i.size,i.dataType,i.normalize,i.stride,i.offset)}}e.RenderOperator=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(){super(...arguments),this.name="Coat"}mutate(e){super.mutate(e)}useRenderData(e){}serialize(){return this.getMutator()}deserialize(e){return this.mutate(e),this}reduceMutator(){}}e.Coat=t;let i=class extends t{constructor(t){super(),this.color=t||new e.Color(.5,.5,.5,1)}};i=__decorate([e.RenderInjector.decorateCoat],i),e.CoatColored=i;let r=class extends t{constructor(t,i,r){super(),this.texture=null,this.tintColor=new e.Color(.5,.5,.5,1),this.flatMix=.5,this.texture=t||new e.TextureImage,this.tintColor=i||new e.Color(.5,.5,.5,1),this.flatMix=this.flatMix=r>1?1:r||.5}};r=__decorate([e.RenderInjector.decorateCoat],r),e.CoatMatCap=r}(FudgeCore||(FudgeCore={})),function(e){let t=class extends e.Coat{constructor(){super(...arguments),this.texture=null,this.pivot=e.Matrix3x3.IDENTITY}};t=__decorate([e.RenderInjector.decorateCoat],t),e.CoatTextured=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(){super(...arguments),this.singleton=!0,this.container=null,this.active=!0}activate(e){this.active=e,this.dispatchEvent(new Event(e?"componentActivate":"componentDeactivate"))}get isActive(){return this.active}get isSingleton(){return this.singleton}getContainer(){return this.container}setContainer(e){if(this.container==e)return;let t=this.container;try{t&&t.removeComponent(this),this.container=e,this.container&&this.container.addComponent(this)}catch(e){this.container=t}}serialize(){return{active:this.active}}deserialize(e){return this.active=e.active,this}reduceMutator(e){delete e.singleton,delete e.container}}e.Component=t}(FudgeCore||(FudgeCore={})),function(e){let t,i;!function(e){e[e.LOOP=0]="LOOP",e[e.PLAYONCE=1]="PLAYONCE",e[e.PLAYONCESTOPAFTER=2]="PLAYONCESTOPAFTER",e[e.REVERSELOOP=3]="REVERSELOOP",e[e.STOP=4]="STOP"}(t=e.ANIMATION_PLAYMODE||(e.ANIMATION_PLAYMODE={})),function(e){e[e.TIMEBASED_CONTINOUS=0]="TIMEBASED_CONTINOUS",e[e.TIMEBASED_RASTERED_TO_FPS=1]="TIMEBASED_RASTERED_TO_FPS",e[e.FRAMEBASED=2]="FRAMEBASED"}(i=e.ANIMATION_PLAYBACK||(e.ANIMATION_PLAYBACK={}));class r extends e.Component{constructor(r=new e.Animation(""),n=t.LOOP,s=i.TIMEBASED_CONTINOUS){super(),this.speedScalesWithGlobalSpeed=!0,this.speedScale=1,this.lastTime=0,this.animation=r,this.playmode=n,this.playback=s,this.localTime=new e.Time,this.animation.calculateTotalTime(),e.Loop.addEventListener("loopFrame",this.updateAnimationLoop.bind(this)),e.Time.game.addEventListener("timeScaled",this.updateScale.bind(this))}set speed(e){this.speedScale=e,this.updateScale()}jumpTo(e){this.localTime.set(e),this.lastTime=e,e%=this.animation.totalTime;let t=this.animation.getMutated(e,this.calculateDirection(e),this.playback);this.getContainer().applyAnimation(t)}getCurrentTime(){return this.localTime.get()%this.animation.totalTime}updateAnimation(e){return this.updateAnimationLoop(null,e)}serialize(){let e=super.serialize();return e.animation=this.animation.serialize(),e.playmode=this.playmode,e.playback=this.playback,e.speedScale=this.speedScale,e.speedScalesWithGlobalSpeed=this.speedScalesWithGlobalSpeed,e[super.constructor.name]=super.serialize(),e}deserialize(t){return this.animation=new e.Animation(""),this.animation.deserialize(t.animation),this.playback=t.playback,this.playmode=t.playmode,this.speedScale=t.speedScale,this.speedScalesWithGlobalSpeed=t.speedScalesWithGlobalSpeed,super.deserialize(t[super.constructor.name]),this}updateAnimationLoop(e,t){if(0==this.animation.totalTime)return[null,0];let r=t||this.localTime.get();this.playback==i.FRAMEBASED&&(r=this.lastTime+1e3/this.animation.fps);let n=this.calculateDirection(r);if(r=this.applyPlaymodes(r),this.executeEvents(this.animation.getEventsToFire(this.lastTime,r,this.playback,n)),this.lastTime!=r){this.lastTime=r,r%=this.animation.totalTime;let e=this.animation.getMutated(r,n,this.playback);return this.getContainer()&&this.getContainer().applyAnimation(e),[e,r]}return[null,r]}executeEvents(e){for(let t=0;t<e.length;t++)this.dispatchEvent(new Event(e[t]))}applyPlaymodes(e){switch(this.playmode){case t.STOP:return this.localTime.getOffset();case t.PLAYONCE:return e>=this.animation.totalTime?this.animation.totalTime-.01:e;case t.PLAYONCESTOPAFTER:return e>=this.animation.totalTime?this.animation.totalTime+.01:e;default:return e}}calculateDirection(e){switch(this.playmode){case t.STOP:return 0;case t.REVERSELOOP:return-1;case t.PLAYONCE:case t.PLAYONCESTOPAFTER:if(e>=this.animation.totalTime)return 0;default:return 1}}updateScale(){let t=this.speedScale;this.speedScalesWithGlobalSpeed&&(t*=e.Time.game.getScale()),this.localTime.setScale(t)}}e.ComponentAnimator=r}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(t=null,i=!1,r=!1){super(),this.pivot=e.Matrix4x4.IDENTITY,this.singleton=!1,this.playing=!1,this.connected=!1,this.listened=!1,this.handleAttach=t=>{e.Debug.log(t),"componentAdd"==t.type?(this.getContainer().addEventListener("childAppendToAudioBranch",this.handleBranch,!0),this.getContainer().addEventListener("childRemoveFromAudioBranch",this.handleBranch,!0),this.getContainer().addEventListener("updateAudioBranch",this.updatePanner,!0),this.listened=this.getContainer().isDescendantOf(e.AudioManager.default.getBranchListeningTo())):(this.getContainer().removeEventListener("childAppendToAudioBranch",this.handleBranch,!0),this.getContainer().removeEventListener("childRemoveFromAudioBranch",this.handleBranch,!0),this.getContainer().removeEventListener("updateAudioBranch",this.updatePanner,!0),this.listened=!1),this.updateConnection()},this.handleBranch=t=>{e.Debug.log(t),this.listened="childAppendToAudioBranch"==t.type,this.updateConnection()},this.updatePanner=t=>{e.Debug.log(t);let i=e.Matrix4x4.MULTIPLICATION(this.getContainer().mtxWorld,this.pivot);e.Debug.log(i.toString()),this.panner.setPosition(i.translation.x,i.translation.y,i.translation.z)},this.install(),this.createSource(t,i),this.addEventListener("componentAdd",this.handleAttach),this.addEventListener("componentRemove",this.handleAttach),r&&this.play(r)}set audio(e){this.source.buffer=e}get audio(){return this.source.buffer}play(e){e?(this.createSource(this.audio,this.source.loop),this.source.start(0,0)):this.source.stop(),this.playing=e}get isPlaying(){return this.playing}get isConnected(){return this.connected}get isAttached(){return null!=this.getContainer()}get isListened(){return this.listened}activate(e){super.activate(e),this.updateConnection()}install(t=e.AudioManager.default){let i=this.isActive;this.activate(!1),this.audioManager=t,this.panner=t.createPanner(),this.gain=t.createGain(),this.panner.connect(this.gain),this.gain.connect(t.gain),this.activate(i)}createSource(e,t){this.source=this.audioManager.createBufferSource(),this.source.connect(this.panner),e&&(this.audio=e),this.source.loop=t}connect(e){e?this.gain.connect(this.audioManager.gain):this.gain.disconnect(this.audioManager.gain)}updateConnection(){try{this.connect(this.isActive&&this.isAttached&&this.listened)}catch(e){}}}e.ComponentAudio=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(e){super(),this.audioListener=e.getAudioContext().listener}setAudioListener(e){this.audioListener=e.getAudioContext().listener}getAudioListener(){return this.audioListener}setListenerPosition(e){this.positionBase=e,this.audioListener.positionX.value=this.positionBase.x,this.audioListener.positionY.value=-this.positionBase.z,this.audioListener.positionZ.value=this.positionBase.y,console.log("Set Listener Position: X: "+this.audioListener.positionX.value+" | Y: "+this.audioListener.positionY.value+" | Z: "+this.audioListener.positionZ.value)}getListenerPosition(){return this.positionBase}setListenerPositionForward(e){this.positionFW=e,this.audioListener.forwardX.value=this.positionFW.x,this.audioListener.forwardY.value=1-this.positionFW.z,this.audioListener.forwardZ.value=this.positionFW.y}getListenerPositionForward(){return this.positionFW}setListenerPostitionUp(e){this.positionUP=e,this.audioListener.upX.value=this.positionUP.x,this.audioListener.upY.value=-this.positionUP.z,this.audioListener.upZ.value=this.positionUP.y+1}getListenerPositionUp(){return this.positionUP}updatePositions(e){this.setListenerPosition(e),this.setListenerPositionForward(e),this.setListenerPostitionUp(e)}showListenerSettings(){console.log("------------------------------"),console.log("Show all Settings of Listener"),console.log("------------------------------"),console.log("Listener Position Base: X: "+this.audioListener.positionX.value+" | Y: "+this.audioListener.positionY.value+" | Z: "+this.audioListener.positionZ.value),console.log("Listener Position Up: X: "+this.audioListener.upX.value+" | Y: "+this.audioListener.upY.value+" | Z: "+this.audioListener.upZ.value),console.log("Listener Position Forward: X: "+this.audioListener.forwardX.value+" | Y: "+this.audioListener.forwardY.value+" | Z: "+this.audioListener.forwardZ.value),console.log("------------------------------")}serialize(){return{audioListener:this.audioListener,posBase:this.positionBase,posFW:this.positionFW,posUP:this.positionUP}}deserialize(e){return this.audioListener=e.audioListener,this.positionBase=e.posBase,this.positionFW=e.posFW,this.positionUP=e.posUP,this}reduceMutator(e){delete this.audioListener,delete this.positionBase,delete this.positionFW,delete this.positionUP}}e.ComponentAudioListener=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(e,t){super(),this.isLocalised=!1,this.isFiltered=!1,this.isDelayed=!1,this.singleton=!1,this.playing=!1,e&&this.setAudio(e)}setFilter(e){this.filter=e,this.isFiltered=!0}getFilter(){return this.filter}setDelay(e){this.delay=e,this.isDelayed=!0}getDelay(){return this.delay}setLocalisation(e){this.localisation=e,this.isLocalised=!0}getLocalisation(){return this.localisation}playAudio(e,t,i){this.audio.initBufferSource(e),this.connectAudioNodes(e),this.audio.bufferSource.start(e.getAudioContext().currentTime,t,i),this.playing=!0}stop(){this.audio.bufferSource.stop(),this.playing=!1}get isPlaying(){return this.playing}setAudio(e){this.audio=e}getAudio(){return this.audio}serialize(){return{isFiltered:this.isFiltered,isDelayed:this.isDelayed,isLocalised:this.isLocalised,audio:this.audio,filter:this.filter,delay:this.delay,localisation:this.localisation}}deserialize(e){return this.isFiltered=e.isFiltered,this.isDelayed=e.isDelayed,this.isLocalised=e.isLocalised,this.audio=e.audio,this.filter=e.filter,this.delay=e.delay,this}reduceMutator(e){delete this.audio,delete this.filter,delete this.delay,delete this.localisation}connectAudioNodes(e){let t,i,r;const n=e.masterGain;console.log("-------------------------------"),console.log("Connecting Properties for Audio"),console.log("-------------------------------"),this.isLocalised&&null!=this.localisation?(console.log("Connect Localisation"),t=this.localisation.pannerNode,this.audio.connect(t),this.isFiltered&&null!=this.filter?(console.log("Connect Filter"),i=this.filter.audioFilter,t.connect(i),this.isDelayed&&null!=this.delay?(console.log("Connect Delay"),r=this.delay.audioDelay,i.connect(r),console.log("Connect Master Gain"),r.connect(n)):(console.log("Connect Master Gain"),i.connect(n))):this.isDelayed&&null!=this.delay?(console.log("Connect Delay"),r=this.delay.audioDelay,t.connect(r),console.log("Connect Master Gain"),r.connect(n)):(console.log("Connect Master Gain"),t.connect(n))):this.isFiltered&&null!=this.filter?(console.log("Connect Filter"),i=this.filter.audioFilter,this.audio.connect(i),this.isDelayed&&null!=this.delay?(console.log("Connect Delay"),r=this.delay.audioDelay,i.connect(r),console.log("Connect Master Gain"),r.connect(n)):(console.log("Connect Master Gain"),i.connect(n))):this.isDelayed&&null!=this.delay?(console.log("Connect Delay"),r=this.delay.audioDelay,this.audio.connect(r),console.log("Connect Master Gain"),r.connect(n)):(console.log("Connect Only Master Gain"),this.audio.connect(n)),console.log("-------------------------------")}}e.ComponentAudioX=t}(FudgeCore||(FudgeCore={})),function(e){let t,i;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.DIAGONAL=2]="DIAGONAL"}(t=e.FIELD_OF_VIEW||(e.FIELD_OF_VIEW={})),function(e){e.CENTRAL="central",e.ORTHOGRAPHIC="orthographic",e.DIMETRIC="dimetric",e.STEREO="stereo"}(i=e.PROJECTION||(e.PROJECTION={}));class r extends e.Component{constructor(){super(...arguments),this.pivot=e.Matrix4x4.IDENTITY,this.backgroundColor=new e.Color(0,0,0,1),this.projection=i.CENTRAL,this.transform=new e.Matrix4x4,this.fieldOfView=45,this.aspectRatio=1,this.direction=t.DIAGONAL,this.backgroundEnabled=!0}getProjection(){return this.projection}getBackgroundEnabled(){return this.backgroundEnabled}getAspect(){return this.aspectRatio}getFieldOfView(){return this.fieldOfView}getDirection(){return this.direction}get ViewProjectionMatrix(){let t=this.pivot;try{t=e.Matrix4x4.MULTIPLICATION(this.getContainer().mtxWorld,this.pivot)}catch(e){}let i=e.Matrix4x4.INVERSION(t);return i=e.Matrix4x4.MULTIPLICATION(this.transform,i),i}projectCentral(t=this.aspectRatio,r=this.fieldOfView,n=this.direction){this.aspectRatio=t,this.fieldOfView=r,this.direction=n,this.projection=i.CENTRAL,this.transform=e.Matrix4x4.PROJECTION_CENTRAL(t,this.fieldOfView,1,2e3,this.direction)}projectOrthographic(t=0,r=e.RenderManager.getCanvas().clientWidth,n=e.RenderManager.getCanvas().clientHeight,s=0){this.projection=i.ORTHOGRAPHIC,this.transform=e.Matrix4x4.PROJECTION_ORTHOGRAPHIC(t,r,n,s,400,-400)}getProjectionRectangle(){let i=Math.tan(Math.PI*this.fieldOfView/360),r=0,n=0;if(this.direction==t.DIAGONAL){let e=Math.sqrt(this.aspectRatio);r=i*e,n=i/e}else this.direction==t.VERTICAL?(n=i,r=n*this.aspectRatio):(r=i,n=r/this.aspectRatio);return e.Rectangle.GET(0,0,2*r,2*n)}project(t){let i;i=e.Vector3.TRANSFORMATION(t,this.ViewProjectionMatrix);let r=this.ViewProjectionMatrix.get(),n=r[3]*t.x+r[7]*t.y+r[11]*t.z+r[15];return i.scale(1/n),i}serialize(){return{backgroundColor:this.backgroundColor,backgroundEnabled:this.backgroundEnabled,projection:this.projection,fieldOfView:this.fieldOfView,direction:this.direction,aspect:this.aspectRatio,pivot:this.pivot.serialize(),[super.constructor.name]:super.serialize()}}deserialize(e){switch(this.backgroundColor=e.backgroundColor,this.backgroundEnabled=e.backgroundEnabled,this.projection=e.projection,this.fieldOfView=e.fieldOfView,this.aspectRatio=e.aspect,this.direction=e.direction,this.pivot.deserialize(e.pivot),super.deserialize(e[super.constructor.name]),this.projection){case i.ORTHOGRAPHIC:this.projectOrthographic();break;case i.CENTRAL:this.projectCentral()}return this}getMutatorAttributeTypes(e){let r=super.getMutatorAttributeTypes(e);return r.direction&&(r.direction=t),r.projection&&(r.projection=i),r}mutate(e){switch(super.mutate(e),this.projection){case i.CENTRAL:this.projectCentral(this.aspectRatio,this.fieldOfView,this.direction)}}reduceMutator(e){delete e.transform,super.reduceMutator(e)}}e.ComponentCamera=r}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(t=new e.Color(1,1,1,1)){super(),this.color=t}getType(){return this.constructor}reduceMutator(){}}e.Light=t;e.LightAmbient=class extends t{constructor(t=new e.Color(1,1,1,1)){super(t)}};e.LightDirectional=class extends t{constructor(t=new e.Color(1,1,1,1)){super(t)}};e.LightPoint=class extends t{constructor(){super(...arguments),this.range=10}};e.LightSpot=class extends t{}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(t=new e.LightAmbient){super(),this.pivot=e.Matrix4x4.IDENTITY,this.light=null,this.singleton=!1,this.light=t}setType(e){let t={};this.light&&(t=this.light.getMutator()),this.light=new e,this.light.mutate(t)}}e.ComponentLight=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(e=null){super(),this.material=e}serialize(){let t,i=this.material.idResource;return t=i?{idMaterial:i}:{material:e.Serializer.serialize(this.material)},t[super.constructor.name]=super.serialize(),t}deserialize(t){let i;return i=t.idMaterial?e.ResourceManager.get(t.idMaterial):e.Serializer.deserialize(t.material),this.material=i,super.deserialize(t[super.constructor.name]),this}}e.ComponentMaterial=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(t=null){super(),this.pivot=e.Matrix4x4.IDENTITY,this.mesh=null,this.mesh=t}serialize(){let t,i=this.mesh.idResource;return t=i?{idMesh:i}:{mesh:e.Serializer.serialize(this.mesh)},t.pivot=this.pivot.serialize(),t[super.constructor.name]=super.serialize(),t}deserialize(t){let i;return i=t.idMesh?e.ResourceManager.get(t.idMesh):e.Serializer.deserialize(t.mesh),this.mesh=i,this.pivot.deserialize(t.pivot),super.deserialize(t[super.constructor.name]),this}}e.ComponentMesh=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(){super(),this.singleton=!1}serialize(){return this.getMutator()}deserialize(e){return this.mutate(e),this}}e.ComponentScript=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Component{constructor(t=e.Matrix4x4.IDENTITY){super(),this.local=t}serialize(){return{local:this.local.serialize(),[super.constructor.name]:super.serialize()}}deserialize(e){return super.deserialize(e[super.constructor.name]),this.local.deserialize(e.local),this}reduceMutator(e){delete e.world,super.reduceMutator(e)}}e.ComponentTransform=t}(FudgeCore||(FudgeCore={})),function(e){let t;!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.LOG=2]="LOG",e[e.WARN=4]="WARN",e[e.ERROR=8]="ERROR",e[e.CLEAR=16]="CLEAR",e[e.GROUP=32]="GROUP",e[e.GROUPCOLLAPSED=64]="GROUPCOLLAPSED",e[e.GROUPEND=128]="GROUPEND",e[e.MESSAGES=15]="MESSAGES",e[e.FORMAT=240]="FORMAT",e[e.ALL=255]="ALL"}(t=e.DEBUG_FILTER||(e.DEBUG_FILTER={}))}(FudgeCore||(FudgeCore={})),function(e){e.DebugTarget=class{static mergeArguments(e,...t){let i=e.toString();for(let e of t)i+=e instanceof Number?", "+e.toPrecision(2).toString():", "+e.toString();return i}}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.DebugTarget{static createDelegate(t){return function(i,...r){let n=r.map(e=>e.toString()),s=t+"\n\n"+e.DebugTarget.mergeArguments(i,n);alert(s)}}}t.delegates={[e.DEBUG_FILTER.INFO]:t.createDelegate("Info"),[e.DEBUG_FILTER.LOG]:t.createDelegate("Log"),[e.DEBUG_FILTER.WARN]:t.createDelegate("Warn"),[e.DEBUG_FILTER.ERROR]:t.createDelegate("Error")},e.DebugAlert=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.DebugTarget{}t.delegates={[e.DEBUG_FILTER.INFO]:console.info,[e.DEBUG_FILTER.LOG]:console.log,[e.DEBUG_FILTER.WARN]:console.warn,[e.DEBUG_FILTER.ERROR]:console.error,[e.DEBUG_FILTER.CLEAR]:console.clear,[e.DEBUG_FILTER.GROUP]:console.group,[e.DEBUG_FILTER.GROUPCOLLAPSED]:console.groupCollapsed,[e.DEBUG_FILTER.GROUPEND]:console.groupEnd},e.DebugConsole=t}(FudgeCore||(FudgeCore={})),function(e){class t{static setFilter(i,r){for(let e in t.delegates)t.delegates[e].delete(i);for(let n in e.DEBUG_FILTER){let s=parseInt(n);if(isNaN(s))break;-1==[e.DEBUG_FILTER.MESSAGES,e.DEBUG_FILTER.FORMAT,e.DEBUG_FILTER.ALL].indexOf(s)&&(r&s&&t.delegates[s].set(i,i.delegates[s]))}}static info(i,...r){t.delegate(e.DEBUG_FILTER.INFO,i,r)}static log(i,...r){t.delegate(e.DEBUG_FILTER.LOG,i,r)}static warn(i,...r){t.delegate(e.DEBUG_FILTER.WARN,i,r)}static error(i,...r){t.delegate(e.DEBUG_FILTER.ERROR,i,r)}static clear(){t.delegate(e.DEBUG_FILTER.CLEAR,null,null)}static group(i){t.delegate(e.DEBUG_FILTER.GROUP,i,null)}static groupCollapsed(i){t.delegate(e.DEBUG_FILTER.GROUPCOLLAPSED,i,null)}static groupEnd(){t.delegate(e.DEBUG_FILTER.GROUPEND,null,null)}static delegate(e,i,r){let n=t.delegates[e];for(let e of n.values())r&&r.length>0?e(i,...r):e(i)}}t.delegates={[e.DEBUG_FILTER.INFO]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.INFO]]]),[e.DEBUG_FILTER.LOG]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.LOG]]]),[e.DEBUG_FILTER.WARN]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.WARN]]]),[e.DEBUG_FILTER.ERROR]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.ERROR]]]),[e.DEBUG_FILTER.CLEAR]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.CLEAR]]]),[e.DEBUG_FILTER.GROUP]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.GROUP]]]),[e.DEBUG_FILTER.GROUPCOLLAPSED]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.GROUPCOLLAPSED]]]),[e.DEBUG_FILTER.GROUPEND]:new Map([[e.DebugConsole,e.DebugConsole.delegates[e.DEBUG_FILTER.GROUPEND]]])},e.Debug=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.DebugTarget{}e.DebugDialog=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.DebugTarget{static clear(){t.textArea.textContent="",t.groups=[]}static group(e){t.print("▼ "+e),t.groups.push(e)}static groupEnd(){t.groups.pop()}static createDelegate(i){return function(r,...n){t.print(i+" "+e.DebugTarget.mergeArguments(r,n))}}static getIndentation(e){let t="";for(let i=0;i<e;i++)t+="| ";return t}static print(e){t.textArea.textContent+=t.getIndentation(t.groups.length)+e+"\n"}}t.textArea=document.createElement("textarea"),t.delegates={[e.DEBUG_FILTER.INFO]:t.createDelegate("✓"),[e.DEBUG_FILTER.LOG]:t.createDelegate("✎"),[e.DEBUG_FILTER.WARN]:t.createDelegate("⚠"),[e.DEBUG_FILTER.ERROR]:t.createDelegate("❌"),[e.DEBUG_FILTER.CLEAR]:t.clear,[e.DEBUG_FILTER.GROUP]:t.group,[e.DEBUG_FILTER.GROUPCOLLAPSED]:t.group,[e.DEBUG_FILTER.GROUPEND]:t.groupEnd},t.groups=[],e.DebugTextArea=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(e=1,t=1,i=1,r=1){super(),this.setNormRGBA(e,t,i,r)}static getHexFromCSSKeyword(e){return t.crc2.fillStyle=e,t.crc2.fillStyle}static CSS(e,i=1){let r=t.getHexFromCSSKeyword(e);return new t(parseInt(r.substr(1,2),16)/255,parseInt(r.substr(3,2),16)/255,parseInt(r.substr(5,2),16)/255,i)}static MULTIPLY(e,i){return new t(e.r*i.r,e.g*i.g,e.b*i.b,e.a*i.a)}setNormRGBA(e,t,i,r){this.r=Math.min(1,Math.max(0,e)),this.g=Math.min(1,Math.max(0,t)),this.b=Math.min(1,Math.max(0,i)),this.a=Math.min(1,Math.max(0,r))}setBytesRGBA(e,t,i,r){this.setNormRGBA(e/255,t/255,i/255,r/255)}getArray(){return new Float32Array([this.r,this.g,this.b,this.a])}setArrayNormRGBA(e){this.setNormRGBA(e[0],e[1],e[2],e[3])}setArrayBytesRGBA(e){this.setBytesRGBA(e[0],e[1],e[2],e[3])}getArrayBytesRGBA(){return new Uint8ClampedArray([255*this.r,255*this.g,255*this.b,255*this.a])}add(e){this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a}getCSS(){let e=this.getArrayBytesRGBA();return`RGBA(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}reduceMutator(e){}}t.crc2=document.createElement("canvas").getContext("2d"),e.Color=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(e,t,i){super(),this.idResource=void 0,this.name=e,this.shaderType=t,t&&(i?this.setCoat(i):this.setCoat(this.createCoatMatchingShader()))}createCoatMatchingShader(){return new(this.shaderType.getCoat())}setCoat(e){if(e.constructor!=this.shaderType.getCoat())throw new Error("Shader and coat don't match");this.coat=e}getCoat(){return this.coat}setShader(e){this.shaderType=e;let t=this.createCoatMatchingShader();t.mutate(this.coat.getMutator()),this.setCoat(t)}getShader(){return this.shaderType}serialize(){return{name:this.name,idResource:this.idResource,shader:this.shaderType.name,coat:e.Serializer.serialize(this.coat)}}deserialize(t){this.name=t.name,this.idResource=t.idResource,this.shaderType=e[t.shader];let i=e.Serializer.deserialize(t.coat);return this.setCoat(i),this}reduceMutator(e){}}e.Material=t}(FudgeCore||(FudgeCore={})),function(e){class t{static get(e){let i=e.name,r=t.depot[i];return r&&r.length>0?r.pop():new e}static store(e){let i=e.constructor.name,r=t.depot[i]||[];r.push(e),t.depot[i]=r}static dump(e){let i=e.name;t.depot[i]=[]}static dumpAll(){t.depot={}}}t.depot={},e.Recycler=t}(FudgeCore||(FudgeCore={})),function(e){class t{static register(e){e.idResource||(e.idResource=t.generateId(e)),t.resources[e.idResource]=e}static generateId(e){let i;do{i=e.constructor.name+"|"+(new Date).toISOString()+"|"+Math.random().toPrecision(5).substr(2,5)}while(t.resources[i]);return i}static isResource(e){return Reflect.has(e,"idResource")}static get(i){let r=t.resources[i];if(!r){let n=t.serialization[i];if(!n)return e.Debug.error("Resource not found",i),null;r=t.deserializeResource(n)}return r}static registerNodeAsResource(i,r=!0){let n=i.serialize(),s=new e.NodeResource("NodeResource");if(s.deserialize(n),t.register(s),r&&i.getParent()){let t=new e.NodeResourceInstance(s);i.getParent().replaceChild(i,t)}return s}static serialize(){let i={};for(let r in t.resources){let n=t.resources[r];r!=n.idResource&&e.Debug.error("Resource-id mismatch",n),i[r]=e.Serializer.serialize(n)}return i}static deserialize(e){t.serialization=e,t.resources={};for(let i in e){let r=e[i],n=t.deserializeResource(r);n&&(t.resources[i]=n)}return t.resources}static deserializeResource(t){return e.Serializer.deserialize(t)}}t.resources={},t.serialization=null,e.ResourceManager=t}(FudgeCore||(FudgeCore={})),function(e){let t;!function(e){e[e.TOPLEFT=0]="TOPLEFT",e[e.TOPCENTER=1]="TOPCENTER",e[e.TOPRIGHT=2]="TOPRIGHT",e[e.CENTERLEFT=16]="CENTERLEFT",e[e.CENTER=17]="CENTER",e[e.CENTERRIGHT=18]="CENTERRIGHT",e[e.BOTTOMLEFT=32]="BOTTOMLEFT",e[e.BOTTOMCENTER=33]="BOTTOMCENTER",e[e.BOTTOMRIGHT=34]="BOTTOMRIGHT"}(t=e.ORIGIN2D||(e.ORIGIN2D={}));class i extends e.Mutable{constructor(i=0,r=0,n=1,s=1,a=t.TOPLEFT){super(),this.position=e.Recycler.get(e.Vector2),this.size=e.Recycler.get(e.Vector2),this.setPositionAndSize(i,r,n,s,a)}static GET(r=0,n=0,s=1,a=1,o=t.TOPLEFT){let c=e.Recycler.get(i);return c.setPositionAndSize(r,n,s,a),c}setPositionAndSize(e=0,i=0,r=1,n=1,s=t.TOPLEFT){switch(this.size.set(r,n),3&s){case 0:this.position.x=e;break;case 1:this.position.x=e-r/2;break;case 2:this.position.x=e-r}switch(48&s){case 0:this.position.y=i;break;case 16:this.position.y=i-n/2;break;case 32:this.position.y=i-n}}pointToRect(e,t){let i=e.copy;return i.subtract(this.position),i.x*=t.width/this.width,i.y*=t.height/this.height,i.add(t.position),i}get x(){return this.position.x}get y(){return this.position.y}get width(){return this.size.x}get height(){return this.size.y}get left(){return this.size.x>0?this.position.x:this.position.x+this.size.x}get top(){return this.size.y>0?this.position.y:this.position.y+this.size.y}get right(){return this.size.x>0?this.position.x+this.size.x:this.position.x}get bottom(){return this.size.y>0?this.position.y+this.size.y:this.position.y}set x(e){this.position.x=e}set y(e){this.position.y=e}set width(e){this.position.x=e}set height(e){this.position.y=e}set left(e){this.size.x=this.right-e,this.position.x=e}set top(e){this.size.y=this.bottom-e,this.position.y=e}set right(e){this.size.x=this.position.x+e}set bottom(e){this.size.y=this.position.y+e}get copy(){return i.GET(this.x,this.y,this.width,this.height)}isInside(e){return e.x>=this.left&&e.x<=this.right&&e.y>=this.top&&e.y<=this.bottom}collides(e){return!(this.left>e.right)&&(!(this.right<e.left)&&(!(this.top>e.bottom)&&!(this.bottom<e.top)))}toString(){let e=`ƒ.Rectangle(position:${this.position.toString()}, size:${this.size.toString()}`;return e+=`, left:${this.left.toPrecision(5)}, top:${this.top.toPrecision(5)}, right:${this.right.toPrecision(5)}, bottom:${this.bottom.toPrecision(5)}`,e}reduceMutator(e){}}e.Rectangle=i}(FudgeCore||(FudgeCore={})),function(e){class t extends e.EventTargetƒ{constructor(){super(...arguments),this.name="Viewport",this.camera=null,this.frameClientToCanvas=new e.FramingScaled,this.frameCanvasToDestination=new e.FramingComplex,this.frameDestinationToSource=new e.FramingScaled,this.frameSourceToRender=new e.FramingScaled,this.adjustingFrames=!0,this.adjustingCamera=!0,this.lights=null,this.branch=null,this.crc2=null,this.canvas=null,this.pickBuffers=[],this.hndDragDropEvent=t=>{let i=t;switch(i.type){case"dragover":case"drop":i.preventDefault(),i.dataTransfer.effectAllowed="none";break;case"dragstart":i.dataTransfer.setData("text","Hallo"),i.dataTransfer.setDragImage(new Image,0,0)}let r=new e.EventDragDrop("ƒ"+t.type,i);this.addCanvasPosition(r),this.dispatchEvent(r)},this.hndPointerEvent=t=>{let i=new e.EventPointer("ƒ"+t.type,t);this.addCanvasPosition(i),this.dispatchEvent(i)},this.hndKeyboardEvent=t=>{if(!this.hasFocus)return;let i=new e.EventKeyboard("ƒ"+t.type,t);this.dispatchEvent(i)},this.hndWheelEvent=t=>{let i=new e.EventWheel("ƒ"+t.type,t);this.dispatchEvent(i)}}initialize(t,i,r,n){this.name=t,this.camera=r,this.canvas=n,this.crc2=n.getContext("2d"),this.rectSource=e.RenderManager.getCanvasRect(),this.rectDestination=this.getClientRectangle(),this.setBranch(i)}getContext(){return this.crc2}getCanvasRectangle(){return e.Rectangle.GET(0,0,this.canvas.width,this.canvas.height)}getClientRectangle(){return e.Rectangle.GET(0,0,this.canvas.clientWidth,this.canvas.clientHeight)}setBranch(e){this.branch&&(this.branch.removeEventListener("componentAdd",this.hndComponentEvent),this.branch.removeEventListener("componentRemove",this.hndComponentEvent)),this.branch=e,this.branch&&(this.collectLights(),this.branch.addEventListener("componentAdd",this.hndComponentEvent),this.branch.addEventListener("componentRemove",this.hndComponentEvent))}showSceneGraph(){let t="SceneGraph for this viewport:";t+="\n \n",t+=this.branch.name,e.Debug.log(t+"   => ROOTNODE"+this.createSceneGraph(this.branch))}draw(){e.RenderManager.resetFrameBuffer(),this.camera.isActive&&(this.adjustingFrames&&this.adjustFrames(),this.adjustingCamera&&this.adjustCamera(),e.RenderManager.clear(this.camera.backgroundColor),e.RenderManager.addBranch(this.branch)&&e.RenderManager.update(),e.RenderManager.setLights(this.lights),e.RenderManager.drawBranch(this.branch,this.camera),this.crc2.imageSmoothingEnabled=!1,this.crc2.drawImage(e.RenderManager.getCanvas(),this.rectSource.x,this.rectSource.y,this.rectSource.width,this.rectSource.height,this.rectDestination.x,this.rectDestination.y,this.rectDestination.width,this.rectDestination.height))}createPickBuffers(){this.adjustingFrames&&this.adjustFrames(),this.adjustingCamera&&this.adjustCamera(),e.RenderManager.addBranch(this.branch)&&e.RenderManager.update(),this.pickBuffers=e.RenderManager.drawBranchForRayCast(this.branch,this.camera),e.Debug.log(this.pickBuffers[0].frameBuffer)}pickNodeAt(t){let i=e.RenderManager.pickNodeAt(t,this.pickBuffers,this.rectSource);return i.sort((e,t)=>t.zBuffer>0?e.zBuffer>0?e.zBuffer-t.zBuffer:1:-1),i}adjustFrames(){let t=this.getClientRectangle(),i=this.frameClientToCanvas.getRect(t);this.canvas.width=i.width,this.canvas.height=i.height,this.rectDestination=this.frameCanvasToDestination.getRect(i),this.rectSource=this.frameDestinationToSource.getRect(this.rectDestination),this.rectSource.x=this.rectSource.y=0;let r=this.frameSourceToRender.getRect(this.rectSource);e.RenderManager.setViewportRectangle(r),e.RenderManager.setCanvasSize(r.width,r.height)}adjustCamera(){let t=e.RenderManager.getViewportRectangle();this.camera.projectCentral(t.width/t.height,this.camera.getFieldOfView())}pointClientToSource(e){let t=this.frameClientToCanvas.getPoint(e,this.getClientRectangle());return t=this.frameCanvasToDestination.getPoint(t,this.getCanvasRectangle()),t=this.frameDestinationToSource.getPoint(t,this.rectSource),t}pointSourceToRender(e){let t=this.camera.getProjectionRectangle();return this.frameSourceToRender.getPoint(e,t)}pointClientToRender(e){let t=this.pointClientToSource(e);return t=this.pointSourceToRender(t),t}pointClientToProjection(t){let i=this.pointClientToRender(t),r=this.frameSourceToRender.getRect(this.rectSource),n=this.camera.getProjectionRectangle(),s=new e.Vector2(n.width*i.x/r.width,n.height*i.y/r.height);return s.subtract(new e.Vector2(n.width/2,n.height/2)),s.y*=-1,s}pointClipToClient(t){return e.RenderManager.rectClip.pointToRect(t,this.rectDestination)}pointClipToCanvas(t){return e.RenderManager.rectClip.pointToRect(t,this.getCanvasRectangle())}pointClientToScreen(t){return new e.Vector2(this.canvas.offsetLeft+t.x,this.canvas.offsetTop+t.y)}get hasFocus(){return t.focus==this}setFocus(e){if(e){if(t.focus==this)return;t.focus&&t.focus.dispatchEvent(new Event("focusout")),t.focus=this,this.dispatchEvent(new Event("focusin"))}else{if(t.focus!=this)return;this.dispatchEvent(new Event("focusout")),t.focus=null}}activatePointerEvent(e,t){this.activateEvent(this.canvas,e,this.hndPointerEvent,t)}activateKeyboardEvent(e,t){this.activateEvent(this.canvas.ownerDocument,e,this.hndKeyboardEvent,t)}activateDragDropEvent(e,t){"ƒdragstart"==e&&(this.canvas.draggable=t),this.activateEvent(this.canvas,e,this.hndDragDropEvent,t)}activateWheelEvent(e,t){this.activateEvent(this.canvas,e,this.hndWheelEvent,t)}addCanvasPosition(e){e.canvasX=this.canvas.width*e.pointerX/e.clientRect.width,e.canvasY=this.canvas.height*e.pointerY/e.clientRect.height}activateEvent(e,t,i,r){t=t.slice(1),r?e.addEventListener(t,i):e.removeEventListener(t,i)}hndComponentEvent(t){e.Debug.log(t)}collectLights(){this.lights=new Map;for(let t of this.branch.branch){let i=t.getComponents(e.ComponentLight);for(let e of i){let t=e.light.getType(),i=this.lights.get(t);i||(i=[],this.lights.set(t,i)),i.push(e)}}}createSceneGraph(e){let t="";for(let i in e.getChildren()){let r=e.getChildren()[i];t+="\n";let n=r;for(n.getParent()&&n.getParent().getParent()&&(t+="|");n.getParent()&&n.getParent().getParent();)t+="   ",n=n.getParent();t+="'--",t+=r.name,t+=this.createSceneGraph(r)}return t}}e.Viewport=t}(FudgeCore||(FudgeCore={})),function(e){class t extends DragEvent{constructor(e,t){super(e,t);let i=t.target;this.clientRect=i.getClientRects()[0],this.pointerX=t.clientX-this.clientRect.left,this.pointerY=t.clientY-this.clientRect.top}}e.EventDragDrop=t}(FudgeCore||(FudgeCore={})),function(e){class t extends KeyboardEvent{constructor(e,t){super(e,t)}}let i;e.EventKeyboard=t,function(e){e.A="KeyA",e.B="KeyB",e.C="KeyC",e.D="KeyD",e.E="KeyE",e.F="KeyF",e.G="KeyG",e.H="KeyH",e.I="KeyI",e.J="KeyJ",e.K="KeyK",e.L="KeyL",e.M="KeyM",e.N="KeyN",e.O="KeyO",e.P="KeyP",e.Q="KeyQ",e.R="KeyR",e.S="KeyS",e.T="KeyT",e.U="KeyU",e.V="KeyV",e.W="KeyW",e.X="KeyX",e.Y="KeyY",e.Z="KeyZ",e.ESC="Escape",e.ZERO="Digit0",e.ONE="Digit1",e.TWO="Digit2",e.THREE="Digit3",e.FOUR="Digit4",e.FIVE="Digit5",e.SIX="Digit6",e.SEVEN="Digit7",e.EIGHT="Digit8",e.NINE="Digit9",e.MINUS="Minus",e.EQUAL="Equal",e.BACKSPACE="Backspace",e.TABULATOR="Tab",e.BRACKET_LEFT="BracketLeft",e.BRACKET_RIGHT="BracketRight",e.ENTER="Enter",e.CTRL_LEFT="ControlLeft",e.SEMICOLON="Semicolon",e.QUOTE="Quote",e.BACK_QUOTE="Backquote",e.SHIFT_LEFT="ShiftLeft",e.BACKSLASH="Backslash",e.COMMA="Comma",e.PERIOD="Period",e.SLASH="Slash",e.SHIFT_RIGHT="ShiftRight",e.NUMPAD_MULTIPLY="NumpadMultiply",e.ALT_LEFT="AltLeft",e.SPACE="Space",e.CAPS_LOCK="CapsLock",e.F1="F1",e.F2="F2",e.F3="F3",e.F4="F4",e.F5="F5",e.F6="F6",e.F7="F7",e.F8="F8",e.F9="F9",e.F10="F10",e.PAUSE="Pause",e.SCROLL_LOCK="ScrollLock",e.NUMPAD7="Numpad7",e.NUMPAD8="Numpad8",e.NUMPAD9="Numpad9",e.NUMPAD_SUBTRACT="NumpadSubtract",e.NUMPAD4="Numpad4",e.NUMPAD5="Numpad5",e.NUMPAD6="Numpad6",e.NUMPAD_ADD="NumpadAdd",e.NUMPAD1="Numpad1",e.NUMPAD2="Numpad2",e.NUMPAD3="Numpad3",e.NUMPAD0="Numpad0",e.NUMPAD_DECIMAL="NumpadDecimal",e.PRINT_SCREEN="PrintScreen",e.INTL_BACK_SLASH="IntlBackSlash",e.F11="F11",e.F12="F12",e.NUMPAD_EQUAL="NumpadEqual",e.F13="F13",e.F14="F14",e.F15="F15",e.F16="F16",e.F17="F17",e.F18="F18",e.F19="F19",e.F20="F20",e.F21="F21",e.F22="F22",e.F23="F23",e.F24="F24",e.KANA_MODE="KanaMode",e.LANG2="Lang2",e.LANG1="Lang1",e.INTL_RO="IntlRo",e.CONVERT="Convert",e.NON_CONVERT="NonConvert",e.INTL_YEN="IntlYen",e.NUMPAD_COMMA="NumpadComma",e.UNDO="Undo",e.PASTE="Paste",e.MEDIA_TRACK_PREVIOUS="MediaTrackPrevious",e.CUT="Cut",e.COPY="Copy",e.MEDIA_TRACK_NEXT="MediaTrackNext",e.NUMPAD_ENTER="NumpadEnter",e.CTRL_RIGHT="ControlRight",e.AUDIO_VOLUME_MUTE="AudioVolumeMute",e.LAUNCH_APP2="LaunchApp2",e.MEDIA_PLAY_PAUSE="MediaPlayPause",e.MEDIA_STOP="MediaStop",e.EJECT="Eject",e.AUDIO_VOLUME_DOWN="AudioVolumeDown",e.VOLUME_DOWN="VolumeDown",e.AUDIO_VOLUME_UP="AudioVolumeUp",e.VOLUME_UP="VolumeUp",e.BROWSER_HOME="BrowserHome",e.NUMPAD_DIVIDE="NumpadDivide",e.ALT_RIGHT="AltRight",e.HELP="Help",e.NUM_LOCK="NumLock",e.HOME="Home",e.ARROW_UP="ArrowUp",e.ARROW_RIGHT="ArrowRight",e.ARROW_DOWN="ArrowDown",e.ARROW_LEFT="ArrowLeft",e.END="End",e.PAGE_UP="PageUp",e.PAGE_DOWN="PageDown",e.INSERT="Insert",e.DELETE="Delete",e.META_LEFT="Meta_Left",e.OS_LEFT="OSLeft",e.META_RIGHT="MetaRight",e.OS_RIGHT="OSRight",e.CONTEXT_MENU="ContextMenu",e.POWER="Power",e.BROWSER_SEARCH="BrowserSearch",e.BROWSER_FAVORITES="BrowserFavorites",e.BROWSER_REFRESH="BrowserRefresh",e.BROWSER_STOP="BrowserStop",e.BROWSER_FORWARD="BrowserForward",e.BROWSER_BACK="BrowserBack",e.LAUNCH_APP1="LaunchApp1",e.LAUNCH_MAIL="LaunchMail",e.LAUNCH_MEDIA_PLAYER="LaunchMediaPlayer",e.FN="Fn",e.AGAIN="Again",e.PROPS="Props",e.SELECT="Select",e.OPEN="Open",e.FIND="Find",e.WAKE_UP="WakeUp",e.NUMPAD_PARENT_LEFT="NumpadParentLeft",e.NUMPAD_PARENT_RIGHT="NumpadParentRight",e.SLEEP="Sleep"}(i=e.KEYBOARD_CODE||(e.KEYBOARD_CODE={}))}(FudgeCore||(FudgeCore={})),function(e){class t extends PointerEvent{constructor(e,t){super(e,t);let i=t.target;this.clientRect=i.getClientRects()[0],this.pointerX=t.clientX-this.clientRect.left,this.pointerY=t.clientY-this.clientRect.top}}e.EventPointer=t}(FudgeCore||(FudgeCore={})),function(e){e.EventTimer=class{constructor(e,...t){this.type="ƒlapse",this.firstCall=!0,this.lastCall=!1,this.target=e,this.arguments=t,this.firstCall=!0}}}(FudgeCore||(FudgeCore={})),function(e){class t extends WheelEvent{constructor(e,t){super(e,t)}}e.EventWheel=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{reduceMutator(e){}}e.Framing=t;e.FramingFixed=class extends t{constructor(e=300,t=150){super(),this.width=300,this.height=150,this.setSize(e,t)}setSize(e,t){this.width=e,this.height=t}getPoint(t,i){return new e.Vector2(this.width*(t.x-i.x)/i.width,this.height*(t.y-i.y)/i.height)}getPointInverse(t,i){return new e.Vector2(t.x*i.width/this.width+i.x,t.y*i.height/this.height+i.y)}getRect(t){return e.Rectangle.GET(0,0,this.width,this.height)}};e.FramingScaled=class extends t{constructor(){super(...arguments),this.normWidth=1,this.normHeight=1}setScale(e,t){this.normWidth=e,this.normHeight=t}getPoint(t,i){return new e.Vector2(this.normWidth*(t.x-i.x),this.normHeight*(t.y-i.y))}getPointInverse(t,i){return new e.Vector2(t.x/this.normWidth+i.x,t.y/this.normHeight+i.y)}getRect(t){return e.Rectangle.GET(0,0,this.normWidth*t.width,this.normHeight*t.height)}};e.FramingComplex=class extends t{constructor(){super(...arguments),this.margin={left:0,top:0,right:0,bottom:0},this.padding={left:0,top:0,right:0,bottom:0}}getPoint(t,i){return new e.Vector2(t.x-this.padding.left-this.margin.left*i.width,t.y-this.padding.top-this.margin.top*i.height)}getPointInverse(t,i){return new e.Vector2(t.x+this.padding.left+this.margin.left*i.width,t.y+this.padding.top+this.margin.top*i.height)}getRect(t){if(!t)return null;let i=t.x+this.margin.left*t.width+this.padding.left,r=t.y+this.margin.top*t.height+this.padding.top,n=t.x+(1-this.margin.right)*t.width-this.padding.right,s=t.y+(1-this.margin.bottom)*t.height-this.padding.bottom;return e.Rectangle.GET(i,r,n-i,s-r)}getMutator(){return{margin:this.margin,padding:this.padding}}}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(){super(),this.data=new Float32Array(3),this.mutator=null,this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.resetCache()}get translation(){return this.vectors.translation||(this.vectors.translation=new e.Vector2(this.data[6],this.data[7])),this.vectors.translation.copy}set translation(e){this.data.set(e.get(),12),this.vectors.translation=e,this.mutator=null}get rotation(){return this.vectors.rotation||(this.vectors.rotation=this.getEulerAngles()),this.vectors.rotation}set rotation(e){this.mutate({rotation:e}),this.resetCache()}get scaling(){return this.vectors.scaling||(this.vectors.scaling=new e.Vector2(Math.hypot(this.data[0],this.data[1]),Math.hypot(this.data[3],this.data[4]))),this.vectors.scaling.copy}set scaling(e){this.mutate({scaling:e}),this.resetCache()}static PROJECTION(e,i){let r=new t;return r.data.set([2/e,0,0,0,-2/i,0,-1,1,1]),r}static get IDENTITY(){const i=e.Recycler.get(t);return i.data.set([1,0,0,0,1,0,0,0,1]),i}static TRANSLATION(i){const r=e.Recycler.get(t);return r.data.set([1,0,0,0,1,0,i.x,i.y,1]),r}static ROTATION(i){const r=e.Recycler.get(t);let n=i*Math.PI/180,s=Math.sin(n),a=Math.cos(n);return r.data.set([a,s,0,-s,a,0,0,0,1]),r}static SCALING(i){const r=e.Recycler.get(t);return r.data.set([i.x,0,0,0,i.y,0,0,0,1]),r}static MULTIPLICATION(e,i){let r=e.data[0],n=e.data[1],s=e.data[2],a=e.data[3],o=e.data[4],c=e.data[5],l=e.data[6],u=e.data[7],h=e.data[8],d=i.data[0],g=i.data[1],m=i.data[2],p=i.data[3],f=i.data[4],R=i.data[5],E=i.data[6],C=i.data[7],T=i.data[8],A=new t;return A.data.set([d*r+g*a+m*l,d*n+g*o+m*u,d*s+g*c+m*h,p*r+f*a+R*l,p*n+f*o+R*u,p*s+f*c+R*h,E*r+C*a+T*l,E*n+C*o+T*u,E*s+C*c+T*h]),A}translate(i){const r=t.MULTIPLICATION(this,t.TRANSLATION(i));this.set(r),e.Recycler.store(r)}translateX(e){this.data[6]+=e,this.mutator=null,this.vectors.translation=null}translateY(e){this.data[7]+=e,this.mutator=null,this.vectors.translation=null}scale(i){const r=t.MULTIPLICATION(this,t.SCALING(i));this.set(r),e.Recycler.store(r)}scaleX(t){this.scale(new e.Vector2(t,1))}scaleY(t){this.scale(new e.Vector2(1,t))}rotate(i){const r=t.MULTIPLICATION(this,t.ROTATION(i));this.set(r),e.Recycler.store(r)}multiply(e){this.set(t.MULTIPLICATION(this,e)),this.mutator=null}getEulerAngles(){let e,t=this.scaling,i=this.data[0]/t.x,r=this.data[1]/t.x,n=this.data[3]/t.y,s=this.data[4]/t.y,a=Math.atan2(-n,s),o=Math.atan2(i,r);return e=Math.hypot(i,r)>1e-6?a:o,e*=180/Math.PI,e}set(e){this.data.set(e.data),this.resetCache()}toString(){return`ƒ.Matrix3x3(translation: ${this.translation.toString()}, rotation: ${this.rotation.toString()}, scaling: ${this.scaling.toString()}`}get(){return new Float32Array(this.data)}serialize(){return this.getMutator()}deserialize(e){return this.mutate(e),this}getMutator(){if(this.mutator)return this.mutator;let e={translation:this.translation.getMutator(),rotation:this.rotation,scaling:this.scaling.getMutator()};return this.mutator=e,e}mutate(i){let r=this.translation,n=this.rotation,s=this.scaling,a=i.translation,o=i.rotation,c=i.scaling,l={translation:r,rotation:n,scaling:s};a&&(l.translation=new e.Vector2(null!=a.x?a.x:r.x,null!=a.y?a.y:r.y)),l.rotation=null==o?n:o,c&&(l.scaling=new e.Vector2(null!=c.x?c.x:s.x,null!=c.y?c.y:s.y));let u=t.IDENTITY;l.translation&&u.translate(l.translation),l.rotation&&u.rotate(l.rotation),l.scaling&&u.scale(l.scaling),this.set(u),this.vectors=l}getMutatorAttributeTypes(e){let t={};return e.translation&&(t.translation="Vector2"),e.rotation&&(t.rotation="number"),e.scaling&&(t.scaling="Vector2"),t}reduceMutator(e){}resetCache(){this.vectors={translation:null,rotation:null,scaling:null},this.mutator=null}}e.Matrix3x3=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(){super(),this.data=new Float32Array(16),this.mutator=null,this.data.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.resetCache()}get translation(){return this.vectors.translation||(this.vectors.translation=new e.Vector3(this.data[12],this.data[13],this.data[14])),this.vectors.translation.copy}set translation(e){this.data.set(e.get(),12),this.vectors.translation=e.copy,this.mutator=null}get rotation(){return this.vectors.rotation||(this.vectors.rotation=this.getEulerAngles()),this.vectors.rotation.copy}set rotation(e){this.mutate({rotation:e}),this.resetCache()}get scaling(){return this.vectors.scaling||(this.vectors.scaling=new e.Vector3(Math.hypot(this.data[0],this.data[1],this.data[2]),Math.hypot(this.data[4],this.data[5],this.data[6]),Math.hypot(this.data[8],this.data[9],this.data[10]))),this.vectors.scaling.copy}set scaling(e){this.mutate({scaling:e}),this.resetCache()}static get IDENTITY(){const i=e.Recycler.get(t);return i.data.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),i}static MULTIPLICATION(i,r){let n=i.data,s=r.data;const a=e.Recycler.get(t);let o=n[0],c=n[1],l=n[2],u=n[3],h=n[4],d=n[5],g=n[6],m=n[7],p=n[8],f=n[9],R=n[10],E=n[11],C=n[12],T=n[13],A=n[14],F=n[15],y=s[0],v=s[1],x=s[2],S=s[3],L=s[4],b=s[5],M=s[6],O=s[7],I=s[8],w=s[9],D=s[10],P=s[11],N=s[12],_=s[13],G=s[14],B=s[15];return a.data.set([y*o+v*h+x*p+S*C,y*c+v*d+x*f+S*T,y*l+v*g+x*R+S*A,y*u+v*m+x*E+S*F,L*o+b*h+M*p+O*C,L*c+b*d+M*f+O*T,L*l+b*g+M*R+O*A,L*u+b*m+M*E+O*F,I*o+w*h+D*p+P*C,I*c+w*d+D*f+P*T,I*l+w*g+D*R+P*A,I*u+w*m+D*E+P*F,N*o+_*h+G*p+B*C,N*c+_*d+G*f+B*T,N*l+_*g+G*R+B*A,N*u+_*m+G*E+B*F]),a}static INVERSION(i){let r=i.data,n=r[0],s=r[1],a=r[2],o=r[3],c=r[4],l=r[5],u=r[6],h=r[7],d=r[8],g=r[9],m=r[10],p=r[11],f=r[12],R=r[13],E=r[14],C=r[15],T=m*C,A=E*p,F=u*C,y=E*h,v=u*p,x=m*h,S=a*C,L=E*o,b=a*p,M=m*o,O=a*h,I=u*o,w=d*R,D=f*g,P=c*R,N=f*l,_=c*g,G=d*l,B=n*R,U=f*s,z=n*g,V=d*s,W=n*l,k=c*s,j=T*l+y*g+v*R-(A*l+F*g+x*R),Y=A*s+S*g+M*R-(T*s+L*g+b*R),H=F*s+L*l+O*R-(y*s+S*l+I*R),K=x*s+b*l+I*g-(v*s+M*l+O*g),X=1/(n*j+c*Y+d*H+f*K);const q=e.Recycler.get(t);return q.data.set([X*j,X*Y,X*H,X*K,X*(A*c+F*d+x*f-(T*c+y*d+v*f)),X*(T*n+L*d+b*f-(A*n+S*d+M*f)),X*(y*n+S*c+I*f-(F*n+L*c+O*f)),X*(v*n+M*c+O*d-(x*n+b*c+I*d)),X*(w*h+N*p+_*C-(D*h+P*p+G*C)),X*(D*o+B*p+V*C-(w*o+U*p+z*C)),X*(P*o+U*h+W*C-(N*o+B*h+k*C)),X*(G*o+z*h+k*p-(_*o+V*h+W*p)),X*(P*m+G*E+D*u-(_*E+w*u+N*m)),X*(z*E+w*a+U*m-(B*m+V*E+D*a)),X*(B*u+k*E+N*a-(W*E+P*a+U*u)),X*(W*m+_*a+V*u-(z*u+k*m+G*a))]),q}static LOOK_AT(i,r,n=e.Vector3.Y()){const s=e.Recycler.get(t);let a=e.Vector3.DIFFERENCE(i,r);a.normalize();let o=e.Vector3.NORMALIZATION(e.Vector3.CROSS(n,a)),c=e.Vector3.NORMALIZATION(e.Vector3.CROSS(a,o));return s.data.set([o.x,o.y,o.z,0,c.x,c.y,c.z,0,a.x,a.y,a.z,0,i.x,i.y,i.z,1]),s}static TRANSLATION(i){const r=e.Recycler.get(t);return r.data.set([1,0,0,0,0,1,0,0,0,0,1,0,i.x,i.y,i.z,1]),r}static ROTATION_X(i){const r=e.Recycler.get(t);let n=i*Math.PI/180,s=Math.sin(n),a=Math.cos(n);return r.data.set([1,0,0,0,0,a,s,0,0,-s,a,0,0,0,0,1]),r}static ROTATION_Y(i){let r=e.Recycler.get(t),n=i*Math.PI/180,s=Math.sin(n),a=Math.cos(n);return r.data.set([a,0,-s,0,0,1,0,0,s,0,a,0,0,0,0,1]),r}static ROTATION_Z(i){const r=e.Recycler.get(t);let n=i*Math.PI/180,s=Math.sin(n),a=Math.cos(n);return r.data.set([a,s,0,0,-s,a,0,0,0,0,1,0,0,0,0,1]),r}static SCALING(i){const r=e.Recycler.get(t);return r.data.set([i.x,0,0,0,0,i.y,0,0,0,0,i.z,0,0,0,0,1]),r}static PROJECTION_CENTRAL(i,r,n,s,a){let o=r*Math.PI/180,c=Math.tan(.5*(Math.PI-o)),l=1/(n-s);const u=e.Recycler.get(t);return u.data.set([c,0,0,0,0,c,0,0,0,0,(n+s)*l,-1,0,0,n*s*l*2,0]),a==e.FIELD_OF_VIEW.DIAGONAL?(i=Math.sqrt(i),u.data[0]=c/i,u.data[5]=c*i):a==e.FIELD_OF_VIEW.VERTICAL?u.data[0]=c/i:u.data[5]=c*i,u}static PROJECTION_ORTHOGRAPHIC(i,r,n,s,a=-400,o=400){const c=e.Recycler.get(t);return c.data.set([2/(r-i),0,0,0,0,2/(s-n),0,0,0,0,2/(a-o),0,(i+r)/(i-r),(n+s)/(n-s),(a+o)/(a-o),1]),c}rotate(e,t=!1){this.rotateZ(e.z,t),this.rotateY(e.y,t),this.rotateX(e.x,t)}rotateX(i,r=!1){let n=t.ROTATION_X(i);this.multiply(n,r),e.Recycler.store(n)}rotateY(i,r=!1){let n=t.ROTATION_Y(i);this.multiply(n,r),e.Recycler.store(n)}rotateZ(i,r=!1){let n=t.ROTATION_Z(i);this.multiply(n,r),e.Recycler.store(n)}lookAt(i,r=e.Vector3.Y()){const n=t.LOOK_AT(this.translation,i);this.set(n),e.Recycler.store(n)}translate(i){const r=t.MULTIPLICATION(this,t.TRANSLATION(i));this.set(r),e.Recycler.store(r)}translateX(e){this.data[12]+=e,this.mutator=null,this.vectors.translation=null}translateY(e){this.data[13]+=e,this.mutator=null,this.vectors.translation=null}translateZ(e){this.data[14]+=e,this.mutator=null,this.vectors.translation=null}scale(i){const r=t.MULTIPLICATION(this,t.SCALING(i));this.set(r),e.Recycler.store(r)}scaleX(t){this.scale(new e.Vector3(t,1,1))}scaleY(t){this.scale(new e.Vector3(1,t,1))}scaleZ(t){this.scale(new e.Vector3(1,1,t))}multiply(i,r=!1){const n=r?t.MULTIPLICATION(i,this):t.MULTIPLICATION(this,i);this.set(n),e.Recycler.store(n)}getEulerAngles(){let t,i,r,n,s,a,o=this.scaling,c=this.data[0]/o.x,l=this.data[1]/o.x,u=this.data[2]/o.x,h=this.data[6]/o.y,d=this.data[10]/o.z,g=Math.hypot(c,l);g<1e-6?(t=Math.atan2(-this.data[9]/o.z,this.data[5]/o.y),i=Math.atan2(-this.data[2]/o.x,g),r=0):(t=Math.atan2(h,d),i=Math.atan2(-u,g),r=Math.atan2(l,c),n=Math.atan2(-h,-d),s=Math.atan2(-u,-g),a=Math.atan2(-l,-c),Math.abs(n)+Math.abs(s)+Math.abs(a)<Math.abs(t)+Math.abs(i)+Math.abs(r)&&(t=n,i=s,r=a));let m=new e.Vector3(t,i,r);return m.scale(180/Math.PI),m}set(e){this.data.set(e.data),this.resetCache()}toString(){return`ƒ.Matrix4x4(translation: ${this.translation.toString()}, rotation: ${this.rotation.toString()}, scaling: ${this.scaling.toString()}`}get(){return new Float32Array(this.data)}serialize(){return this.getMutator()}deserialize(e){return this.mutate(e),this}getMutator(){if(this.mutator)return this.mutator;let e={translation:this.translation.getMutator(),rotation:this.rotation.getMutator(),scaling:this.scaling.getMutator()};return this.mutator=e,e}mutate(i){let r=this.translation,n=this.rotation,s=this.scaling,a=i.translation,o=i.rotation,c=i.scaling,l={translation:r,rotation:n,scaling:s};a&&(l.translation=new e.Vector3(null!=a.x?a.x:r.x,null!=a.y?a.y:r.y,null!=a.z?a.z:r.z)),o&&(l.rotation=new e.Vector3(null!=o.x?o.x:n.x,null!=o.y?o.y:n.y,null!=o.z?o.z:n.z)),c&&(l.scaling=new e.Vector3(null!=c.x?c.x:s.x,null!=c.y?c.y:s.y,null!=c.z?c.z:s.z));let u=t.IDENTITY;l.translation&&u.translate(l.translation),l.rotation&&(u.rotateZ(l.rotation.z),u.rotateY(l.rotation.y),u.rotateX(l.rotation.x)),l.scaling&&u.scale(l.scaling),this.set(u),this.vectors=l}getMutatorAttributeTypes(e){let t={};return e.translation&&(t.translation="Vector3"),e.rotation&&(t.rotation="Vector3"),e.scaling&&(t.scaling="Vector3"),t}reduceMutator(e){}resetCache(){this.vectors={translation:null,rotation:null,scaling:null},this.mutator=null}}e.Matrix4x4=t}(FudgeCore||(FudgeCore={})),function(e){class t{constructor(e=!1,i=Math.random()){this.generate=Math.random,e&&(this.generate=t.createGenerator(i))}static createGenerator(e){return Math.random}getNorm(){return this.generate()}getRange(e,t){return e+this.generate()*(t-e)}getRangeFloored(e,t){return Math.floor(this.getRange(e,t))}getBoolean(){return this.generate()<.5}getSign(){return this.getBoolean()?1:-1}getIndex(e){return e.length>0?this.getRangeFloored(0,e.length):-1}splice(e){return e.splice(this.getIndex(e),1)[0]}getKey(e){let t=Array.from(e.keys());return t[this.getIndex(t)]}getPropertyName(e){let t=Object.getOwnPropertyNames(e);return t[this.getIndex(t)]}getPropertySymbol(e){let t=Object.getOwnPropertySymbols(e);return t[this.getIndex(t)]}}t.default=new t,e.Random=t,e.random=new t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(e=0,t=0){super(),this.data=new Float32Array([e,t])}get x(){return this.data[0]}get y(){return this.data[1]}set x(e){this.data[0]=e}set y(e){this.data[1]=e}get magnitude(){return Math.hypot(...this.data)}get magnitudeSquared(){return t.DOT(this,this)}static ZERO(){return new t}static ONE(e=1){return new t(e,e)}static Y(e=1){return new t(0,e)}static X(e=1){return new t(e,0)}static TRANSFORMATION(e,i,r=!0){let n=new t,s=i.get(),[a,o]=e.get();return n.x=s[0]*a+s[3]*o,n.y=s[1]*a+s[4]*o,r&&n.add(i.translation),n}static NORMALIZATION(e,i=1){let r=t.ZERO();try{let[t,n]=e.data,s=i/Math.hypot(t,n);r.data=new Float32Array([e.x*s,e.y*s])}catch(e){console.warn(e)}return r}static SCALE(e,i){return new t(e.x*i,e.y*i)}static SUM(...e){let i=new t;for(let t of e)i.data=new Float32Array([i.x+t.x,i.y+t.y]);return i}static DIFFERENCE(e,i){let r=new t;return r.data=new Float32Array([e.x-i.x,e.y-i.y]),r}static DOT(e,t){return e.x*t.x+e.y*t.y}static CROSSPRODUCT(e,t){return e.x*t.y-e.y*t.x}static ORTHOGONAL(e,i=!1){return i?new t(e.y,-e.x):new t(-e.y,e.x)}equals(e,t=Number.EPSILON){return!(Math.abs(this.x-e.x)>t)&&!(Math.abs(this.y-e.y)>t)}add(e){this.data=new t(e.x+this.x,e.y+this.y).data}subtract(e){this.data=new t(this.x-e.x,this.y-e.y).data}scale(e){this.data=new t(e*this.x,e*this.y).data}normalize(e=1){this.data=t.NORMALIZATION(this,e).data}set(e=0,t=0){this.data=new Float32Array([e,t])}get(){return new Float32Array(this.data)}get copy(){return new t(this.x,this.y)}transform(e,i=!0){this.data=t.TRANSFORMATION(this,e,i).data}toVector3(){return new e.Vector3(this.x,this.y,0)}toString(){return`(${this.x.toPrecision(5)}, ${this.y.toPrecision(5)})`}getMutator(){return{x:this.data[0],y:this.data[1]}}reduceMutator(e){}}e.Vector2=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{constructor(e=0,t=0,i=0){super(),this.data=new Float32Array([e,t,i])}get x(){return this.data[0]}get y(){return this.data[1]}get z(){return this.data[2]}set x(e){this.data[0]=e}set y(e){this.data[1]=e}set z(e){this.data[2]=e}get magnitude(){return Math.hypot(...this.data)}get magnitudeSquared(){return t.DOT(this,this)}static X(e=1){return new t(e,0,0)}static Y(e=1){return new t(0,e,0)}static Z(e=1){return new t(0,0,e)}static ZERO(){return new t(0,0,0)}static ONE(e=1){return new t(e,e,e)}static TRANSFORMATION(e,i,r=!0){let n=new t,s=i.get(),[a,o,c]=e.get();return n.x=s[0]*a+s[4]*o+s[8]*c,n.y=s[1]*a+s[5]*o+s[9]*c,n.z=s[2]*a+s[6]*o+s[10]*c,r&&n.add(i.translation),n}static NORMALIZATION(i,r=1){let n=t.ZERO();try{let e=r/i.magnitude;n.data=new Float32Array([i.x*e,i.y*e,i.z*e])}catch(t){e.Debug.warn(t)}return n}static SUM(...e){let i=new t;for(let t of e)i.data=new Float32Array([i.x+t.x,i.y+t.y,i.z+t.z]);return i}static DIFFERENCE(e,i){let r=new t;return r.data=new Float32Array([e.x-i.x,e.y-i.y,e.z-i.z]),r}static SCALE(e,i){let r=new t;return r.data=new Float32Array([e.x*i,e.y*i,e.z*i]),r}static CROSS(e,i){let r=new t;return r.data=new Float32Array([e.y*i.z-e.z*i.y,e.z*i.x-e.x*i.z,e.x*i.y-e.y*i.x]),r}static DOT(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static REFLECTION(e,i){let r=-t.DOT(e,i);return t.SUM(e,t.SCALE(i,2*r))}equals(e,t=Number.EPSILON){return!(Math.abs(this.x-e.x)>t)&&(!(Math.abs(this.y-e.y)>t)&&!(Math.abs(this.z-e.z)>t))}add(e){this.data=new t(e.x+this.x,e.y+this.y,e.z+this.z).data}subtract(e){this.data=new t(this.x-e.x,this.y-e.y,this.z-e.z).data}scale(e){this.data=new t(e*this.x,e*this.y,e*this.z).data}normalize(e=1){this.data=t.NORMALIZATION(this,e).data}set(e=0,t=0,i=0){this.data=new Float32Array([e,t,i])}get(){return new Float32Array(this.data)}get copy(){return new t(this.x,this.y,this.z)}transform(e,i=!0){this.data=t.TRANSFORMATION(this,e,i).data}toVector2(){return new e.Vector2(this.x,this.y)}reflect(i){const r=t.REFLECTION(this,i);this.set(r.x,r.y,r.z),e.Recycler.store(r)}toString(){return`(${this.x.toPrecision(5)}, ${this.y.toPrecision(5)}, ${this.z.toPrecision(5)})`}map(i){let r=e.Recycler.get(t);return r.data=this.data.map(i),r}getMutator(){return{x:this.data[0],y:this.data[1],z:this.data[2]}}reduceMutator(e){}}e.Vector3=t}(FudgeCore||(FudgeCore={})),function(e){class t{constructor(){this.idResource=void 0}static getBufferSpecification(){return{size:3,dataType:WebGL2RenderingContext.FLOAT,normalize:!1,stride:0,offset:0}}getVertexCount(){return this.vertices.length/t.getBufferSpecification().size}getIndexCount(){return this.indices.length}serialize(){return{idResource:this.idResource}}deserialize(e){return this.create(),this.idResource=e.idResource,this}}e.Mesh=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mesh{constructor(){super(),this.create()}create(){this.vertices=this.createVertices(),this.indices=this.createIndices(),this.textureUVs=this.createTextureUVs(),this.normalsFace=this.createFaceNormals()}createVertices(){let e=new Float32Array([-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1]);return e=e.map(e=>e/2),e}createIndices(){return new Uint16Array([1,2,0,2,3,0,2,6,3,6,7,3,6,5,7,5,4,7,13,9,12,9,8,12,12,8,11,15,12,11,13,14,9,14,10,9])}createTextureUVs(){return new Float32Array([0,0,0,1,1,1,1,0,3,0,3,1,2,1,2,0,1,0,1,1,1,2,1,-1,0,0,0,1,0,2,0,-1])}createFaceNormals(){return new Float32Array([0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,-1,0,0,0,0,0,1,0,-1,0,0,0,0,0,0,0,0,0,0,0])}}e.MeshCube=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mesh{constructor(){super(),this.create()}create(){this.vertices=this.createVertices(),this.indices=this.createIndices(),this.textureUVs=this.createTextureUVs(),this.normalsFace=this.createFaceNormals()}createVertices(){let e=new Float32Array([-1,0,1,1,0,1,1,0,-1,-1,0,-1,0,2,0,-1,0,1,1,0,1,1,0,-1,-1,0,-1]);return e=e.map(e=>e/2),e}createIndices(){return new Uint16Array([4,0,1,4,1,2,4,2,3,4,3,0,5,7,6,5,8,7])}createTextureUVs(){return new Float32Array([0,1,.5,1,1,1,.5,1,.5,0,0,0,1,0,1,1,0,1])}createFaceNormals(){let t=[],i=[];for(let t=0;t<this.vertices.length;t+=3)i.push(new e.Vector3(this.vertices[t],this.vertices[t+1],this.vertices[t+2]));for(let r=0;r<this.indices.length;r+=3){let n=[this.indices[r],this.indices[r+1],this.indices[r+2]],s=e.Vector3.DIFFERENCE(i[n[0]],i[n[1]]),a=e.Vector3.DIFFERENCE(i[n[0]],i[n[2]]),o=e.Vector3.NORMALIZATION(e.Vector3.CROSS(s,a)),c=3*n[2];t[c]=o.x,t[c+1]=o.y,t[c+2]=o.z}return t.push(0,0,0),new Float32Array(t)}}e.MeshPyramid=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mesh{constructor(){super(),this.create()}create(){this.vertices=this.createVertices(),this.indices=this.createIndices(),this.textureUVs=this.createTextureUVs(),this.normalsFace=this.createFaceNormals()}createVertices(){let e=new Float32Array([-1,1,0,-1,-1,0,1,-1,0,1,1,0]);return e=e.map(e=>e/2),e}createIndices(){return new Uint16Array([1,2,0,2,3,0])}createTextureUVs(){return new Float32Array([0,0,0,1,1,1,1,0])}createFaceNormals(){return new Float32Array([0,0,1,0,0,0,0,0,0,0,0,0])}}e.MeshQuad=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mesh{constructor(){super(),this.create()}create(){this.vertices=this.createVertices(),this.indices=this.createIndices(),this.textureUVs=this.createTextureUVs(),this.normalsFace=this.createFaceNormals()}createVertices(){let e=new Float32Array([-1,1,0,-1,-1,0,1,-1,0,1,1,0]);return e=e.map(e=>e/2),e}createIndices(){return new Uint16Array([1,2,0,2,3,0,0,3,1,3,2,1])}createTextureUVs(){return new Float32Array([0,0,0,1,1,1,1,0])}createFaceNormals(){return new Float32Array([0,0,1,0,0,-1,0,0,0,0,0,0])}}e.MeshSprite=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.EventTargetƒ{constructor(t){super(),this.mtxWorld=e.Matrix4x4.IDENTITY,this.timestampUpdate=0,this.parent=null,this.children=[],this.components={},this.listeners={},this.captures={},this.active=!0,this.name=t}activate(e){this.active=e,this.dispatchEvent(new Event(e?"componentActivate":"componentDeactivate"))}get isActive(){return this.active}getParent(){return this.parent}getAncestor(){let e=this;for(;e.getParent();)e=e.getParent();return e}get cmpTransform(){return this.getComponents(e.ComponentTransform)[0]}getChildren(){return this.children.slice(0)}getChildrenByName(e){let t=[];return t=this.children.filter(t=>t.name==e),t}appendChild(t){if(this.children.includes(t))return;let i=!1,r=this;for(;r;){if(r.timestampUpdate=0,i=i||r==e.AudioManager.default.getBranchListeningTo(),r==t)throw new Error("Cyclic reference prohibited in node hierarchy, ancestors must not be added as children");r=r.parent}let n=t.parent;n&&n.removeChild(t),this.children.push(t),t.parent=this,t.dispatchEvent(new Event("childAppend",{bubbles:!0})),i&&t.broadcastEvent(new Event("childAppendToAudioBranch"))}removeChild(t){let i=this.findChild(t);i<0||(t.dispatchEvent(new Event("childRemove",{bubbles:!0})),this.isDescendantOf(e.AudioManager.default.getBranchListeningTo())&&t.broadcastEvent(new Event("childRemoveFromAudioBranch")),this.children.splice(i,1),t.parent=null)}findChild(e){return this.children.indexOf(e)}replaceChild(t,i){let r=this.findChild(t);if(r<0)return!1;let n=i.getParent();return n&&n.removeChild(i),t.parent=null,this.children[r]=i,i.parent=this,i.dispatchEvent(new Event("childAppend",{bubbles:!0})),this.isDescendantOf(e.AudioManager.default.getBranchListeningTo())&&i.broadcastEvent(new Event("childAppendToAudioBranch")),!0}get branch(){return this.getBranchGenerator()}isUpdated(e){return this.timestampUpdate==e}isDescendantOf(e){let t=this;for(;t&&t!=e;)t=t.parent;return null!=t}applyAnimation(e){if(e.components)for(let t in e.components)if(this.components[t]){let i=e.components;for(let e in i[t])if(this.components[t][+e]){let r=this.components[t][+e],n=i[t][+e];for(let e in n){let t=n[e];r.mutate(t)}}}if(e.children)for(let t=0;t<e.children.length;t++){let i=e.children[t]["ƒ.Node"].name,r=this.getChildrenByName(i);for(let i of r)i.applyAnimation(e.children[t]["ƒ.Node"])}}getAllComponents(){let e=[];for(let t in this.components)e=e.concat(this.components[t]);return e}getComponents(e){return(this.components[e.name]||[]).slice(0)}getComponent(e){let t=this.components[e.name];return t?t[0]:null}addComponent(e){if(e.getContainer()!=this){if(void 0===this.components[e.type])this.components[e.type]=[e];else{if(e.isSingleton)throw new Error("Component is marked singleton and can't be attached, no more than one allowed");this.components[e.type].push(e)}e.setContainer(this),e.dispatchEvent(new Event("componentAdd"))}}removeComponent(e){try{let t=this.components[e.type],i=t.indexOf(e);if(i<0)return;e.dispatchEvent(new Event("componentRemove")),t.splice(i,1),e.setContainer(null)}catch(t){throw new Error(`Unable to remove component '${e}'in node named '${this.name}'`)}}serialize(){let t={name:this.name},i={};for(let t in this.components){i[t]=[];for(let r of this.components[t])i[t].push(e.Serializer.serialize(r))}t.components=i;let r=[];for(let t of this.children)r.push(e.Serializer.serialize(t));return t.children=r,this.dispatchEvent(new Event("nodeSerialized")),t}deserialize(t){this.name=t.name;for(let i in t.components)for(let r of t.components[i]){let t=e.Serializer.deserialize(r);this.addComponent(t)}for(let i of t.children){let t=e.Serializer.deserialize(i);this.appendChild(t)}return this.dispatchEvent(new Event("nodeDeserialized")),this}addEventListener(e,t,i=!1){let r=i?this.captures:this.listeners;r[e]||(r[e]=[]),r[e].push(t)}removeEventListener(e,t,i=!1){let r=i?this.captures[e]:this.listeners[e];if(r)for(let e=r.length-1;e>=0;e--)r[e]==t&&r.splice(e,1)}dispatchEvent(e){let t=[],i=this;for(Object.defineProperty(e,"target",{writable:!0,value:this});i.parent;)t.push(i=i.parent);Object.defineProperty(e,"eventPhase",{writable:!0,value:Event.CAPTURING_PHASE});for(let i=t.length-1;i>=0;i--){let r=t[i];Object.defineProperty(e,"currentTarget",{writable:!0,value:r});let n=r.captures[e.type]||[];for(let t of n)t(e)}if(!e.bubbles)return!0;Object.defineProperty(e,"eventPhase",{writable:!0,value:Event.AT_TARGET}),Object.defineProperty(e,"currentTarget",{writable:!0,value:this});let r=this.listeners[e.type]||[];for(let t of r)t(e);Object.defineProperty(e,"eventPhase",{writable:!0,value:Event.BUBBLING_PHASE});for(let i=0;i<t.length;i++){let r=t[i];Object.defineProperty(e,"currentTarget",{writable:!0,value:r});let n=r.listeners[e.type]||[];for(let t of n)t(e)}return!0}broadcastEvent(e){Object.defineProperty(e,"eventPhase",{writable:!0,value:Event.CAPTURING_PHASE}),Object.defineProperty(e,"target",{writable:!0,value:this}),this.broadcastEventRecursive(e)}broadcastEventRecursive(e){Object.defineProperty(e,"currentTarget",{writable:!0,value:this});let t=this.captures[e.type]||[];for(let i of t)i(e);for(let t of this.children)t.broadcastEventRecursive(e)}*getBranchGenerator(){yield this;for(let e of this.children)yield*e.branch}}e.Node=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Node{constructor(){super(...arguments),this.idResource=void 0}}e.NodeResource=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Node{constructor(e){super("NodeResourceInstance"),this.idSource=void 0,e&&this.set(e)}reset(){let t=e.ResourceManager.get(this.idSource);this.set(t)}serialize(){let e=super.serialize();return e.idSource=this.idSource,e}deserialize(e){return super.deserialize(e),this.idSource=e.idSource,this}set(t){let i=e.Serializer.serialize(t);for(let e in i){this.deserialize(i[e]);break}this.idSource=t.idResource,this.dispatchEvent(new Event("nodeResourceInstantiated"))}}e.NodeResourceInstance=t}(FudgeCore||(FudgeCore={})),function(e){e.Ray=class{constructor(t=e.Vector3.Z(-1),i=e.Vector3.ZERO(),r=1){this.origin=i,this.direction=t,this.length=r}}}(FudgeCore||(FudgeCore={})),function(e){e.RayHit=class{constructor(e=null,t=0,i=0){this.node=e,this.face=t,this.zBuffer=i}}}(FudgeCore||(FudgeCore={})),function(e){class t{constructor(e){this.count=0,this.reference=e}getReference(){return this.reference}increaseCounter(){return this.count++,this.count}decreaseCounter(){if(0==this.count)throw new Error("Negative reference counter");return this.count--,this.count}}class i extends e.RenderOperator{static addNode(t){if(i.nodes.get(t))return;let r=t.getComponent(e.ComponentMaterial);if(!r)return;let n=r.material.getShader();i.createReference(i.renderShaders,n,i.createProgram);let s=r.material.getCoat();i.createReference(i.renderCoats,s,i.createParameter);let a=t.getComponent(e.ComponentMesh).mesh;i.createReference(i.renderBuffers,a,i.createBuffers);let o={shader:n,coat:s,mesh:a};i.nodes.set(t,o)}static addBranch(t){for(let r of t.branch)try{i.addNode(r)}catch(t){e.Debug.log(t)}return!0}static removeNode(e){let t=i.nodes.get(e);t&&(i.removeReference(i.renderShaders,t.shader,i.deleteProgram),i.removeReference(i.renderCoats,t.coat,i.deleteParameter),i.removeReference(i.renderBuffers,t.mesh,i.deleteBuffers),i.nodes.delete(e))}static removeBranch(e){for(let t of e.branch)i.removeNode(t)}static updateNode(t){let r=i.nodes.get(t);if(!r)return;let n=t.getComponent(e.ComponentMaterial),s=n.material.getShader();s!==r.shader&&(i.removeReference(i.renderShaders,r.shader,i.deleteProgram),i.createReference(i.renderShaders,s,i.createProgram),r.shader=s);let a=n.material.getCoat();a!==r.coat&&(i.removeReference(i.renderCoats,r.coat,i.deleteParameter),i.createReference(i.renderCoats,a,i.createParameter),r.coat=a);let o=t.getComponent(e.ComponentMesh).mesh;o!==r.mesh&&(i.removeReference(i.renderBuffers,r.mesh,i.deleteBuffers),i.createReference(i.renderBuffers,o,i.createBuffers),r.mesh=o)}static updateBranch(e){for(let t of e.branch)i.updateNode(t)}static setLights(e){for(let t of i.renderShaders){let r=t[1].getReference();i.setLightsInShader(r,e)}}static update(){i.timestampUpdate=performance.now(),i.recalculateAllNodeTransforms()}static clear(e=null){i.crc3.clearColor(e.r,e.g,e.b,e.a),i.crc3.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT)}static resetFrameBuffer(e=null){i.crc3.bindFramebuffer(WebGL2RenderingContext.FRAMEBUFFER,null)}static drawBranch(t,r,n=i.drawNode){if(!t.isActive)return;let s;n==i.drawNode&&i.resetFrameBuffer();let a=t.getComponent(e.ComponentMesh);s=a?e.Matrix4x4.MULTIPLICATION(t.mtxWorld,a.pivot):t.mtxWorld;let o=e.Matrix4x4.MULTIPLICATION(r.ViewProjectionMatrix,s);n(t,s,o);for(let e in t.getChildren()){let s=t.getChildren()[e];i.drawBranch(s,r,n)}e.Recycler.store(o),s!=t.mtxWorld&&e.Recycler.store(s)}static drawBranchForRayCast(t,r){return i.pickBuffers=[],i.renderShaders.get(e.ShaderRayCast)||i.createReference(i.renderShaders,e.ShaderRayCast,i.createProgram),e.RenderOperator.crc3.blendFunc(1,0),i.drawBranch(t,r,i.drawNodeForRayCast),e.RenderOperator.crc3.blendFunc(WebGL2RenderingContext.DST_ALPHA,WebGL2RenderingContext.ONE_MINUS_DST_ALPHA),i.resetFrameBuffer(),i.pickBuffers}static pickNodeAt(t,r,n){let s=[];for(let a of r){i.crc3.bindFramebuffer(WebGL2RenderingContext.FRAMEBUFFER,a.frameBuffer);let r=new Uint8Array(n.width*n.height*4);i.crc3.readPixels(0,0,n.width,n.height,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,r);let o=r[4*(t.x+n.width*t.y)+0],c=new e.RayHit(a.node,0,o);s.push(c)}return s}static drawNode(e,t,r){let n=i.nodes.get(e);if(!n)return;let s=i.renderBuffers.get(n.mesh).getReference(),a=i.renderCoats.get(n.coat).getReference(),o=i.renderShaders.get(n.shader).getReference();i.draw(o,s,a,t,r)}static drawNodeForRayCast(e,t,r){let n=i.getRayCastTexture();const s=i.crc3.createFramebuffer();i.crc3.bindFramebuffer(WebGL2RenderingContext.FRAMEBUFFER,s);const a=WebGL2RenderingContext.COLOR_ATTACHMENT0;i.crc3.framebufferTexture2D(WebGL2RenderingContext.FRAMEBUFFER,a,WebGL2RenderingContext.TEXTURE_2D,n,0);let o=i.nodes.get(e);if(!o)return;let c={node:e,texture:n,frameBuffer:s};i.pickBuffers.push(c);let l=i.renderBuffers.get(o.mesh).getReference();i.drawForRayCast(i.pickBuffers.length,l,t,r)}static getRayCastTexture(){const e=i.getViewportRectangle().width,t=i.getViewportRectangle().height,r=i.crc3.createTexture();i.crc3.bindTexture(WebGL2RenderingContext.TEXTURE_2D,r);{const r=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,s=WebGL2RenderingContext.UNSIGNED_BYTE;i.crc3.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,e,t,0,n,s,null),i.crc3.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),i.crc3.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.crc3.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}return r}static recalculateAllNodeTransforms(){i.nodes.forEach((t,r,n)=>{let s,a=r;for(;s=a.getParent(),s&&!r.isUpdated(i.timestampUpdate);)a=s;let o=e.Matrix4x4.IDENTITY;s&&(o=s.mtxWorld),i.recalculateTransformsOfNodeAndChildren(a,o)})}static recalculateTransformsOfNodeAndChildren(t,r){let n=r,s=t.cmpTransform;s&&(n=e.Matrix4x4.MULTIPLICATION(r,s.local)),t.mtxWorld=n,t.timestampUpdate=i.timestampUpdate;for(let e of t.getChildren())i.recalculateTransformsOfNodeAndChildren(e,n)}static removeReference(e,t,i){let r;r=e.get(t),0==r.decreaseCounter()&&(i(r.getReference()),e.delete(t))}static createReference(e,i,r){let n;if(n=e.get(i),n)n.increaseCounter();else{let s=r(i);n=new t(s),n.increaseCounter(),e.set(i,n)}}}i.rectClip=new e.Rectangle(-1,1,2,-2),i.renderShaders=new Map,i.renderCoats=new Map,i.renderBuffers=new Map,i.nodes=new Map,e.RenderManager=i}(FudgeCore||(FudgeCore={})),function(e){e.Shader=class{static getCoat(){return null}static getVertexShaderSource(){return null}static getFragmentShaderSource(){return null}}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Shader{static getCoat(){return e.CoatColored}static getVertexShaderSource(){return"#version 300 es\n\n                    struct LightAmbient {\n                        vec4 color;\n                    };\n                    struct LightDirectional {\n                        vec4 color;\n                        vec3 direction;\n                    };\n\n                    const uint MAX_LIGHTS_DIRECTIONAL = 10u;\n\n                    in vec3 a_position;\n                    in vec3 a_normal;\n                    uniform mat4 u_world;\n                    uniform mat4 u_projection;\n\n                    uniform LightAmbient u_ambient;\n                    uniform uint u_nLightsDirectional;\n                    uniform LightDirectional u_directional[MAX_LIGHTS_DIRECTIONAL];\n                    flat out vec4 v_color;\n                    \n                    void main() {   \n                        gl_Position = u_projection * vec4(a_position, 1.0);\n                        vec3 normal = normalize(mat3(u_world) * a_normal);\n\n                        v_color = u_ambient.color;\n                        for (uint i = 0u; i < u_nLightsDirectional; i++) {\n                            float illumination = -dot(normal, u_directional[i].direction);\n                            if (illumination > 0.0f)\n                                v_color += illumination * u_directional[i].color; // vec4(1,1,1,1); // \n                        }\n                        v_color.a = 1.0;\n                    }"}static getFragmentShaderSource(){return"#version 300 es\n                    precision mediump float;\n\n                    uniform vec4 u_color;\n                    flat in vec4 v_color;\n                    out vec4 frag;\n                    \n                    void main() {\n                        frag = u_color * v_color;\n                    }"}}e.ShaderFlat=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Shader{static getCoat(){return e.CoatMatCap}static getVertexShaderSource(){return"#version 300 es\n\n                    in vec3 a_position;\n                    in vec3 a_normal;\n                    uniform mat4 u_projection;\n\n                    out vec2 tex_coords_smooth;\n                    flat out vec2 tex_coords_flat;\n\n                    void main() {\n                        mat4 normalMatrix = transpose(inverse(u_projection));\n                        vec4 p = vec4(a_position, 1.0);\n                        vec4 normal4 = vec4(a_normal, 1.0);\n                        vec3 e = normalize( vec3( u_projection * p ) );\n                        vec3 n = normalize( vec3(normalMatrix * normal4) );\n\n                        vec3 r = reflect( e, n );\n                        float m = 2. * sqrt(\n                            pow( r.x, 2. ) +\n                            pow( r.y, 2. ) +\n                            pow( r.z + 1., 2. )\n                        );\n\n                        tex_coords_smooth = r.xy / m + .5;\n                        tex_coords_flat = r.xy / m + .5;\n\n                        gl_Position = u_projection * vec4(a_position, 1.0);\n                    }"}static getFragmentShaderSource(){return"#version 300 es\n                    precision mediump float;\n                    \n                    uniform vec4 u_tint_color;\n                    uniform float u_flatmix;\n                    uniform sampler2D u_texture;\n                    \n                    in vec2 tex_coords_smooth;\n                    flat in vec2 tex_coords_flat;\n\n                    out vec4 frag;\n\n                    void main() {\n                        vec2 tc = mix(tex_coords_smooth, tex_coords_flat, u_flatmix);\n                        frag = u_tint_color * texture(u_texture, tc) * 2.0;\n                    }"}}e.ShaderMatCap=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Shader{static getVertexShaderSource(){return"#version 300 es\n\n                    in vec3 a_position;\n                    uniform mat4 u_projection;\n                    \n                    void main() {   \n                        gl_Position = u_projection * vec4(a_position, 1.0);\n                    }"}static getFragmentShaderSource(){return"#version 300 es\n                    precision mediump float;\n                    precision highp int;\n                    \n                    uniform int u_id;\n                    out vec4 frag;\n                    \n                    void main() {\n                       float id = float(u_id)/ 256.0;\n                       float upperbyte = trunc(gl_FragCoord.z * 256.0) / 256.0;\n                       float lowerbyte = fract(gl_FragCoord.z * 256.0);\n                       frag = vec4(gl_FragCoord.z, upperbyte, lowerbyte, 1.0);\n                    }"}}e.ShaderRayCast=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Shader{static getCoat(){return e.CoatTextured}static getVertexShaderSource(){return"#version 300 es\n\n                in vec3 a_position;\n                in vec2 a_textureUVs;\n                uniform mat4 u_projection;\n                uniform vec4 u_color;\n                uniform mat3 u_pivot;\n                out vec2 v_textureUVs;\n\n                void main() {  \n                    gl_Position = u_projection * vec4(a_position, 1.0);\n                    // v_textureUVs = a_textureUVs;\n                    v_textureUVs = vec2(u_pivot * vec3(a_textureUVs, 1.0)).xy;\n                }"}static getFragmentShaderSource(){return"#version 300 es\n                precision mediump float;\n                \n                in vec2 v_textureUVs;\n                uniform sampler2D u_texture;\n                out vec4 frag;\n                \n                void main() {\n                    frag = texture(u_texture, v_textureUVs);\n                    if (frag.a < 0.01)\n                      discard;\n            }"}}e.ShaderTexture=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Shader{static getCoat(){return e.CoatColored}static getVertexShaderSource(){return"#version 300 es\n\n                    in vec3 a_position;\n                    uniform mat4 u_projection;\n                    \n                    void main() {   \n                        gl_Position = u_projection * vec4(a_position, 1.0);\n                    }"}static getFragmentShaderSource(){return"#version 300 es\n                    precision mediump float;\n                    \n                    uniform vec4 u_color;\n                    out vec4 frag;\n                    \n                    void main() {\n                       frag = u_color;\n                    }"}}e.ShaderUniColor=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.Mutable{reduceMutator(){}}e.Texture=t;e.TextureImage=class extends t{constructor(){super(...arguments),this.image=null}};class i extends t{}e.TextureCanvas=i;e.TextureSketch=class extends i{};e.TextureHTML=class extends i{}}(FudgeCore||(FudgeCore={})),function(e){class t extends e.EventTargetƒ{constructor(){super(),this.timers={},this.idTimerNext=0,this.start=performance.now(),this.scale=1,this.offset=0,this.lastCallToElapsed=0}static getUnits(e){let t={};return t.asSeconds=e/1e3,t.asMinutes=t.asSeconds/60,t.asHours=t.asMinutes/60,t.hours=Math.floor(t.asHours),t.minutes=Math.floor(t.asMinutes)%60,t.seconds=Math.floor(t.asSeconds)%60,t.fraction=e%1e3,t.thousands=e%10,t.hundreds=e%100-t.thousands,t.tenths=t.fraction-t.hundreds-t.thousands,t}get(){return this.offset+this.scale*(performance.now()-this.start)}getRemainder(e){return e-this.get()}set(e=0){this.offset=e,this.start=performance.now(),this.getElapsedSincePreviousCall()}setScale(e=1){this.set(this.get()),this.scale=e,this.rescaleAllTimers(),this.getElapsedSincePreviousCall(),this.dispatchEvent(new Event("timeScaled"))}getScale(){return this.scale}getOffset(){return this.offset}getElapsedSincePreviousCall(){let e=this.get(),t=e-this.lastCallToElapsed;return this.lastCallToElapsed=e,t}delay(e){return new Promise(t=>this.setTimer(e,1,()=>t()))}clearAllTimers(){for(let e in this.timers)this.deleteTimer(Number(e))}deleteTimerByItsInternalId(e){for(let t in this.timers){let i=this.timers[t];i.id==e&&(i.clear(),delete this.timers[t])}}setTimer(t,i,r,...n){let s=new e.Timer(this,t,i,r,n);return this.timers[++this.idTimerNext]=s,this.idTimerNext}deleteTimer(e){this.timers[e].clear(),delete this.timers[e]}getTimers(){return Object.assign({},this.timers)}hasTimers(){return Object.keys(this.timers).length>0}rescaleAllTimers(){for(let e in this.timers){let t=this.timers[e];t.clear(),this.scale&&(this.timers[e]=t.installCopy())}}}t.game=new t,e.Time=t,e.time=t.game}(FudgeCore||(FudgeCore={})),function(e){let t;!function(e){e.FRAME_REQUEST="frameRequest",e.TIME_GAME="timeGame",e.TIME_REAL="timeReal"}(t=e.LOOP_MODE||(e.LOOP_MODE={}));class i extends e.EventTargetStatic{static start(r=t.FRAME_REQUEST,n=60,s=!1){i.stop(),i.timeStartGame=e.Time.game.get(),i.timeStartReal=performance.now(),i.timeLastFrameGame=i.timeStartGame,i.timeLastFrameReal=i.timeStartReal,i.fpsDesired=r==t.FRAME_REQUEST?60:n,i.framesToAverage=i.fpsDesired,i.timeLastFrameGameAvg=i.timeLastFrameRealAvg=1e3/i.fpsDesired,i.mode=r,i.syncWithAnimationFrame=s;let a=`Loop starting in mode ${i.mode}`;switch(i.mode!=t.FRAME_REQUEST&&(a+=` with attempted ${n} fps`),e.Debug.log(a),r){case t.FRAME_REQUEST:i.loopFrame();break;case t.TIME_REAL:i.idIntervall=window.setInterval(i.loopTime,1e3/i.fpsDesired),i.loopTime();break;case t.TIME_GAME:i.idIntervall=e.Time.game.setTimer(1e3/i.fpsDesired,0,i.loopTime),i.loopTime()}i.running=!0}static stop(){if(i.running){switch(i.mode){case t.FRAME_REQUEST:window.cancelAnimationFrame(i.idRequest);break;case t.TIME_REAL:window.clearInterval(i.idIntervall),window.cancelAnimationFrame(i.idRequest);break;case t.TIME_GAME:e.Time.game.deleteTimer(i.idIntervall),window.cancelAnimationFrame(i.idRequest)}e.Debug.log("Loop stopped!")}}static getFpsGameAverage(){return 1e3/i.timeLastFrameGameAvg}static getFpsRealAverage(){return 1e3/i.timeLastFrameRealAvg}static loop(){let t;t=performance.now(),i.timeFrameReal=t-i.timeLastFrameReal,i.timeLastFrameReal=t,t=e.Time.game.get(),i.timeFrameGame=t-i.timeLastFrameGame,i.timeLastFrameGame=t,i.timeLastFrameGameAvg=((i.framesToAverage-1)*i.timeLastFrameGameAvg+i.timeFrameGame)/i.framesToAverage,i.timeLastFrameRealAvg=((i.framesToAverage-1)*i.timeLastFrameRealAvg+i.timeFrameReal)/i.framesToAverage;let r=new Event("loopFrame");i.targetStatic.dispatchEvent(r)}static loopFrame(){i.loop(),i.idRequest=window.requestAnimationFrame(i.loopFrame)}static loopTime(){i.syncWithAnimationFrame?i.idRequest=window.requestAnimationFrame(i.loop):i.loop()}}i.timeStartGame=0,i.timeStartReal=0,i.timeFrameGame=0,i.timeFrameReal=0,i.timeLastFrameGame=0,i.timeLastFrameReal=0,i.timeLastFrameGameAvg=0,i.timeLastFrameRealAvg=0,i.running=!1,i.mode=t.FRAME_REQUEST,i.idIntervall=0,i.idRequest=0,i.fpsDesired=30,i.framesToAverage=30,i.syncWithAnimationFrame=!1,e.Loop=i}(FudgeCore||(FudgeCore={})),function(e){class t{constructor(t,i,r,n,...s){this.time=t,this.elapse=i,this.event=new e.EventTimer(this,s),this.handler=n,this.count=r;let a=Math.abs(t.getScale());if(!a)return void(this.active=!1);this.timeoutReal=this.elapse/a;this.idWindow=window.setInterval(()=>{this.event.lastCall=1==this.count,n(this.event),this.event.firstCall=!1,this.count>0&&0==--this.count&&t.deleteTimerByItsInternalId(this.idWindow)},this.timeoutReal,s),this.active=!0}get id(){return this.idWindow}get lapse(){return this.elapse}installCopy(){return new t(this.time,this.elapse,this.count,this.handler,this.event.arguments)}clear(){window.clearInterval(this.idWindow),this.active=!1}}e.Timer=t}(FudgeCore||(FudgeCore={})),function(e){class t extends e.EventTargetStatic{static load(){t.selector=document.createElement("input"),t.selector.type="file",t.selector.multiple=!0,t.selector.hidden=!0,t.selector.addEventListener("change",t.handleFileSelect),document.body.appendChild(t.selector),t.selector.click()}static save(e){for(let t in e){let i,r=e[t],n=new Blob([r],{type:"text/plain"}),s=window.URL.createObjectURL(n);i=document.createElement("a"),i.setAttribute("href",s),i.setAttribute("download",t),document.body.appendChild(i),i.click(),document.body.removeChild(i),window.URL.revokeObjectURL(s)}let i=new CustomEvent("fileSaved",{detail:{mapFilenameToContent:e}});t.targetStatic.dispatchEvent(i)}static async handleFileSelect(e){console.log("-------------------------------- handleFileSelect"),document.body.removeChild(t.selector);let i=e.target.files;if(console.log(i,i.length),0==i.length)return;let r={};await t.loadFiles(i,r);let n=new CustomEvent("fileLoaded",{detail:{mapFilenameToContent:r}});t.targetStatic.dispatchEvent(n)}static async loadFiles(e,t){for(let i of e){const e=await new Response(i).text();t[i.name]=e}}}e.FileIoBrowserLocal=t}(FudgeCore||(FudgeCore={}));