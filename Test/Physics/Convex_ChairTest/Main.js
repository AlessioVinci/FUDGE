"use strict";
var FudgeExperiments_Marko_ConvexColliderThroughWelding;
(function (FudgeExperiments_Marko_ConvexColliderThroughWelding) {
    var f = FudgeCore;
    // In a Test there could be about 100 Chairs and still maintain 15+ FPS, resulting in 600 RB's and 500 Joints calculated per Frame.
    //Fudge Basic Variables
    window.addEventListener("load", init);
    const app = document.querySelector("canvas"); // The html element where the scene is drawn to
    let viewPort; // The scene visualization
    let hierarchy; // You're object scene tree
    let fps;
    const times = [];
    let fpsDisplay = document.querySelector("h2#FPS");
    //Physical Objects
    let bodies = new Array(); // Array of all physical objects in the scene to have a quick reference
    let noChairs = 0;
    //Setting Variables
    //Function to initialize the Fudge Scene with a camera, light, viewport and PHYSCIAL Objects
    function init(_event) {
        hierarchy = new f.Node("Scene"); //create the root Node where every object is parented to. Should never be changed
        //PHYSICS - Basic Plane and Cube
        //Creating a physically static ground plane for our physics playground. A simple scaled cube but with physics type set to static
        bodies[0] = createCompleteNode("Ground", new f.Material("Ground", f.ShaderFlat, new f.CoatColored(new f.Color(0.2, 0.2, 0.2, 1))), new f.MeshCube(), 0, f.BODY_TYPE.STATIC);
        bodies[0].mtxLocal.scale(new f.Vector3(14, 0.3, 14)); //Scale the body with it's standard ComponentTransform
        bodies[0].mtxLocal.rotateX(3, true); //Give it a slight rotation so the physical objects are sliding, always from left when it's after a scaling
        hierarchy.appendChild(bodies[0]); //Add the node to the scene by adding it to the scene-root
        spawnChair();
        //Standard Fudge Scene Initialization - Creating a directional light, a camera and initialize the viewport
        let cmpLight = new f.ComponentLight(new f.LightDirectional(f.Color.CSS("WHITE")));
        cmpLight.mtxPivot.lookAt(new f.Vector3(0.5, -1, -0.8)); //Set light direction
        hierarchy.addComponent(cmpLight);
        let cmpCamera = new f.ComponentCamera();
        cmpCamera.clrBackground = f.Color.CSS("GREY");
        cmpCamera.mtxPivot.translate(new f.Vector3(2, 3.5, 17)); //Move camera far back so the whole scene is visible
        cmpCamera.mtxPivot.lookAt(f.Vector3.ZERO()); //Set the camera matrix so that it looks at the center of the scene
        viewPort = new f.Viewport(); //Creating a viewport that is rendered onto the html canvas element
        viewPort.initialize("Viewport", hierarchy, cmpCamera, app); //initialize the viewport with the root node, camera and canvas
        //PHYSICS - Start using physics by telling the physics the scene root object. Physics will recalculate every transform and initialize
        f.Physics.adjustTransforms(hierarchy);
        f.Physics.settings.debugDraw = true;
        app.addEventListener("mousedown", () => { spawnChair(); });
        //Important start the game loop after starting physics, so physics can use the current transform before it's first iteration
        f.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update); //Tell the game loop to call the update function on each frame
        f.Loop.start(); //Stard the game loop
    }
    //Function to animate/update the Fudge scene, commonly known as gameloop
    function update() {
        f.Physics.world.simulate(); //PHYSICS - Simulate physical changes each frame, parameter to set time between frames
        measureFPS();
        viewPort.draw(); // Draw the current Fudge Scene to the canvas
    }
    // Function to quickly create a node with multiple needed FudgeComponents, including a physics component
    function createCompleteNode(_name, _material, _mesh, _mass, _physicsType, _group = f.COLLISION_GROUP.DEFAULT, _colType = f.COLLIDER_TYPE.CUBE) {
        //Standard Fudge Node Creation
        let node = new f.Node(_name); //Creating the node
        let cmpMesh = new f.ComponentMesh(_mesh); //Creating a mesh for the node
        let cmpMaterial = new f.ComponentMaterial(_material); //Creating a material for the node
        let cmpTransform = new f.ComponentTransform(); //Transform holding position/rotation/scaling of the node
        let cmpRigidbody = new f.ComponentRigidbody(_mass, _physicsType, _colType, _group); //Adding a physical body component to use physics
        node.addComponent(cmpMesh);
        node.addComponent(cmpMaterial);
        node.addComponent(cmpTransform);
        node.addComponent(cmpRigidbody); // <-- best practice to add physics component last
        return node;
    }
    function spawnChair() {
        let rngHeight = (min, max) => {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };
        let spawnHeight = rngHeight(8, 20);
        noChairs++;
        //Creating a chair, base + back + 4 legs
        let base = createCompleteNode("Base", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC);
        base.mtxLocal.translate(new f.Vector3(0, 3.5 + spawnHeight, 0));
        base.mtxLocal.scale(new f.Vector3(1, 0.2, 1));
        hierarchy.appendChild(base);
        let back = createCompleteNode("Back", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC);
        back.mtxLocal.translate(new f.Vector3(0.4, 4 + spawnHeight, 0));
        back.mtxLocal.scale(new f.Vector3(0.2, 1, 1));
        hierarchy.appendChild(back);
        let weldingJoint = new f.ComponentJointWelding(base.getComponent(f.ComponentRigidbody), back.getComponent(f.ComponentRigidbody));
        back.addComponent(weldingJoint);
        let leg = createCompleteNode("Leg_BL", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC, f.COLLISION_GROUP.GROUP_2);
        leg.mtxLocal.translate(new f.Vector3(0.4, 3 + spawnHeight, 0.4));
        leg.mtxLocal.scale(new f.Vector3(0.2, 0.8, 0.2));
        hierarchy.appendChild(leg);
        weldingJoint = new f.ComponentJointWelding(base.getComponent(f.ComponentRigidbody), leg.getComponent(f.ComponentRigidbody));
        back.addComponent(weldingJoint);
        leg = createCompleteNode("Leg_BR", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC, f.COLLISION_GROUP.GROUP_2);
        leg.mtxLocal.translate(new f.Vector3(0.4, 3 + spawnHeight, -0.4));
        leg.mtxLocal.scale(new f.Vector3(0.2, 0.8, 0.2));
        hierarchy.appendChild(leg);
        weldingJoint = new f.ComponentJointWelding(base.getComponent(f.ComponentRigidbody), leg.getComponent(f.ComponentRigidbody));
        back.addComponent(weldingJoint);
        leg = createCompleteNode("Leg_FR", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC, f.COLLISION_GROUP.GROUP_2);
        leg.mtxLocal.translate(new f.Vector3(-0.4, 3 + spawnHeight, -0.4));
        leg.mtxLocal.scale(new f.Vector3(0.2, 0.8, 0.2));
        hierarchy.appendChild(leg);
        weldingJoint = new f.ComponentJointWelding(base.getComponent(f.ComponentRigidbody), leg.getComponent(f.ComponentRigidbody));
        back.addComponent(weldingJoint);
        leg = createCompleteNode("Leg_FR", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(0.75, 0.8, 0.75, 1))), new f.MeshCube(), 1, f.BODY_TYPE.DYNAMIC, f.COLLISION_GROUP.GROUP_2);
        leg.mtxLocal.translate(new f.Vector3(-0.4, 3 + spawnHeight, 0.4));
        leg.mtxLocal.scale(new f.Vector3(0.2, 0.8, 0.2));
        hierarchy.appendChild(leg);
        weldingJoint = new f.ComponentJointWelding(base.getComponent(f.ComponentRigidbody), leg.getComponent(f.ComponentRigidbody));
        back.addComponent(weldingJoint);
        f.Physics.adjustTransforms(hierarchy); // Important! You need to at least adjust Transforms for the parts of the chair
    }
    function measureFPS() {
        window.requestAnimationFrame(() => {
            const now = performance.now();
            while (times.length > 0 && times[0] <= now - 1000) {
                times.shift();
            }
            times.push(now);
            fps = times.length;
            fpsDisplay.textContent = `FPS: ${fps.toString()} / Chairs: ${noChairs} / Bodies: ${f.Physics.world.getBodyList().length}`;
        });
    }
})(FudgeExperiments_Marko_ConvexColliderThroughWelding || (FudgeExperiments_Marko_ConvexColliderThroughWelding = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLElBQVUsbURBQW1ELENBd0o1RDtBQXhKRCxXQUFVLG1EQUFtRDtJQUN6RCxJQUFPLENBQUMsR0FBRyxTQUFTLENBQUM7SUFFckIsbUlBQW1JO0lBRW5JLHVCQUF1QjtJQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sR0FBRyxHQUFzQixRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsK0NBQStDO0lBQ2hILElBQUksUUFBb0IsQ0FBQyxDQUFDLDBCQUEwQjtJQUNwRCxJQUFJLFNBQWlCLENBQUMsQ0FBQywyQkFBMkI7SUFDbEQsSUFBSSxHQUFXLENBQUM7SUFDaEIsTUFBTSxLQUFLLEdBQWEsRUFBRSxDQUFDO0lBQzNCLElBQUksVUFBVSxHQUFnQixRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRy9ELGtCQUFrQjtJQUNsQixJQUFJLE1BQU0sR0FBYSxJQUFJLEtBQUssRUFBRSxDQUFDLENBQUMsdUVBQXVFO0lBQzNHLElBQUksUUFBUSxHQUFXLENBQUMsQ0FBQztJQUV6QixtQkFBbUI7SUFJbkIsNEZBQTRGO0lBQzVGLFNBQVMsSUFBSSxDQUFDLE1BQWE7UUFFdkIsU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGlGQUFpRjtRQUVsSCxnQ0FBZ0M7UUFDaEMsZ0lBQWdJO1FBQ2hJLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFF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RSxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUM3RCxDQUFDLENBQUE7UUFDRCxJQUFJLFdBQVcsR0FBRyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ25DLFFBQVEsRUFBRSxDQUFDO1FBRVgsd0NBQXdDO1FBQ3hDLElBQUksSUFBSSxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxHQUFHLEdBQUcsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRTVCLElBQUksSUFBSSxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUssSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLElBQUksWUFBWSxHQUE0QixJQUFJLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztRQUMxSixJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRWhDLElBQUksR0FBRyxHQUFHLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdE0sR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFD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QUFDLHFCQUFxQixDQUFDLEdBQUcsRUFBRTtZQUM5QixNQUFNLEdBQUcsR0FBVyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdEMsT0FBTyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLElBQUksRUFBRTtnQkFDL0MsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2pCO1lBQ0QsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoQixHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztZQUNuQixVQUFVLENBQUMsV0FBVyxHQUFHLFFBQVEsR0FBRyxDQUFDLFFBQVEsRUFBRSxjQUFjLFFBQVEsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQTtRQUM3SCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7QUFHTCxDQUFDLEVBeEpTLG1EQUFtRCxLQUFuRCxtREFBbUQsUUF3SjVEIiwic291cmNlc0NvbnRlbnQiOlsibmFtZXNwYWNlIEZ1ZGdlRXhwZXJpbWVudHNfTWFya29fQ29udmV4Q29sbGlkZXJUaHJvdWdoV2VsZGluZyB7XHJcbiAgICBpbXBvcnQgZiA9IEZ1ZGdlQ29yZTtcclxuXHJcbiAgICAvLyBJbiBhIFRlc3QgdGhlcmUgY291bGQgYmUgYWJvdXQgMTAwIENoYWlycyBhbmQgc3RpbGwgbWFpbnRhaW4gMTUrIEZQUywgcmVzdWx0aW5nIGluIDYwMCBSQidzIGFuZCA1MDAgSm9pbnRzIGNhbGN1bGF0ZWQgcGVyIEZyYW1lLlxyXG5cclxuICAgIC8vRnVkZ2UgQmFzaWMgVmFyaWFibGVzXHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIiwgaW5pdCk7XHJcbiAgICBjb25zdCBhcHA6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcImNhbnZhc1wiKTsgLy8gVGhlIGh0bWwgZWxlbWVudCB3aGVyZSB0aGUgc2NlbmUgaXMgZHJhd24gdG9cclxuICAgIGxldCB2aWV3UG9ydDogZi5WaWV3cG9ydDsgLy8gVGhlIHNjZW5lIHZpc3VhbGl6YXRpb25cclxuICAgIGxldCBoaWVyYXJjaHk6IGYuTm9kZTsgLy8gWW91J3JlIG9iamVjdCBzY2VuZSB0cmVlXHJcbiAgICBsZXQgZnBzOiBudW1iZXI7XHJcbiAgICBjb25zdCB0aW1lczogbnVtYmVyW10gPSBbXTtcclxuICAgIGxldCBmcHNEaXNwbGF5OiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJoMiNGUFNcIik7XHJcblxyXG5cclxuICAgIC8vUGh5c2ljYWwgT2JqZWN0c1xyXG4gICAgbGV0IGJvZGllczogZi5Ob2RlW10gPSBuZXcgQXJyYXkoKTsgLy8gQXJyYXkgb2YgYWxsIHBoeXNpY2FsIG9iamVjdHMgaW4gdGhlIHNjZW5lIHRvIGhhdmUgYSBxdWljayByZWZlcmVuY2VcclxuICAgIGxldCBub0NoYWlyczogbnVtYmVyID0gMDtcclxuXHJcbiAgICAvL1NldHRpbmcgVmFyaWFibGVzXHJcblxyXG5cclxuXHJcbiAgICAvL0Z1bmN0aW9uIHRvIGluaXRpYWxpemUgdGhlIEZ1ZGdlIFNjZW5lIHdpdGggYSBjYW1lcmEsIGxpZ2h0LCB2aWV3cG9ydCBhbmQgUEhZU0NJQUwgT2JqZWN0c1xyXG4gICAgZnVuY3Rpb24gaW5pdChfZXZlbnQ6IEV2ZW50KTogdm9pZCB7XHJcblxyXG4gICAgICAgIGhpZXJhcmNoeSA9IG5ldyBmLk5vZGUoXCJTY2VuZVwiKTsgLy9jcmVhdGUgdGhlIHJvb3QgTm9kZSB3aGVyZSBldmVyeSBvYmplY3QgaXMgcGFyZW50ZWQgdG8uIFNob3VsZCBuZXZlciBiZSBjaGFuZ2VkXHJcblxyXG4gICAgICAgIC8vUEhZU0lDUyAtIEJhc2ljIFBsYW5lIGFuZCBDdWJlXHJcbiAgICAgICAgLy9DcmVhdGluZyBhIHBoeXNpY2FsbHkgc3RhdGljIGdyb3VuZCBwbGFuZSBmb3Igb3VyIHBoeXNpY3MgcGxheWdyb3VuZC4gQSBzaW1wbGUgc2NhbGVkIGN1YmUgYnV0IHdpdGggcGh5c2ljcyB0eXBlIHNldCB0byBzdGF0aWNcclxuICAgICAgICBib2RpZXNbMF0gPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJHcm91bmRcIiwgbmV3IGYuTWF0ZXJpYWwoXCJHcm91bmRcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjIsIDAuMiwgMC4yLCAxKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAwLCBmLkJPRFlfVFlQRS5TVEFUSUMpO1xyXG4gICAgICAgIGJvZGllc1swXS5tdHhMb2NhbC5zY2FsZShuZXcgZi5WZWN0b3IzKDE0LCAwLjMsIDE0KSk7IC8vU2NhbGUgdGhlIGJvZHkgd2l0aCBpdCdzIHN0YW5kYXJkIENvbXBvbmVudFRyYW5zZm9ybVxyXG4gICAgICAgIGJvZGllc1swXS5tdHhMb2NhbC5yb3RhdGVYKDMsIHRydWUpOyAvL0dpdmUgaXQgYSBzbGlnaHQgcm90YXRpb24gc28gdGhlIHBoeXNpY2FsIG9iamVjdHMgYXJlIHNsaWRpbmcsIGFsd2F5cyBmcm9tIGxlZnQgd2hlbiBpdCdzIGFmdGVyIGEgc2NhbGluZ1xyXG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChib2RpZXNbMF0pOyAvL0FkZCB0aGUgbm9kZSB0byB0aGUgc2NlbmUgYnkgYWRkaW5nIGl0IHRvIHRoZSBzY2VuZS1yb290XHJcblxyXG4gICAgICAgIHNwYXduQ2hhaXIoKTtcclxuXHJcbiAgICAgICAgLy9TdGFuZGFyZCBGdWRnZSBTY2VuZSBJbml0aWFsaXphdGlvbiAtIENyZWF0aW5nIGEgZGlyZWN0aW9uYWwgbGlnaHQsIGEgY2FtZXJhIGFuZCBpbml0aWFsaXplIHRoZSB2aWV3cG9ydFxyXG4gICAgICAgIGxldCBjbXBMaWdodDogZi5Db21wb25lbnRMaWdodCA9IG5ldyBmLkNvbXBvbmVudExpZ2h0KG5ldyBmLkxpZ2h0RGlyZWN0aW9uYWwoZi5Db2xvci5DU1MoXCJXSElURVwiKSkpO1xyXG4gICAgICAgIGNtcExpZ2h0Lm10eFBpdm90Lmxvb2tBdChuZXcgZi5WZWN0b3IzKDAuNSwgLTEsIC0wLjgpKTsgLy9TZXQgbGlnaHQgZGlyZWN0aW9uXHJcbiAgICAgICAgaGllcmFyY2h5LmFkZENvbXBvbmVudChjbXBMaWdodCk7XHJcblxyXG4gICAgICAgIGxldCBjbXBDYW1lcmE6IGYuQ29tcG9uZW50Q2FtZXJhID0gbmV3IGYuQ29tcG9uZW50Q2FtZXJhKCk7XHJcbiAgICAgICAgY21wQ2FtZXJhLmNsckJhY2tncm91bmQgPSBmLkNvbG9yLkNTUyhcIkdSRVlcIik7XHJcbiAgICAgICAgY21wQ2FtZXJhLm10eFBpdm90LnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDIsIDMuNSwgMTcpKTsgLy9Nb3ZlIGNhbWVyYSBmYXIgYmFjayBzbyB0aGUgd2hvbGUgc2NlbmUgaXMgdmlzaWJsZVxyXG4gICAgICAgIGNtcENhbWVyYS5tdHhQaXZvdC5sb29rQXQoZi5WZWN0b3IzLlpFUk8oKSk7IC8vU2V0IHRoZSBjYW1lcmEgbWF0cml4IHNvIHRoYXQgaXQgbG9va3MgYXQgdGhlIGNlbnRlciBvZiB0aGUgc2NlbmVcclxuXHJcbiAgICAgICAgdmlld1BvcnQgPSBuZXcgZi5WaWV3cG9ydCgpOyAvL0NyZWF0aW5nIGEgdmlld3BvcnQgdGhhdCBpcyByZW5kZXJlZCBvbnRvIHRoZSBodG1sIGNhbnZhcyBlbGVtZW50XHJcbiAgICAgICAgdmlld1BvcnQuaW5pdGlhbGl6ZShcIlZpZXdwb3J0XCIsIGhpZXJhcmNoeSwgY21wQ2FtZXJhLCBhcHApOyAvL2luaXRpYWxpemUgdGhlIHZpZXdwb3J0IHdpdGggdGhlIHJvb3Qgbm9kZSwgY2FtZXJhIGFuZCBjYW52YXNcclxuXHJcbiAgICAgICAgLy9QSFlTSUNTIC0gU3RhcnQgdXNpbmcgcGh5c2ljcyBieSB0ZWxsaW5nIHRoZSBwaHlzaWNzIHRoZSBzY2VuZSByb290IG9iamVjdC4gUGh5c2ljcyB3aWxsIHJlY2FsY3VsYXRlIGV2ZXJ5IHRyYW5zZm9ybSBhbmQgaW5pdGlhbGl6ZVxyXG4gICAgICAgIGYuUGh5c2ljcy5hZGp1c3RUcmFuc2Zvcm1zKGhpZXJhcmNoeSk7XHJcbiAgICAgICAgZi5QaHlzaWNzLnNldHRpbmdzLmRlYnVnRHJhdyA9IHRydWU7XHJcbiAgICAgICAgYXBwLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgKCkgPT4geyBzcGF3bkNoYWlyKCk7IH0pO1xyXG5cclxuICAgICAgICAvL0ltcG9ydGFudCBzdGFydCB0aGUgZ2FtZSBsb29wIGFmdGVyIHN0YXJ0aW5nIHBoeXNpY3MsIHNvIHBoeXNpY3MgY2FuIHVzZSB0aGUgY3VycmVudCB0cmFuc2Zvcm0gYmVmb3JlIGl0J3MgZmlyc3QgaXRlcmF0aW9uXHJcbiAgICAgICAgZi5Mb29wLmFkZEV2ZW50TGlzdGVuZXIoZi5FVkVOVC5MT09QX0ZSQU1FLCB1cGRhdGUpOyAvL1RlbGwgdGhlIGdhbWUgbG9vcCB0byBjYWxsIHRoZSB1cGRhdGUgZnVuY3Rpb24gb24gZWFjaCBmcmFtZVxyXG4gICAgICAgIGYuTG9vcC5zdGFydCgpOyAvL1N0YXJkIHRoZSBnYW1lIGxvb3BcclxuICAgIH1cclxuXHJcbiAgICAvL0Z1bmN0aW9uIHRvIGFuaW1hdGUvdXBkYXRlIHRoZSBGdWRnZSBzY2VuZSwgY29tbW9ubHkga25vd24gYXMgZ2FtZWxvb3BcclxuICAgIGZ1bmN0aW9uIHVwZGF0ZSgpOiB2b2lkIHtcclxuICAgICAgICBmLlBoeXNpY3Mud29ybGQuc2ltdWxhdGUoKTsgLy9QSFlTSUNTIC0gU2ltdWxhdGUgcGh5c2ljYWwgY2hhbmdlcyBlYWNoIGZyYW1lLCBwYXJhbWV0ZXIgdG8gc2V0IHRpbWUgYmV0d2VlbiBmcmFtZXNcclxuICAgICAgICBtZWFzdXJlRlBTKCk7XHJcbiAgICAgICAgdmlld1BvcnQuZHJhdygpOyAvLyBEcmF3IHRoZSBjdXJyZW50IEZ1ZGdlIFNjZW5lIHRvIHRoZSBjYW52YXNcclxuICAgIH1cclxuXHJcbiAgICAvLyBGdW5jdGlvbiB0byBxdWlja2x5IGNyZWF0ZSBhIG5vZGUgd2l0aCBtdWx0aXBsZSBuZWVkZWQgRnVkZ2VDb21wb25lbnRzLCBpbmNsdWRpbmcgYSBwaHlzaWNzIGNvbXBvbmVudFxyXG4gICAgZnVuY3Rpb24gY3JlYXRlQ29tcGxldGVOb2RlKF9uYW1lOiBzdHJpbmcsIF9tYXRlcmlhbDogZi5NYXRlcmlhbCwgX21lc2g6IGYuTWVzaCwgX21hc3M6IG51bWJlciwgX3BoeXNpY3NUeXBlOiBmLkJPRFlfVFlQRSwgX2dyb3VwOiBmLkNPTExJU0lPTl9HUk9VUCA9IGYuQ09MTElTSU9OX0dST1VQLkRFRkFVTFQsIF9jb2xUeXBlOiBmLkNPTExJREVSX1RZUEUgPSBmLkNPTExJREVSX1RZUEUuQ1VCRSk6IGYuTm9kZSB7XHJcbiAgICAgICAgLy9TdGFuZGFyZCBGdWRnZSBOb2RlIENyZWF0aW9uXHJcbiAgICAgICAgbGV0IG5vZGU6IGYuTm9kZSA9IG5ldyBmLk5vZGUoX25hbWUpOyAvL0NyZWF0aW5nIHRoZSBub2RlXHJcbiAgICAgICAgbGV0IGNtcE1lc2g6IGYuQ29tcG9uZW50TWVzaCA9IG5ldyBmLkNvbXBvbmVudE1lc2goX21lc2gpOyAvL0NyZWF0aW5nIGEgbWVzaCBmb3IgdGhlIG5vZGVcclxuICAgICAgICBsZXQgY21wTWF0ZXJpYWw6IGYuQ29tcG9uZW50TWF0ZXJpYWwgPSBuZXcgZi5Db21wb25lbnRNYXRlcmlhbChfbWF0ZXJpYWwpOyAvL0NyZWF0aW5nIGEgbWF0ZXJpYWwgZm9yIHRoZSBub2RlXHJcbiAgICAgICAgbGV0IGNtcFRyYW5zZm9ybTogZi5Db21wb25lbnRUcmFuc2Zvcm0gPSBuZXcgZi5Db21wb25lbnRUcmFuc2Zvcm0oKTsgIC8vVHJhbnNmb3JtIGhvbGRpbmcgcG9zaXRpb24vcm90YXRpb24vc2NhbGluZyBvZiB0aGUgbm9kZVxyXG4gICAgICAgIGxldCBjbXBSaWdpZGJvZHk6IGYuQ29tcG9uZW50UmlnaWRib2R5ID0gbmV3IGYuQ29tcG9uZW50UmlnaWRib2R5KF9tYXNzLCBfcGh5c2ljc1R5cGUsIF9jb2xUeXBlLCBfZ3JvdXApOyAvL0FkZGluZyBhIHBoeXNpY2FsIGJvZHkgY29tcG9uZW50IHRvIHVzZSBwaHlzaWNzXHJcblxyXG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcE1lc2gpO1xyXG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcE1hdGVyaWFsKTtcclxuICAgICAgICBub2RlLmFkZENvbXBvbmVudChjbXBUcmFuc2Zvcm0pO1xyXG4gICAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcFJpZ2lkYm9keSk7IC8vIDwtLSBiZXN0IHByYWN0aWNlIHRvIGFkZCBwaHlzaWNzIGNvbXBvbmVudCBsYXN0XHJcbiAgICAgICAgcmV0dXJuIG5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gc3Bhd25DaGFpcigpIHtcclxuICAgICAgICBsZXQgcm5nSGVpZ2h0ID0gKG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBtaW4gPSBNYXRoLmNlaWwobWluKTtcclxuICAgICAgICAgICAgbWF4ID0gTWF0aC5mbG9vcihtYXgpO1xyXG4gICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKSArIG1pbjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IHNwYXduSGVpZ2h0ID0gcm5nSGVpZ2h0KDgsIDIwKTtcclxuICAgICAgICBub0NoYWlycysrO1xyXG5cclxuICAgICAgICAvL0NyZWF0aW5nIGEgY2hhaXIsIGJhc2UgKyBiYWNrICsgNCBsZWdzXHJcbiAgICAgICAgbGV0IGJhc2UgPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJCYXNlXCIsIG5ldyBmLk1hdGVyaWFsKFwiQ3ViZVwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuNzUsIDAuOCwgMC43NSwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5CT0RZX1RZUEUuRFlOQU1JQyk7XHJcbiAgICAgICAgYmFzZS5tdHhMb2NhbC50cmFuc2xhdGUobmV3IGYuVmVjdG9yMygwLCAzLjUgKyBzcGF3bkhlaWdodCwgMCkpO1xyXG4gICAgICAgIGJhc2UubXR4TG9jYWwuc2NhbGUobmV3IGYuVmVjdG9yMygxLCAwLjIsIDEpKTtcclxuICAgICAgICBoaWVyYXJjaHkuYXBwZW5kQ2hpbGQoYmFzZSk7XHJcblxyXG4gICAgICAgIGxldCBiYWNrID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiQmFja1wiLCBuZXcgZi5NYXRlcmlhbChcIkN1YmVcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjc1LCAwLjgsIDAuNzUsIDEpKSksIG5ldyBmLk1lc2hDdWJlKCksIDEsIGYuQk9EWV9UWVBFLkRZTkFNSUMpO1xyXG4gICAgICAgIGJhY2subXR4TG9jYWwudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoMC40LCA0ICsgc3Bhd25IZWlnaHQsIDApKTtcclxuICAgICAgICBiYWNrLm10eExvY2FsLnNjYWxlKG5ldyBmLlZlY3RvcjMoMC4yLCAxLCAxKSk7XHJcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGJhY2spO1xyXG4gICAgICAgIGxldCB3ZWxkaW5nSm9pbnQ6IGYuQ29tcG9uZW50Sm9pbnRXZWxkaW5nID0gbmV3IGYuQ29tcG9uZW50Sm9pbnRXZWxkaW5nKGJhc2UuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KSwgYmFjay5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpKTtcclxuICAgICAgICBiYWNrLmFkZENvbXBvbmVudCh3ZWxkaW5nSm9pbnQpO1xyXG5cclxuICAgICAgICBsZXQgbGVnID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiTGVnX0JMXCIsIG5ldyBmLk1hdGVyaWFsKFwiQ3ViZVwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuNzUsIDAuOCwgMC43NSwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5CT0RZX1RZUEUuRFlOQU1JQywgZi5DT0xMSVNJT05fR1JPVVAuR1JPVVBfMik7XHJcbiAgICAgICAgbGVnLm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDAuNCwgMyArIHNwYXduSGVpZ2h0LCAwLjQpKTtcclxuICAgICAgICBsZWcubXR4TG9jYWwuc2NhbGUobmV3IGYuVmVjdG9yMygwLjIsIDAuOCwgMC4yKSk7XHJcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGxlZyk7XHJcblxyXG4gICAgICAgIHdlbGRpbmdKb2ludCA9IG5ldyBmLkNvbXBvbmVudEpvaW50V2VsZGluZyhiYXNlLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSksIGxlZy5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpKTtcclxuICAgICAgICBiYWNrLmFkZENvbXBvbmVudCh3ZWxkaW5nSm9pbnQpO1xyXG5cclxuICAgICAgICBsZWcgPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJMZWdfQlJcIiwgbmV3IGYuTWF0ZXJpYWwoXCJDdWJlXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC43NSwgMC44LCAwLjc1LCAxKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAxLCBmLkJPRFlfVFlQRS5EWU5BTUlDLCBmLkNPTExJU0lPTl9HUk9VUC5HUk9VUF8yKTtcclxuICAgICAgICBsZWcubXR4TG9jYWwudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoMC40LCAzICsgc3Bhd25IZWlnaHQsIC0wLjQpKTtcclxuICAgICAgICBsZWcubXR4TG9jYWwuc2NhbGUobmV3IGYuVmVjdG9yMygwLjIsIDAuOCwgMC4yKSk7XHJcbiAgICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGxlZyk7XHJcblxyXG4gICAgICAgIHdlbGRpbmdKb2ludCA9IG5ldyBmLkNvbXBvbmVudEpvaW50V2VsZGluZyhiYXNlLmdldENvbXBvbmVudChmLkNvbXBvbmVudFJpZ2lkYm9keSksIGxlZy5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpKTtcclxuICAgICAgICBiYWNrLmFkZENvbXBvbmVudCh3ZWxkaW5nSm9pbnQpO1xyXG5cclxuICAgICAgICBsZWcgPSBjcmVhdGVDb21wbGV0ZU5vZGUoXCJMZWdfRlJcIiwgbmV3IGYuTWF0ZXJpYWwoXCJDdWJlXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMC43NSwgMC44LCAwLjc1LCAxKSkpLCBuZXcgZi5NZXNoQ3ViZSgpLCAxLCBmLkJPRFlfVFlQRS5EWU5BTUlDLCBmLkNPTExJU0lPTl9HUk9VUC5HUk9VUF8yKTtcclxuICAgICAgICBsZWcubXR4TG9jYWwudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoLTAuNCwgMyArIHNwYXduSGVpZ2h0LCAtMC40KSk7XHJcbiAgICAgICAgbGVnLm10eExvY2FsLnNjYWxlKG5ldyBmLlZlY3RvcjMoMC4yLCAwLjgsIDAuMikpO1xyXG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChsZWcpO1xyXG5cclxuICAgICAgICB3ZWxkaW5nSm9pbnQgPSBuZXcgZi5Db21wb25lbnRKb2ludFdlbGRpbmcoYmFzZS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLCBsZWcuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KSk7XHJcbiAgICAgICAgYmFjay5hZGRDb21wb25lbnQod2VsZGluZ0pvaW50KTtcclxuXHJcbiAgICAgICAgbGVnID0gY3JlYXRlQ29tcGxldGVOb2RlKFwiTGVnX0ZSXCIsIG5ldyBmLk1hdGVyaWFsKFwiQ3ViZVwiLCBmLlNoYWRlckZsYXQsIG5ldyBmLkNvYXRDb2xvcmVkKG5ldyBmLkNvbG9yKDAuNzUsIDAuOCwgMC43NSwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSwgMSwgZi5CT0RZX1RZUEUuRFlOQU1JQywgZi5DT0xMSVNJT05fR1JPVVAuR1JPVVBfMik7XHJcbiAgICAgICAgbGVnLm10eExvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKC0wLjQsIDMgKyBzcGF3bkhlaWdodCwgMC40KSk7XHJcbiAgICAgICAgbGVnLm10eExvY2FsLnNjYWxlKG5ldyBmLlZlY3RvcjMoMC4yLCAwLjgsIDAuMikpO1xyXG4gICAgICAgIGhpZXJhcmNoeS5hcHBlbmRDaGlsZChsZWcpO1xyXG5cclxuICAgICAgICB3ZWxkaW5nSm9pbnQgPSBuZXcgZi5Db21wb25lbnRKb2ludFdlbGRpbmcoYmFzZS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRSaWdpZGJvZHkpLCBsZWcuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50UmlnaWRib2R5KSk7XHJcbiAgICAgICAgYmFjay5hZGRDb21wb25lbnQod2VsZGluZ0pvaW50KTtcclxuICAgICAgICBmLlBoeXNpY3MuYWRqdXN0VHJhbnNmb3JtcyhoaWVyYXJjaHkpOyAvLyBJbXBvcnRhbnQhIFlvdSBuZWVkIHRvIGF0IGxlYXN0IGFkanVzdCBUcmFuc2Zvcm1zIGZvciB0aGUgcGFydHMgb2YgdGhlIGNoYWlyXHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gbWVhc3VyZUZQUygpOiB2b2lkIHtcclxuICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgbm93OiBudW1iZXIgPSBwZXJmb3JtYW5jZS5ub3coKTtcclxuICAgICAgICAgICAgd2hpbGUgKHRpbWVzLmxlbmd0aCA+IDAgJiYgdGltZXNbMF0gPD0gbm93IC0gMTAwMCkge1xyXG4gICAgICAgICAgICAgICAgdGltZXMuc2hpZnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aW1lcy5wdXNoKG5vdyk7XHJcbiAgICAgICAgICAgIGZwcyA9IHRpbWVzLmxlbmd0aDtcclxuICAgICAgICAgICAgZnBzRGlzcGxheS50ZXh0Q29udGVudCA9IGBGUFM6ICR7ZnBzLnRvU3RyaW5nKCl9IC8gQ2hhaXJzOiAke25vQ2hhaXJzfSAvIEJvZGllczogJHtmLlBoeXNpY3Mud29ybGQuZ2V0Qm9keUxpc3QoKS5sZW5ndGh9YFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbn0iXX0=